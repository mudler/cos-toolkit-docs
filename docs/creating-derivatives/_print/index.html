<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><link rel=canonical type=text/html href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/creating-derivatives/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon.ico><link rel=apple-touch-icon href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-192x192.png sizes=192x192><title>Creating derivatives | cOS toolkit</title><meta name=description content="cOS toolkit documentation website"><meta property="og:title" content="Creating derivatives"><meta property="og:description" content="Documents various methods for creating cOS derivatives
"><meta property="og:type" content="website"><meta property="og:url" content="https://rancher-sandbox.github.io/cos-toolkit-docs/docs/creating-derivatives/"><meta property="og:site_name" content="cOS toolkit"><meta itemprop=name content="Creating derivatives"><meta itemprop=description content="Documents various methods for creating cOS derivatives
"><meta name=twitter:card content="summary"><meta name=twitter:title content="Creating derivatives"><meta name=twitter:description content="Documents various methods for creating cOS derivatives
"><link rel=preload href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.537bc3207b689effa225ff104581c8648ba581a39ce798b76e4243c03ec2692c.css as=style><link href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.537bc3207b689effa225ff104581c8648ba581a39ce798b76e4243c03ec2692c.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script><link rel=stylesheet href=https://rancher-sandbox.github.io/cos-toolkit-docs/css/prism.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=https://rancher-sandbox.github.io/cos-toolkit-docs/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/rancher-sandbox/cOS-toolkit/releases target=_blank><i class="fab fa-github"></i><span>Github releases</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/ target=_blank><i class="fa fa-toolbox"></i><span>Browse packages</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=https://rancher-sandbox.github.io/cos-toolkit-docs/offline-search-index.f8937dfb49ae3b03737c9ce968d62921.json data-offline-search-base-href=https://rancher-sandbox.github.io/cos-toolkit-docs/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/creating-derivatives/>Return to the regular view of this page</a>.</p></div><h1 class=title>Creating derivatives</h1><div class=lead>Documents various methods for creating cOS derivatives</div><ul><li>1: <a href=#pg-392e7921a89bd32cc9ec22ec800e2673>Package stack</a></li><li>2: <a href=#pg-f3e73df96cf589806ce76f765a5f51cf>Cosign</a></li><li>3: <a href=#pg-c76daa64bd1164d9a6d538211f0fa16b>Creating bootable images</a></li><li>4: <a href=#pg-1c4b24f482e46235525d199eb0414f03>Build ISOs</a></li><li>5: <a href=#pg-a79e4c2576797b293b9be51f953489dd>Building images with Packer</a></li><ul><li>5.1: <a href=#pg-3919e113335b9645a5bc90d158baa902>Build AMI machines for AWS</a></li><li>5.2: <a href=#pg-a82f6f67abbcb7970be348f1f92320a3>Build Azure images</a></li><li>5.3: <a href=#pg-053d994238218800fd0349937370b515>Build Images for Google Compute Platform</a></li><li>5.4: <a href=#pg-d123bd2dce21a42b3c3ca4afc4f353ad>Build QCOW, VirtualBox and Vagrant images</a></li></ul></ul><div class=content><p>A derivative is a standard container image which can be booted by cOS.</p><p>We can identify a build phase where we build the derivative, and a &ldquo;runtime phase&rdquo; where we consume it.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vTTOJ0G4aMpdfSHv13sgPIIFCTK3SDIlcqmDxfPbGz0AlpNPTz1FTUigr-9co33c6MwXhDcead5nWFw/pub?w=1270&h=717" alt></p><p>The image is described by a Dockerfile, composed of a base OS of choice (e.g. openSUSE, Ubuntu, etc. ) and the cOS toolkit itself in order to be consumed by cOS and allow to be upgraded from by other derivatives.</p><p>cOS-toolkit then converts the OCI artifact into a bootable medium (ISO, packer, ova, etc) and the image itself then can be used to bootstrap other derivatives, which can in turn upgrade to any derivative built with cOS.</p><p>A derivative can also be later re-used again as input as base-image for downstream derivatives.</p><p>All the documentation below imply that the container image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image which are general across all the implementation:</p><ul><li>Custom persistent runtime configuration has to be provided in <code>/system/oem</code> for derivatives, <a href=../customizing/configuration_persistency>see also the documentation section</a>. Everything under <code>/system/oem</code> will be loaded during the various stages (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB, <a href=../customizing/configure_grub>see grub customization</a></li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image, <a href=../customizing/upgrades>see customizing upgrades</a></li></ul><p>Derivatives inherits <code>cOS</code> defaults, which you can override during the build process, however there are some defaults which are relevant and listed below:</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-392e7921a89bd32cc9ec22ec800e2673>1 - Package stack</h1><div class=lead>Package stack for derivatives</div><p>When building a <code>cos-toolkit</code> derivative, a common set of packages are provided already with a common default configuration. Some of the most notably are:</p><ul><li>systemd as init system</li><li>grub for boot loader</li><li>dracut for initramfs</li></ul><p>Each <code>cos-toolkit</code> flavor (opensuse, ubuntu, fedora) ships their own set of base packages depending on the distribution they are based against. You can find the list of packages in the <code>packages</code> keyword in the corresponding <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>values file for each flavor</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3e73df96cf589806ce76f765a5f51cf>2 - Cosign</h1><div class=lead>How we use cosign in cos-toolkit</div><p><a href=https://github.com/sigstore/cosign>Cosign</a> is a project that signs and verifies containers and stores the signatures on OCI registries.</p><p>You can check the cosign <a href=https://github.com/sigstore/cosign>github repo</a> for more information.</p><p>In cos-toolkit we sign every container that we generate as part of our publish process so the signature can be verified during package installation with luet or during deploy/upgrades from a deployed system to verify that the containers have not been altered in any way since their build.</p><p>Currently cosign provides 2 methods for signing and verifying.</p><ul><li>private/public key</li><li>keyless</li></ul><p>We use keyless signatures based on OIDC Identity tokens provided by github, so nobody has access to any private keys and can use them. (For more info about keyless signing/verification check <a href=https://github.com/sigstore/cosign/blob/main/KEYLESS.md>here</a>)</p><p>This signature generation is provided by <a href=https://github.com/rancher-sandbox/luet-cosign>luet-cosign</a> which is a luet plugin that generates the signatures on image push when building, and verifies them on package unpack when installing/upgrading/deploying.</p><p>The process is completely transparent to the end user when upgrading/deploying a running system and using our published artifacts.</p><p>When using luet-cosign as part of <code>luet install</code> you need to set <code>COSIGN_REPOSITORY=raccos/releases-green</code> and <code>COSIGN_EXPERIMENTAL=1</code> so it can find the proper signatures and use keyless verification</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Currently setting <code>COSIGN_REPOSITORY</code> value is due to quay.io not supporting OCI artifacts. It may be removed in the future and signatures stored along the artifacts.</div><h2 id=derivatives>Derivatives</h2><p>If building a derivative, you can also sign and verify you final artifacts with the use of <a href=https://github.com/rancher-sandbox/luet-cosign>luet-cosign</a>.</p><p>As keyless is only possible to do in an CI environment (as it needs an OIDC token) you would need to set up private/public signature and verification.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>If you are building and publishing your derivatives with luet on github, you can see an example on how we generate and push the keyless signatures ourselves on <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/.github/workflows/build-master-green-x86_64.yaml#L445>this workflow</a></div><h3 id=verify-cos-toolkit-artifacts-as-part-of-derivative-building>Verify cos-toolkit artifacts as part of derivative building</h3><p>If you consume cos-toolkit artifacts in your Dockerfile as part of building a derivative you can verify the signatures of the artifacts by setting:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_REPOSITORY</span><span style=color:#ce5c00;font-weight:700>=</span>raccos/releases-green<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_EXPERIMENTAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#204a87;font-weight:700>RUN</span> luet install -y meta/cos-verify <span style=color:#8f5902;font-style:italic># install dependencies for signature checking</span><span style=color:#a40000>
</span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>The</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-verify</a>
is a meta package that will pull</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
.</p></div><p>And then making sure you call luet with <code>--plugin luet-cosign</code>. You can see an example of this in our <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples/standard>standard Dockerfile example</a></p><p>That would verify the artifacts coming from our repository.</p><p>For signing resulting containers with a private/public key, please refer to the <a href=https://github.com/sigstore/cosign>cosign</a> documents.</p><p>For verifying with a private/public key, the only thing you need is to set the env var <code>COSIGN_PUBLIC_KEY_LOCATION</code> to point to the public key that signed and enable the luet-cosign plugin.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>Currently there is an issue in which if there is more than one repo and one of those repos is not signed the whole install will fail due to cosign failing to verify the unsigned repo.</p><p>If you are using luet with one or more unsigned repos, it&rsquo;s not possible to use cosign to verify the chain.</p><p>Please follow up in <a href=https://github.com/rancher-sandbox/luet-cosign/issues/6>https://github.com/rancher-sandbox/luet-cosign/issues/6</a> for more info.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c76daa64bd1164d9a6d538211f0fa16b>3 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSmIZ5FTInGjtkGonUOgwhti6DZnSoeexGmWL9CAmbdiIGtBGnzDuGNj80Lj_206hP0MOxQGpEdYFvK/pub?w=1223&h=691" alt></p><p>A derivative is a simple container image which can be processed by the cOS toolkit in order to be bootable and installable. This section describes the requirements to create a container image that can be run by <code>cOS</code>.</p><h2 id=requirements>Requirements</h2><img style=float:right src="https://docs.google.com/drawings/d/e/2PACX-1vQBfT10W88mD1bbReDmAJIOPF3tWdVHP7QE9w7W7ByOIzoKGOdh2z5YWsKf7wn8csFF_QGrDXgGsPWg/pub?w=478&h=178"><p>Bootable images are standard container images, that means the usual <code>build</code> and <code>push</code> workflow applies, and building images is also a way to persist <a href=../../customizing>oem customizations</a>.</p><p>The base image can be any Linux distribution that is compatible with our flavors.</p><p>The image needs to ship:</p><ul><li>parts of the cos-toolkit (required, see below)</li><li>kernel (required)</li><li>initrd (required)</li><li>grub (required)</li><li>dracut (optional, kernel and initrd can be consumed from the cOS repositories)</li><li>microcode (optional, not required in order to boot, but recomended)</li><li><a href=../cosign>cosign and luet-cosign</a> packages (optional, required if you want to verify the images installed by luet)</li></ul><h2 id=example>Example</h2><p>An illustrative example can be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.16.7<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3 # or Fedora, Ubuntu</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>amd64
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>ARCH</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_EXPERIMENTAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#8f5902;font-style:italic># keyless verify</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_REPOSITORY</span><span style=color:#ce5c00;font-weight:700>=</span>raccos/releases-green  <span style=color:#8f5902;font-style:italic># repo with the signatures</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y ... <span style=color:#8f5902;font-style:italic># apt-get, dnf...</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Here we install cosign and luet-cosign so we can verify that the images installed have been signed</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install -y meta/cos-verify<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># That&#39;s where we install the minimal cos-toolkit meta-package (which pulls the minimal packages needed in order to boot)</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># note that we are setting `--plugin luet-cosign` so luet verifies the correct signatures of the packages on install</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install --plugin luet-cosign -y meta/cos-minimal<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Other custom logic. E.g, customize statically the upgrade channel, default users, packages.</span><span style=color:#a40000>
</span><span style=color:#a40000></span>...<span style=color:#a40000>
</span></code></pre></div><p>In the example above, the cos-toolkit parts that are <strong>required</strong> are pulled in by <code>RUN luet install -y meta/cos-minimal</code>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-minimal class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-minimal</a>
is a meta-package that will pull
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/yip class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/yip</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/utils/installer class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> utils/installer</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-setup class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cos-setup</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/immutable-rootfs class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/immutable-rootfs</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/base-dracut-modules class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/base-dracut-modules</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/grub2-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/grub2-config</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
is optional, but provides <code>cOS</code> defaults setting, like default user/password and so on. If you are not installing it directly, an equivalent cloud-config has to be provided in order to properly boot and run a system, see <a href=../../customizing/oem_configuration>oem configuration</a>.</div><h4 id=using-cosign-in-your-derivative>Using cosign in your derivative</h4><p>The
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-verify</a>
is a meta package that will pull
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
are optional packages that would install cosign and luet-cosign in order to verify the packages installed by luet.</p><p>You can use cosign to both verify that packages coming from cos-toolkit are verified and sign your own derivative artifacts</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>If you want to manually verify cosign and luet-cosign packages before installing them with luet, you can do so by:</p><ul><li>Install <a href=https://github.com/sigstore/cosign>Cosign</a></li><li>Export the proper vars<ul><li><code>export COSIGN_EXPERIMENTAL=1</code> for keyless verify</li><li><code>export COSIGN_REPOSITORY=raccos/releases-green</code> to point cosign to the repo the signatures are stored on</li></ul></li><li>Manually verify the signatures on both packages<ul><li>Check the latest $VERSION for both packages at the repo (i.e. <code>https://quay.io/repository/costoolkit/releases-green?tab=tags</code>)</li><li><code>cosign verify quay.io/costoolkit/releases-green:luet-cosign-toolchain-$VERSION</code></li><li><code>cosign verify quay.io/costoolkit/releases-green:cosign-toolchain-$VERSION</code></li></ul></li></ul></div><p>For more info, check the <a href=../cosign>cosign</a> page.</p><h2 id=initrd>Initrd</h2><p>The image should provide at least <code>grub</code>, <code>systemd</code>, <code>dracut</code>, a kernel and an initrd. Those are the common set of packages between derivatives. See also <a href=../package_stack>package stack</a>.
By default the initrd is expected to be symlinked to <code>/boot/initrd</code> and the kernel to <code>/boot/vmlinuz</code>, otherwise you can specify a custom path while <a href=../build_iso>building an iso</a> and <a href=../../customizing/configure_grub>by customizing grub</a>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/base-dracut-modules class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/base-dracut-modules</a>
is required to be installed with <code>luet</code> in case you are building manually the initrd from the Dockerfile and also to run <code>dracut</code> to build the initrd, the command might vary depending on the base distro which was chosen.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/kernel class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/kernel</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/dracut-initrd class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/dracut-initrd</a>
can also be installed if you plan to use kernels and initrd from the <code>cOS</code> repositories and don&rsquo;t build them / or install them from the official distro repositories (e.g. with <code>zypper</code>, or <code>dnf</code> or either <code>apt-get</code>&mldr;). In this case you don&rsquo;t need to generate initrd on your own, neither install the kernel coming from the base image.</p><h2 id=building>Building</h2><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vS6eRyjnjdQI7OBO0laYD6vJ2rftosmh5eAog6vk_BVj8QYGGvnZoB0K8C6Qdu7SDz7p2VTxejcZsF6/pub?w=956&h=339" alt></p><p>The workflow would be then:</p><ol><li><code>docker build</code> the image</li><li><code>docker push</code> the image to some registry</li><li><code>cos-upgrade --docker-image --no-verify $IMAGE</code> from a cOS machine ( or <code>cos-deploy</code> if bootstrapping a cloud image )</li></ol><p>The following can be incorporated in any standard gitops workflow.</p><p>You can explore more examples in the <a href=../../examples/creating_bootable_images>example section</a> on how to create bootable images.</p><h2 id=whats-next>What&rsquo;s next?</h2><p>Now that we have created our derivative container, we can either:</p><ul><li><a href=../build_iso>Build an iso</a></li><li><a href=../packer/build_ami>Build an Amazon Image</a></li><li><a href=../packer/build_gcp>Build a Google Cloud Image</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1c4b24f482e46235525d199eb0414f03>4 - Build ISOs</h1><div class=lead>Build ISOs from bootable images</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vReZtyNs0imrji-AwnqK0-4ekCKLcKzfnQ_CwiMj93Q7IsycAJHwlNohwCv_hyHnaify7qO-v2Cecg5/pub?w=1223&h=691" alt></p><p>In order to build an iso at the moment of writing, we first rely on <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a>. It accepts a YAML file denoting the packages to bundle in an ISO and a list of luet repositories where to download the packages from.</p><p>To build an iso, just run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -v <span style=color:#000>$PWD</span>:/cOS -v /var/run:/var/run --entrypoint /usr/bin/luet-makeiso -ti --rm quay.io/costoolkit/toolchain ./iso.yaml --image <span style=color:#000>$IMAGE</span>
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--image $IMAGE</code> is the container image you want to build the ISO for, you might want to check on <a href=../creating_bootable_images>how to build bootable images</a>.</p><p>An example of a yaml file using the cos-toolkit opensuse repositories and syslinux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;c3os-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>files-iso</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/mudler/c3os/blob/master/iso.yaml>https://github.com/mudler/c3os/blob/master/iso.yaml</a></i></small><hr><p>An example using GRUB instead:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=whats-next>What&rsquo;s next?</h2><ul><li>Check out on how to <a href=../packer/build_images>build a QCOW, Virtualbox or Vagrant image</a> from the ISO we have just created</li></ul><h2 id=syntax>Syntax</h2><p>Below you can find a full reference about the yaml file format.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># (optional) Packages to be installed in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the uefi image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/systemd-boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the isoimage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/syslinux</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify initramfs/kernel and avoid generation on-the-fly</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># files must be present on /boot folder in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/uefi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/efi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify a container remote image to pull and use for the rootfs in place of packages (optional)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rootfs_image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ubuntu:latest&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Image prefix. If Image date is disabled is used as the full title.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;MYOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Luet repositories (https://luet-lab.github.io/docs/docs/getting-started/#configuration-in-etcluetreposconfd) to use.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Flags:</p><ul><li><strong>local</strong>: Path to local luet repository to use to install packages from</li><li><strong>image</strong>: Optional image to use as rootfs</li></ul><h2 id=configuration-reference>Configuration reference</h2><h3 id=rootfs_image><code>rootfs_image</code></h3><p>A container image reference (e.g. <code>quay.io/.../...:latest</code>) that will be used as a rootfs for the ISO.</p><h3 id=packagesrootfs><code>packages.rootfs</code></h3><p>A list of luet packages to install in the rootfs. The rootfs will be squashed to a <code>rootfs.squashfs</code> file</p><h3 id=packagesuefi><code>packages.uefi</code></h3><p>A list of luet packages to be present in the efi ISO sector.</p><h3 id=packagesisoimage><code>packages.isoimage</code></h3><p>A list of luet packages to be present in the ISO image.</p><h3 id=repositorypackages><code>repository.packages</code></h3><p>A list of package repository (e.g. <code>repository/mocaccino-extra</code>) to be installed before <code>luet install</code> commands Requirements</p><h3 id=initramfskernel_file><code>initramfs.kernel_file</code></h3><p>The kernel file under <code>/boot/</code> that is your running kernel. e.g. <code>vmlinuz</code> or <code>bzImage</code></p><h3 id=initramfsrootfs_file><code>initramfs.rootfs_file</code></h3><p>The initrd file under <code>/boot/</code> that has all the utils for the initramfs</p><h3 id=image_prefix><code>image_prefix</code></h3><p>ISO image prefix to use</p><h3 id=image_date><code>image_date</code></h3><p>Boolean indicating if the output image name has to contain the date</p><h3 id=image_name><code>image_name</code></h3><p>A string representing the ISO final image name</p><h3 id=arch><code>arch</code></h3><p>A string representing the arch. Defaults to <code>x86_64</code>.</p><h3 id=luetconfig><code>luet.config</code></h3><p>Path to the luet config to use to install the packages from</p><h3 id=overlayisoimage><code>overlay.isoimage</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the ISO (before generating the ISO file).</p><h3 id=overlayuefi><code>overlay.uefi</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the UEFI partition (before generating the image).</p><h3 id=overlayrootfs><code>overlay.rootfs</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the rootfs (before generating squashfs).</p><h2 id=customize-bootloader-with-grub>Customize bootloader with GRUB</h2><p>Beside syslinux, the ISO boot menu can also be built with GRUB.</p><p>Boot menu and other bootloader parameters can then be easily customized by using the overlay parameters within the ISO config yaml manifest.</p><p>Assuming the ISO being built includes:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># The following are required in order to build an ISO with GRUB</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># as bootloader</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We can customize either the <code>isoimage</code> packages (in the referrence image <code>live/grub2</code> package
includes bootloader configuration) or make use of the overlay concept to include or
overwrite addition files for <code>isoimage</code> section.</p><p>Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>system/cos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>overlay/iso</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>With the above the ISO will also include the files under <code>overlay/iso</code> path. To customize the boot
menu parameters consider copy and modify relevant files from <code>live/grub2</code> package. In this example the
<code>overlay</code> folder files list could be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># isoimage files for grub2 boot</span>
boot/grub2/grub.cfg
</code></pre></div><p>Being <code>boot/grub2/grub.cfg</code> a custom grub2 configuration including custom boot menu entries. Consider the following <code>grub.cfg</code> example:</p><pre><code>search --file --set=root /boot/kernel.xz
set default=0
set timeout=10
set timeout_style=menu
set linux=linux
set initrd=initrd
if [ &quot;${grub_cpu}&quot; = &quot;x86_64&quot; -o &quot;${grub_cpu}&quot; = &quot;i386&quot; ];then
    if [ &quot;${grub_platform}&quot; = &quot;efi&quot; ]; then
        set linux=linuxefi
        set initrd=initrdefi
    fi
fi

set font=($root)/boot/x86_64/loader/grub2/fonts/unicode.pf2
if [ -f ${font} ];then
    loadfont ${font}
fi

menuentry &quot;Custom grub2 menu entry&quot; --class os --unrestricted {
    echo Loading kernel...
    $linux ($root)/boot/kernel.xz cdroot root=live:CDLABEL=COS_LIVE rd.live.dir=/ rd.live.squashimg=rootfs.squashfs console=tty1 console=ttyS0 rd.cos.disable
    echo Loading initrd...
    $initrd ($root)/boot/rootfs.xz
}
</code></pre><h2 id=separate-recovery>Separate recovery</h2><p>To make an ISO with a separate recovery image as squashfs, you can either use the default from <code>cOS</code>, by adding it in the iso yaml file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The installer will detect the squashfs file in the iso, and will use it when installing the system. You can customize the recovery image as well by providing your own: see the <code>recovery/cos-img</code> package definition as a reference.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a79e4c2576797b293b9be51f953489dd>5 - Building images with Packer</h1><div class=lead>Building VBox, OVA, QEMU, etc. images of your derivative with Packer</div><img style=display:block;margin-left:auto;margin-right:auto;width:50% src="https://docs.google.com/drawings/d/e/2PACX-1vTOn0fYAI589csRoONln7aCttWWNyUc2DvEUt9Dw6tys4nzyearrIUaCXYpg6lknli16z_Kz1N-ugxK/pub?w=507&h=217"><p>For Vagrant Boxes, OVA and QEMU images at the moment we are relying on <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>packer templates</a>.</p><p>The cOS vanilla images can be used as input to Packer to deploy pristine images of the user container image with <a href=../../getting-started/deploy>cos-deploy</a>.</p></div><div class=td-content><h1 id=pg-3919e113335b9645a5bc90d158baa902>5.1 - Build AMI machines for AWS</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in AWS public cloud provider by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>AWS access keys with the appropriate roles and permissions</li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to AWS of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an AMI image in AWS based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the AWS credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an AMI. In such case the lastest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_secret_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_DEFAULT_REGION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_default_region&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only amazon-ebs.cos .
</code></pre></div><p>AWS keys can be passed as environment variables as it is above or packer
picks them from aws-cli configuration files (<code>~/.aws</code>) if any. Alternatively,
one can define them in the variables file.</p><p>The <code>-only amazon-ebs.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;aws_cos_deploy_args&#34;: &#34;cos-deploy&#34;,
</span><span style=color:#4e9a06>    &#34;aws_launch_volume_size&#34;: 16,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only amazon-ebs.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the AMI Vanilla image on a 16GiB disk and calls the
command <code>cos-deploy</code> to deploy the main OS, once deployed an snapshot is
created and an AMI out this snapshot is registered in EC2. The created
AMI artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>aws_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>aws_launch_volume_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>aws_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>aws_source_ami_filter_name</code>: This a filter to choose the AMI image for the
build process. It defaults to <code>*cOS*Vanilla*</code> pattern to pick the latest cOS
Vanilla image available.</p></li><li><p><code>aws_temporary_security_group_source_cidr</code>: A IPv4 CIDR to be authorized access to the instance,
when packer is creating a temporary security group. Defaults to &ldquo;0.0.0.0/0&rdquo;.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a82f6f67abbcb7970be348f1f92320a3>5.2 - Build Azure images</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in Azure public cloud provider by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Azure access keys with the appropriate roles and permissions</li><li><a href=../../../getting-started/booting/#importing-an-azure-image-manually>A Vanilla image</a></li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to Azure of cOS derivatives or cOS itself. For all the details
and possibilities of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an image in Azure based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the Azure credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an image. In such case the latest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_CLIENT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_client_id&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_TENANT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_tenant_id&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_CLIENT_SECRET</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_client_secret&gt;
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_SUBSCRIPTION_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_subscription_id&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only azure-arm.cos .
</code></pre></div><p>The <code>-only azure-arm.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired variables. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;azure_location&#34;: &#34;westeurope&#34;,
</span><span style=color:#4e9a06>    &#34;azure_os_disk_size_gb&#34;: 16,
</span><span style=color:#4e9a06>    &#34;azure_vm_size&#34;: &#34;Standard_B2s&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only azure-arm.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the Vanilla image on a 16GiB disk and calls the
command <code>cos-deploy</code> to deploy the main OS and once deployed an image
is created from the running instance.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>azure_</code> prefix are the ones related to the Azure Packer
template. These are some of the relevant ones:</p><ul><li><p><code>azure_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>azure_custom_managed_image_name</code>: Name of a custom managed image to use for your
base image.</p></li><li><p><code>azure_custom_managed_image_resource_group_name</code>: Name of a custom managed image&rsquo;s
resource group to use for your base image.</p></li><li><p><code>azure_os_disk_size_gb</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>azure_vm_size</code>: Sets the size of the instance being launched. Defaults to Standard_B2s</p></li><li><p><code>azure_user_data_file</code>: This sets the user-data file that will be used for the
azure instance during the build process. It defaults to <code>user-data/azure.yaml</code> and
the default file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li></ul><div class="pageinfo pageinfo-primary"><p>The current version of packer (1.7.4) doesn&rsquo;t have any support for user-data so currently is
not possible to automate the deployment with packer correctly.
Have a look at <a href=https://github.com/hashicorp/packer/blob/master/CHANGELOG.md>packer changelog</a> to be informed when
user-data is supported.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-053d994238218800fd0349937370b515>5.3 - Build Images for Google Compute Platform</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in Google Compute Platform by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Google Compute Packer <a href=https://www.packer.io/docs/builders/googlecompute>plugin</a></li><li><a href=https://cloud.google.com/sdk/docs/install>Google Cloud SDK</a></li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to GCP of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><p>There are no cOS Vanilla images publicly available in GCP, however they can be easily
build or downloaded and published to your working GCP project. See <a href=../../../development/build_raw_images/>Build Raw Images</a> and
<a href=../../../getting-started/booting/#importing-a-google-cloud-image-manually>Importing a Google Cloud image manually</a> to see how to upload a Vanilla image in your project.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an image in GCP based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the <a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
for GCP and the GCP project ID and then run a <code>packer build</code> process to
trigger the deployment and register the resulting snapshot as an image.
In such case the lastest cOS image will be deployed and configured with
pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_gcp_project_id&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only gcp.cos .
</code></pre></div><p>Packer authenticates automatically if the
<a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
are properly set in the host.</p><p>The <code>-only gcp.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code>, <code>virtualbox</code> and <code>amazon-ebs</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;gcp_project_id&#34;: &#34;&lt;your_gcp_project&gt;&#34;
</span><span style=color:#4e9a06>    &#34;gcp_cos_deploy_args&#34;: &#34;cos-deploy --docker-image &lt;my-custom-image&gt;&#34;,
</span><span style=color:#4e9a06>    &#34;gcp_disk_size&#34;: 20,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only gcp.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the cOS Vanilla image on a 20GB disk and calls the
command <code>cos-deploy</code> to deploy the main OS, once deployed an snapshot is
created and published as an image in Google Compute Engine. The created
artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>gcp_project_id</code>: The project ID that will be used to launch instances and
store images.</p></li><li><p><code>gcp_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>cos-deploy</code> which will deploy the latest cOS image in cOS repositories.
To deploy custom derivatives something like
<code>cos-deploy --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>gcp_disk_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>gcp_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>gcp_source_image_family</code>: This the family to choose the image for the
build process. It defaults to <code>cos-vanilla</code> to pick the latest cOS
Vanilla image available. Note Packer tries to find the image family first
in the given working project (<code>gcp_project_id</code>).</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d123bd2dce21a42b3c3ca4afc4f353ad>5.4 - Build QCOW, VirtualBox and Vagrant images</h1><div class=lead>This section documents the procedure to build a custom QCOW, VirtualBox and a Vagrant images with the cOS packer templates</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vT-ZugVPCUCffRbfko-tOoTyRIpqjtgvQgQn74lckTZCjMLIakEJKRPwyjFL7tGEmKE8DDMVSZBEZ9u/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Either qemu or VirtualBox functioning in the build host</li><li>a cOS or a <a href=../../build_iso>custom ISO</a></li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a> to customize the
deployment and automate creation of QCOW, Virtualbox and Vagrant images of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>To build QCOW and VirtualBox images an ISO file is required. You can either <a href=../../../getting-started/download>Download</a> a cOS ISO or <a href=../../build_iso>build your own from a container image</a>.</p><h3 id=qcow2>QCOW2</h3><p>Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only qemu.cos .
</code></pre></div><p>The process should end up by building a <code>.box</code> file (vagrant image) and a <code>.tar.gz</code> file (containing the raw disk) in the same folder:</p><pre><code>...
==&gt; qemu.cos (compress): Using pgzip compression with 8 cores for cOS_green_dev_amd64.tar.gz
==&gt; qemu.cos (compress): Tarring cOS_green_dev_amd64.tar.gz with pgzip
==&gt; qemu.cos (compress): Archive cOS_green_dev_amd64.tar.gz completed
Build 'qemu.cos' finished after 4 minutes 34 seconds.

==&gt; Wait completed after 4 minutes 34 seconds

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; qemu.cos: 'libvirt' provider box: cOS_green_dev_amd64.box
--&gt; qemu.cos: compressed artifacts in: cOS_green_dev_amd64.tar.gz

&gt; ubuntu@jumpbox:~/cOS-toolkit/packer$ ls -liah
total 2.3G
 516552 drwxrwxr-x  4 ubuntu ubuntu 4.0K Jul 30 07:54 .
 516207 drwxrwxr-x 14 ubuntu ubuntu 4.0K Jul 30 07:41 ..
 516362 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.box
 516385 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.tar.gz
 516553 -rw-rw-r--  1 ubuntu ubuntu  389 Jun 28 08:07 config.yaml
 516339 -rw-rw-r--  1 ubuntu ubuntu 6.5K Jul 30 07:41 images.json.pkr.hcl
1818463 drwxrwxr-x  3 ubuntu ubuntu 4.0K Jul 30 07:49 packer_cache
1818400 drwxrwxr-x  2 ubuntu ubuntu 4.0K Jul 30 07:41 user-data
 516555 -rw-rw-r--  1 ubuntu ubuntu  606 Jun 28 08:07 vagrant.yaml
 516340 -rw-rw-r--  1 ubuntu ubuntu 6.1K Jul 30 07:41 variables.pkr.hcl
ubuntu@jumpbox:~/cOS-toolkit/packer$ 
</code></pre><p>The <code>-only qemu.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>amazon-ebs</code> and <code>virtualbox-iso</code>.</p><h3 id=virtualbox>Virtualbox</h3><p>Similarly, to build OVA images we run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h3 id=vagrant>Vagrant</h3><p>To build vagrant images, we enable the <code>vagrant</code> feature, which allows the <code>vagrant</code> user to login afterwards:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var <span style=color:#4e9a06>&#34;feature=vagrant&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;root_username&#34;: &#34;root&#34;,
</span><span style=color:#4e9a06>    &#34;root_password&#34;: &#34;cos&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only qemu.cos -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the build by logging with a different username/password to run the installation.</p><h3 id=default-cloud-init>Default cloud-init</h3><p>In the packer folder there is present a <code>config.yaml</code> file which can be used to customize the image. The file is in <a href=../../../references/cloud-init>cloud-init</a> style and will be automatically installed by default when running <code>cos-install</code>.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
these are some of the relevant ones:</p><ul><li><p><code>build</code>,<code>flavor</code>,<code>arch</code>: This to personalize the artifact output name. The artifact output format is
<code>"cOS_${var.flavor}_${var.build}_${var.arch}.tar.gz"</code></p></li><li><p><code>disk_size</code>: This sets the disk size to be used for the image. It is 50000 by default, and expressed in MB.</p></li><li><p><code>memory</code>: RAM to allocate to the VM in MB.</p></li><li><p><code>cpu</code>: Number of processors of the VM</p></li><li><p><code>accelerator</code>: Accelerator type, see the <a href=https://www.packer.io/docs/builders/qemu#accelerator>official docs</a></p></li><li><p><code>root_username</code>: Username used to login via ssh, it needs root permissions to be able to run the installation process and call <code>cos-install</code></p></li><li><p><code>root_password</code>: Password for the user specified in <code>root_username</code></p></li><li><p><code>feature</code>: Enable/Disables specific <code>cOS</code> features.</p></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://rancher-users.slack.com/messages/cos-toolkit aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 SUSE LLC All Rights Reserved</small>
<small class=ml-1><a href=https://www.suse.com/company/legal/ target=_blank rel=noopener>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/prism.js></script></body></html>