<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.82.0"><link rel=canonical type=text/html href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon.ico><link rel=apple-touch-icon href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=https://rancher-sandbox.github.io/cos-toolkit-docs/favicons/android-192x192.png sizes=192x192><title>Documentation | cOS toolkit</title><meta name=description content="cOS toolkit documentation website"><meta property="og:title" content="Documentation"><meta property="og:description" content="cOS toolkit documentation website"><meta property="og:type" content="website"><meta property="og:url" content="https://rancher-sandbox.github.io/cos-toolkit-docs/docs/"><meta property="og:site_name" content="cOS toolkit"><meta itemprop=name content="Documentation"><meta itemprop=description content="cOS toolkit documentation website"><meta name=twitter:card content="summary"><meta name=twitter:title content="Documentation"><meta name=twitter:description content="cOS toolkit documentation website"><link rel=preload href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.537bc3207b689effa225ff104581c8648ba581a39ce798b76e4243c03ec2692c.css as=style><link href=https://rancher-sandbox.github.io/cos-toolkit-docs/scss/main.min.537bc3207b689effa225ff104581c8648ba581a39ce798b76e4243c03ec2692c.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script><link rel=stylesheet href=https://rancher-sandbox.github.io/cos-toolkit-docs/css/prism.css></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=https://rancher-sandbox.github.io/cos-toolkit-docs/><span class=navbar-logo><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">cOS toolkit</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/><span class=active>Documentation</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/rancher-sandbox/cOS-toolkit/releases target=_blank><i class="fab fa-github"></i><span>Github releases</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/ target=_blank><i class="fa fa-toolbox"></i><span>Browse packages</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; Search this site…" aria-label="Search this site…" autocomplete=off data-offline-search-index-json-src=https://rancher-sandbox.github.io/cos-toolkit-docs/offline-search-index.ea6f8743aedc2e11c0486b86ab360bd7.json data-offline-search-base-href=https://rancher-sandbox.github.io/cos-toolkit-docs/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>This the multi-page printable view of this section.
<a href=# onclick="return print(),!1">Click here to print</a>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-docs/docs/>Return to the regular view of this page</a>.</p></div><h1 class=title>Documentation</h1><ul><li>1: <a href=#pg-93aadc1aba179e6928539400a09b9e4e>Getting Started</a></li><ul><li>1.1: <a href=#pg-6d9b743260710738d7e98b374307931e>Download</a></li><li>1.2: <a href=#pg-f085d0d6d0675180d3331caca3265de5>Installing</a></li><li>1.3: <a href=#pg-20ed69725da67a67450fffe152e9dc9f>Booting</a></li><li>1.4: <a href=#pg-b8ae70d603defa5e6fa86ed3ac457356>Upgrading</a></li><li>1.5: <a href=#pg-116792d44b4b0a19cbac9a2d12b83ee4>Recovery</a></li><li>1.6: <a href=#pg-4f3d9f9b1fc979ace402c3f90122722d>Deploying</a></li></ul><li>2: <a href=#pg-4f8fa1d779276bb728601b46845a8df5>Customizing</a></li><ul><li>2.1: <a href=#pg-8637cd7f2ce65f4c97959f4d2a723eb9>Stages</a></li><li>2.2: <a href=#pg-80272a2426a531df16f16d019ccd6724>Configuration persistency</a></li><li>2.3: <a href=#pg-0f49c1b2fa940427a27c2c93a1d67077>Runtime persistent changes</a></li><li>2.4: <a href=#pg-aab355bcbb96f01ee8dabb0f90e6df5a>General Configuration</a></li><li>2.5: <a href=#pg-4c6f31346340371adbb7fd2ceccc2e88>Login</a></li><li>2.6: <a href=#pg-72eef8ed52ca1d1dab6e21a58816bac9>OEM configuration</a></li><li>2.7: <a href=#pg-891dfa0a6f57b2aababf7ee877e38876>Upgrades</a></li><li>2.8: <a href=#pg-da6b91d86be15305a06525d5ddec51fc>GRUB</a></li><li>2.9: <a href=#pg-3255a8332bd6efb004f0d49c42343f6d>Runtime features</a></li></ul><li>3: <a href=#pg-5a2f2ae34ebe6581185222d4c362a1d2>Creating derivatives</a></li><ul><li>3.1: <a href=#pg-392e7921a89bd32cc9ec22ec800e2673>Package stack</a></li><li>3.2: <a href=#pg-f3e73df96cf589806ce76f765a5f51cf>Cosign</a></li><li>3.3: <a href=#pg-c76daa64bd1164d9a6d538211f0fa16b>Creating bootable images</a></li><li>3.4: <a href=#pg-77bbb84e7a296f8ceb76bccd0b101c63>Build disk images with Elemental</a></li><li>3.5: <a href=#pg-1c4b24f482e46235525d199eb0414f03>Build ISOs</a></li><li>3.6: <a href=#pg-a79e4c2576797b293b9be51f953489dd>Building images with Packer</a></li><ul><li>3.6.1: <a href=#pg-3919e113335b9645a5bc90d158baa902>Build AMI machines for AWS</a></li><li>3.6.2: <a href=#pg-a82f6f67abbcb7970be348f1f92320a3>Build Azure images</a></li><li>3.6.3: <a href=#pg-053d994238218800fd0349937370b515>Build Images for Google Compute Platform</a></li><li>3.6.4: <a href=#pg-d123bd2dce21a42b3c3ca4afc4f353ad>Build QCOW, VirtualBox and Vagrant images</a></li></ul></ul><li>4: <a href=#pg-fb0f854c53f1ba28ad4c2ccf8d24df34>Examples</a></li><ul><li>4.1: <a href=#pg-69286228d8129cf393e95a7cae077086>Creating bootable images</a></li><li>4.2: <a href=#pg-87fa66e8f5fb02335e3eb5b85600fc0f>Creating embedded images</a></li></ul><li>5: <a href=#pg-8dbd4e302cd86a4d0f71f71ce3b300de>Tutorials</a></li><ul><li>5.1: <a href=#pg-d57b80651f0651da95da0184bb71b5ba>K3s + Fleet</a></li><li>5.2: <a href=#pg-7f6aed5f776c4254888a6bcd3e601087>Trigger upgrades with K3s and Fleet</a></li></ul><li>6: <a href=#pg-8df6ea6904416b571ff9bc73afb50933>Reference</a></li><ul><li>6.1: <a href=#pg-533eb9e0a241df35bd13c7d531fc6bd3>Cloud-init support</a></li><li>6.2: <a href=#pg-64a39672b943eab91a6153baf2fc487f>SELinux</a></li><li>6.3: <a href=#pg-bd2c7a111cdf07391221b169f69faaa1>Known issues</a></li><li>6.4: <a href=#pg-64cdd9f4dae5e1e36b28a390789e7b34>Runtime layout</a></li><li>6.5: <a href=#pg-cf896bdd96bc95a1c5079a49e2dd0b00>Immutable Root Filesystem</a></li><li>6.6: <a href=#pg-071ba6d3efabf269c535d8df6613a33c>Package reference documentation</a></li><ul><li>6.6.1: <a href=#pg-f88126e2014aaca7f42ad5e31b8a017a>GRUB</a></li><ul></ul><li>6.6.2: <a href=#pg-38a488e2fb8d5af933f04fa04ae06c0f>Meta packages</a></li><ul><li>6.6.2.1: <a href=#pg-2ee14c4414706eb4e3550293ae147e56>meta/cos-core</a></li><li>6.6.2.2: <a href=#pg-20f0dfa30c6acbc13f3bda70a14963b6>meta/cos-minimal</a></li><li>6.6.2.3: <a href=#pg-936dc212b34efd945dfb5c1c8055923d>meta/cos-modules</a></li><li>6.6.2.4: <a href=#pg-cd398c4a96ce6315b3ed8413b9677a10>meta/cos-verify</a></li><li>6.6.2.5: <a href=#pg-2d0403630e1a722c86e82297c9ab7b8b>meta/toolchain</a></li></ul><li>6.6.3: <a href=#pg-814d9b5826621eca5843f5b6b91b4244>system/cos-wrapper</a></li><li>6.6.4: <a href=#pg-0e1e2a51c8326695b76478a4bbcb1f0f>system/dracut-initrd</a></li><li>6.6.5: <a href=#pg-b1dbc1c48316ba68af1f8b953282ae48>system/immutable-rootfs</a></li><li>6.6.6: <a href=#pg-963179f6f5bbd1cd10ee6ac9f8a021f8>utils/installer</a></li><li>6.6.7: <a href=#pg-b776ece418034168ac1443ec311f82df>system/kernel</a></li></ul><li>6.7: <a href=#pg-96caa056902ceb82a4f9a52e36852e8c>Troubleshooting</a></li><li>6.8: <a href=#pg-52dc75d922e47809f6e4b3a9ac43e7a8>High level architecture</a></li></ul><li>7: <a href=#pg-39f3813de34ce5cae320697c88e2a917>Development</a></li><ul><li>7.1: <a href=#pg-be969bc49196171414c640b6e5d07e36>Creating derivatives</a></li><li>7.2: <a href=#pg-8a9a15a61c107bad2b137d10597cb9e8>Build Raw images</a></li><li>7.3: <a href=#pg-b891fcefc8f5da3d313248bffe32998d>Build requirements</a></li></ul></ul><div class=content><h2 id=what-is-cos>What is cOS?</h2><p>cOS is a toolkit which allows container images to be bootable in VMs, baremetals, embedded devices, and much more.</p><p>cOS allows to create meta-Linux derivatives which are configured throughout cloud-init configuration files and are immutable by default.</p><p>cOS and derivatives shares a common feature set, can be upgraded in a <strong>OTA-alike</strong>* style, and upgrades are delivered with standard container registries.</p><p>cOS comes also with vanilla images that can be used to boot directly container images built with the toolkit.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Note here we refer to &ldquo;OTA-alike&rdquo; merely as a method of distributing upgrades. It does not involve any specific setup (either wireless or cabled works) except an network connection to the registry where images are stored. Updates are delivered from one central location (the container registry) which hosts all images available for the clients to pull from.</div><h2 id=why-cos>Why cOS?</h2><p>cOS allows to create custom OS versions in your cluster with standard container images with a high degree of customization. It can also be used in its vanilla form - cOS enables then everyone to build their own derivative and access it in various formats.</p><p>To build a bootable image is as simple as running <code>docker build</code>.</p><ul><li><strong>What is it good for?</strong>: Embedded, Cloud, Containers, VM, Baremetals, Servers, IoT, Edge</li></ul><h2 id=design-goals>Design goals</h2><ul><li>A Manifest for container-based OS. It contains just the common bits to make a container image bootable and to be upgraded from, with few customization on top</li><li>Everything is an OCI artifact from the ground-up</li><li>Immutable-first, but with a flexible layout</li><li>Cloud-init driven</li><li>Based on systemd</li><li>Built and upgraded from containers - It is a <a href=https://quay.io/repository/costoolkit/releases-green>single image OS</a>!</li><li>OTA updates</li><li>Easy to customize</li><li>Cryptographically verified</li><li>instant switch from different versions</li><li>recovery mechanism with <code>cOS</code> vanilla images (or bring your own)</li></ul><h2 id=mission>Mission</h2><p>The cOS-toolkit project is under the Elemental umbrella.</p><p>Elemental provides a unique container based approach to define the system lifecycle of an immutable Linux derivative, without any string attached to a specific Linux distribution.</p><p>At its heart, Elemental is the abstraction layer between Linux distro management and the specific purpose of the OS.</p><p>Elemental empowers anyone to create derivatives from standard OCI images. Frees whoever wants to create a Linux derivative from handling the heavy bits of packaging and managing entire repositories to propagate upgrades, simplifying the entire process by using container images as base for OS.
At the same time, Elemental provides an highly integrated ecosystem which is designed to be container-first, cloud native, and immutable.
Anyone can tweak Elemental derivatives from the bottom-up to enable and disable its featureset.</p><p>As the Elemental team, the <a href=https://github.com/rancher-sandbox/os2>os2</a> project is our point of reference.</p><p><code>os2</code> is a complete derivative built with Elemental tied with the rancher ecosystem and full cycle node management solution with Kubernetes.</p><p>We are supporting directly and indirectly <code>os2</code> within changes also in the Elemental ecosystem.</p><p><code>os2</code> is our main show-case, and as the Elemental team we are committed to it. It encompasses several technologies to create a Kubernetes-focused Linux derivative which lifecycle is managed entirely from Kubernetes itself, <a href=https://www.intel.it/content/www/it/it/internet-of-things/secure-device-onboard.html>Secure Device Onboarding</a> included, and automatic provisioning via cloud-init.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-93aadc1aba179e6928539400a09b9e4e>1 - Getting Started</h1><div class=lead>Getting started with cOS</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vRSuocC4_2rHeJAWW2vqinw_EZeZxTzJFo5ZwnJaL_sdKab_R_OsCTLT_LFh1_L5fUcA_2i9FIe-k69/pub?w=1223&h=691" alt></p><p>cOS provides a runtime and buildtime framework in order to boot containers in VMs, Baremetals and Cloud.</p><p>You can either choose to <strong>build</strong> a cOS derivative or <strong>run</strong> cOS to boostrap a new system.</p><p>cOS vanilla images are published to allow to deploy user-built derivatives.</p><p>cOS is designed to run, deploy and upgrade derivatives that can be built just as standard OCI container images. cOS assets can be used to either drive unattended deployments of a derivative or used to create custom images (with packer).</p><h2 id=philosophy>Philosophy</h2><p>Philosophy behind cos-toolkit is simple: it allows you to create Linux derivatives from container images.</p><ul><li><strong>Container registry as a single source of truth</strong></li><li>Hybrid way to access your image for different scopes (development, debugging, ..)</li><li>No more inconsistent states between nodes. A “Store” to keep your (tagged) shared states where you can rollback and upgrade into.</li><li>“Stateless”: Images with upgrades are rebuilt from scratch instead of applying upgrades.</li></ul><p>A derivative which includes cos-toolkit, in runtime can:</p><img style=float:left src="https://docs.google.com/drawings/d/e/2PACX-1vRLayrWAJo6g8ssUwKmREIkwcOHWOn_nlUUNgFxkn9HcZkE3RrAXTBWd4gVj1rxPHg559kAzUk_rsqr/pub?w=384&h=255"><ul><li><a href=./upgrading>Upgrade to another container image</a></li><li><a href=./deploy>Deploy a system from scratch from an image</a></li><li><a href=./recovery>Reset or recovery to an Image</a></li><li><a href=../customizing/runtime_persistent_changes>Customize the image during runtime to persist changes across reboots</a></li><li><a href=./booting>Perform an installation from Live medium</a></li></ul><p>The container image, seamlessly:</p><ul><li>is booted as-is, encapsulating all the needed components (kernel, initrd, cos-toolkit, ecc)</li><li>can be pulled locally for inspection, development and debugging</li><li>can be used to create installation medium as ISO, Raw images, OVA, Cloud</li></ul><h2 id=build-cos-derivatives>Build cOS derivatives</h2><p>The starting point to use cos-toolkit is to check out our <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples>examples</a> and our <a href=../creating-derivatives/creating_bootable_images>creating bootable images</a> section.</p><p>The only requirement to build derivatives with <code>cos-toolkit</code> is Docker installed. If you are interested in building cOS-toolkit itself, see <a href=../development>Development notes</a>.</p><p>The toolkit itself is delivered as a set of standalone, re-usable OCI artifacts which are tagged and tracked as standard OCI images and it is installed inside the container image to provide the same featureset among derivatives, see <a href=../creating-derivatives/creating_bootable_images>how to create bootable images</a>.</p><h3 id=what-to-do-next>What to do next?</h3><p>Check out <a href=../creating-derivatives/creating_bootable_images>how to create bootable images</a> or <a href=../getting-started/download>download the cOS vanilla images</a> to give cOS a try!</p></div><div class=td-content style=page-break-before:always><h1 id=pg-6d9b743260710738d7e98b374307931e>1.1 - Download</h1><div class=lead>How to get cOS vanilla assets: ISOs, Cloud Images, Vagrant boxes, &mldr;.</div><p>cOS-toolkit releases consist on container images that can be used to build derived against and the cos source tree itself.</p><p>cOS supports different release channels, all the final and cache images used are tagged and pushed regularly <a href=https://quay.io/repository/costoolkit/releases-green>to Quay Container Registry</a> and can be pulled for inspection from the registry as well.</p><p>Those are exactly the same images used during upgrades, and can also be used to build Linux derivatives from cOS.</p><p>For example, if you want to see locally what&rsquo;s in a openSUSE cOS version, you can:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ docker run -ti --rm quay.io/costoolkit/releases-green:cos-system-<span style=color:#000>$VERSION</span> /bin/bash
</code></pre></div><h2 id=download-cos>Download cOS</h2><p>You can also try out cOS from the vanilla images and use it to experiment locally or either bootstrap a derivative: those are minimal system with a small package set in order to boot and deploy a container.</p><p>Latest cOS-toolkit releases assets (ISOs, Raw disks, Cloud images) can be found on <a href=https://github.com/rancher-sandbox/cOS-toolkit/releases/>Github</a>, check <a href=../booting>Booting</a> for an explanation of each asset type and how to use it.</p><p>cOS can run in: VMs, baremetals and Cloud - the default login username/password is <code>root/cos</code>.</p><h3 id=install>Install</h3><p>To install run <code>elemental install &lt;device></code> to start the installation process. Remove the ISO/medium and reboot.</p><p><em>Note</em>: <code>elemental install</code> supports other options as well. Run <code>elemental install --help</code> to see a complete help.</p><h2 id=releases>Releases</h2><p>cOS has 3 variants:</p><ul><li><a href=https://quay.io/repository/costoolkit/releases-green>green</a>: openSUSE based one, shipping packages from OpenSUSE Leap 15.3 repositories.</li><li><a href=https://quay.io/repository/costoolkit/releases-blue>blue</a>: Fedora based one, shipping packages from Fedora 33 repositories</li><li><a href=https://quay.io/repository/costoolkit/releases-orange>orange</a>: Ubuntu based one, shipping packages form Ubuntu 20.10 repositories</li></ul><p>We currently support and test only the <strong>green</strong> variant.</p><h2 id=published-ami-images>Published AMI images</h2><p>We publish AMI images for each release, you can find them into ec2 for example with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>aws ec2 describe-images --filters <span style=color:#4e9a06>&#39;Name=description,Values=cOS*&#39;</span>
</code></pre></div><p>The list of all the published AMI is released as part of the <a href=https://github.com/rancher-sandbox/cOS-toolkit/releases>releases</a> assets with the <code>ami_id.txt.tar.xz</code> file, e.g. <a href=https://github.com/rancher-sandbox/cOS-toolkit/releases/download/v0.6.7/ami_id.txt.tar.xz>v0.6.7</a></p><p>The AMI Owner ID is <code>053594193760</code>.</p><h2 id=what-to-do-next>What to do next?</h2><p>Check out <a href=../../customizing>the customization section</a> to customize <code>cOS</code> or <a href=../tutorials>the tutorial section</a> for some already prepared recipe examples.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f085d0d6d0675180d3331caca3265de5>1.2 - Installing</h1><div class=lead>Installing cOS or a derivative locally</div><p>cOS (or any cOS derivative built with cos-toolkit) can be installed with <code>elemental install</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental install <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span> &lt;device&gt;
</code></pre></div><table><thead><tr><th>Option</th><th>Description</th></tr></thead><tbody><tr><td>&ndash;cloud-init string</td><td>Cloud-init config file</td></tr><tr><td>&ndash;cosign</td><td>Enable cosign verification (requires images with signatures)</td></tr><tr><td>&ndash;cosign-key string</td><td>Sets the URL of the public key to be used by cosign validation</td></tr><tr><td>&ndash;directory string</td><td>Use directory as source to install from</td></tr><tr><td>&ndash;docker-image string</td><td>Install a specified container image</td></tr><tr><td>&ndash;force</td><td>Force install</td></tr><tr><td>&ndash;force-efi</td><td>Forces an EFI installation</td></tr><tr><td>&ndash;force-gpt</td><td>Forces a GPT partition table</td></tr><tr><td>&ndash;help</td><td>help for install</td></tr><tr><td>&ndash;iso string</td><td>Performs an installation from the ISO url</td></tr><tr><td>&ndash;no-format</td><td>Don’t format disks. It is implied that COS_STATE, COS_RECOVERY, COS_PERSISTENT, COS_OEM are already existing</td></tr><tr><td>&ndash;no-verify</td><td>Disable mtree checksum verification (requires images manifests generated with mtree separately)</td></tr><tr><td>&ndash;partition-layout string</td><td>Partitioning layout file</td></tr><tr><td>&ndash;poweroff</td><td>Shutdown the system after install</td></tr><tr><td>&ndash;reboot</td><td>Reboot the system after install</td></tr><tr><td>&ndash;strict</td><td>Enable strict check of hooks (They need to exit with 0)</td></tr><tr><td>&ndash;tty</td><td>Add named tty to grub</td></tr></tbody></table><h3 id=custom-oem-configuration>Custom OEM configuration</h3><p>During installation it can be specified a <a href=../../reference/cloud_init>cloud-init config file</a>, that will be installed and persist in the system after installation:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental install --cloud-init <span style=color:#ce5c00;font-weight:700>[</span>url<span style=color:#000;font-weight:700>|</span>path<span style=color:#ce5c00;font-weight:700>]</span> &lt;device&gt;
</code></pre></div><h3 id=custom-partitioning-layout>Custom partitioning layout</h3><p>When installing with GPT or EFI it&rsquo;s possible to specify a custom partitioning layout via specific config file, e.g.:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>partitioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart disk&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/dev/sda</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_OEM</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oem</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># default filesystem is ext2 if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>filesystem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>recovery</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># default filesystem is ext2 if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>filesystem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>40000</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Refer to the <a href=../../reference/cloud_init>cloud-init config file reference</a> about the <code>layout</code> section.</p><p>It can be also used to create additional partitions, or either create partitions into a different device, etc..</p><p>Run the installer with</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>
elemental install --partition-layout &lt;file&gt; &lt;device&gt;

</code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>While specifying a custom layout it is necessary to at least create 4 partitions: <code>COS_OEM</code>, <code>COS_STATE</code>, <code>COS_RECOVERY</code>, <code>COS_PERSISTENT</code>. Keep in mind the following while adjusting the partition sizes manually:</p><ul><li><code>COS_OEM</code> typically is used to store cloud-init files, so it can be also small.</li><li><code>COS_STATE</code> is used to store all the system images, which by default are set to <code>3GB</code>. This value is customizable <a href=../../customizing/general_configuration>in our configuration file</a>. A system may contain 2 images (Active/Passive), plus additional space for a third transitioning image which will be created during upgrades.</li><li><code>COS_RECOVERY</code> contains the recovery image, and additional space for a transition image during upgrades</li><li><code>COS_PERSISTENT</code> is the persistent partition that is mounted over <code>/usr/local</code>. Typically is set to take all the free space left.</li></ul></div><h3 id=installation-from-3rd-party-livecd-or-rescue-mediums>Installation from 3rd party LiveCD or rescue mediums</h3><p>The installer can be used to perform installations also from outside the cOS or standard derivative ISOs.</p><p>For instance, it is possible to install cOS (or any derivative) with the installer from another bootable medium, or a rescue mode which is booting from RAM, given there is enough free RAM available.</p><h4 id=with-docker>With Docker</h4><p>If in the rescue system, or LiveCD you have docker available, it can be used to perform an installation</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run --privileged -v /dev/:/dev/ -ti quay.io/costoolkit/elemental:latest install --docker-image <span style=color:#000>$IMAGE</span> <span style=color:#000>$DEVICE</span>
</code></pre></div><p>Where <code>$IMAGE</code> is the container image that we want to install (e.g. <code>quay.io/costoolkit/releases-green:cos-system-0.8.7</code> ), and <code>$DEVICE</code> is the device where to perform the installation to (e.g. <code>/dev/sda</code>).</p><p>Note, we used the <code>quay.io/costoolkit/elemental:latest</code> image which contains the latest stable installer and the dependencies.
You can see all the versions at <a href="https://quay.io/repository/costoolkit/elemental?tab=tags">quay</a>.</p><h4 id=by-using-manually-the-elemental-installer>By using manually the Elemental installer</h4><p>Similarly, the same mechanism can be used without docker. Download elemental from <a href=https://github.com/rancher-sandbox/elemental/releases/latest>github releases</a> and run the follow as root:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental install --docker-image <span style=color:#000>$IMAGE</span> <span style=color:#000>$DEVICE</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-20ed69725da67a67450fffe152e9dc9f>1.3 - Booting</h1><div class=lead>Documents various methods for booting cOS vanilla images</div><img style=float:right src="https://docs.google.com/drawings/d/e/2PACX-1vQXQFmc4MnmRsPCLR1_hCElykMWbcye6TY-zDWZhVyFbIqFEXyVsLgPIKVqUCZaQTkAE00uAK66Mt-D/pub?w=507&h=217"><p>Each cOS release contains a variety of assets:</p><ul><li>ISOs <code>cOS-Seed-green-$VERSION-$ARCH.iso.tar.xz</code></li><li>QCOW <code>cOS-Packer-green_$VERSION-QEMU-$ARCH.tar.gz.tar.xz</code></li><li>OVA <code>cOS-Packer-green_$VERSION-vbox-$ARCH.tar.gz.tar.xz</code></li><li>Vagrant box (vbox provider) <code>cOS-Packer-green-$VERSION-vbox-$ARCH.box.tar.xz</code></li><li>Vagrant box (qemu provider) <code>cOS-Packer-green-$VERSION-QEMU-$ARCH.box.tar.xz</code></li><li>RAW Disk <code>cOS-Vanilla-RAW-$VERSION-$ARCH.raw.tar.xz</code></li><li>VHD <code>cOS-Vanilla-AZURE-$VERSION-$ARCH.vhd.tar.xz</code></li><li>GCE <code>cOS-Vanilla-GCE-green-$VERSION-$ARCH.raw.tar.xz</code></li></ul><p>here we try to summarize and document how they are meant to be consumed.</p><h2 id=iso>ISO</h2><p>ISO images (e.g. ``cOS-Seed-green-$VERSION-$ARCH.iso.tar.xz` ) are shipping a cOS vanilla image and they feature an installer to perform an automated installation. They can be used to burn USB sticks or CD/DVD used to boot baremetals. Once booted, you can install cOS with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental install <span style=color:#000>$DEVICE</span>
</code></pre></div><p>See also [../install] for installation options.</p><p>After the first boot you can also switch to a derivative by:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental upgrade --docker-image --no-verify <span style=color:#000>$IMAGE</span>
</code></pre></div><h2 id=booting-from-network>Booting from network</h2><p>You can boot a cOS squashfs by using a native iPXE implementation on your
system or by inserting a custom build iPXE iso by using your either your servers
management web-interface (ILO, iDrac, &mldr;) or using a
<a href=https://www.dmtf.org/standards/redfish>redfish</a> library or its vendor specific implementation (e.g. <a href=https://hewlettpackard.github.io/python-redfish-utility/>ilorest</a>).</p><p>To boot from IPXE you need to extract the squashfs from
<a href="https://quay.io/repository/costoolkit/releases-green?tab=tags">images</a> with the <code>cos-img-recovery-</code> prefix.
By pulling the image, saving it using docker save, then unpack the single layer
in the file to an extra directory and then run</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; mksquashfs &lt;path_to_folder&gt; &lt;output_path&gt;/root.squashfs
</code></pre></div><p><strong>Note:</strong>
The squashfs file can also be extracted using the following <code>docker</code> command:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker run -v <span style=color:#000>$PWD</span>:/cOS --entrypoint /usr/bin/luet -ti --rm quay.io/costoolkit/toolchain util unpack quay.io/costoolkit/releases-green:cos-img-recovery-&lt;version&gt; .
</code></pre></div><p>Then copy the <code>boot</code> directory and the squashfs file to your webserver and use
the following script to boot.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic>#!ipxe
</span><span style=color:#8f5902;font-style:italic></span>
ifconf
kernel http://&lt;web_server_ip&gt;/boot/vmlinuz <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span>dhcp rd.cos.disable rd.noverifyssl
<span style=color:#000>root</span><span style=color:#ce5c00;font-weight:700>=</span>live:http://&lt;web_server_ip&gt;/root.squashfs <span style=color:#000>console</span><span style=color:#ce5c00;font-weight:700>=</span>ttyS0 <span style=color:#000>console</span><span style=color:#ce5c00;font-weight:700>=</span>tty1 cos.setup<span style=color:#ce5c00;font-weight:700>=</span>http://&lt;web_server_ip&gt;/&lt;path_to_cloud_config.yaml&gt;
initrd http://&lt;web_server_ip&gt;/boot/initrd
boot
</code></pre></div><p>To build a custom iPXE image clone the source from
<a href=https://github.com/ipxe/ipxe>https://github.com/ipxe/ipxe</a>, then traverse into
the <code>src</code> directory and run <code>make EMBED=&lt;/path/to/your/script.ipxe></code>. The
resulting iso can be found in <code>src/bin/ipxe.iso</code> and should be <code>~1MB</code> in size.</p><h2 id=virtual-machines>Virtual machines</h2><p>For booting into Virtual machines we offer QCOW2, OVA, and raw disk recovery images which can be used to bootstrap your booting container.</p><h3 id=qcow2>QCOW2</h3><p>QCOW2 images ( e.g. <code>cOS-Packer-green-$VERSION-QEMU-$ARCH.tar.gz.tar.xz</code> ) contains a pre-installed cOS system which can be booted via QEMU, e.g:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qemu-system-x86_64 -m <span style=color:#0000cf;font-weight:700>2048</span> -hda cOS -nographic
</code></pre></div><h3 id=ova>OVA</h3><p>Ova images ( e.g. <code>cOS-Packer-green-$VERSION-vbox-$ARCH.tar.gz.tar.xz</code> ) contains a pre-installed cOS system which can be booted via vbox.
Please check the virtuabox docs on how to create a new VM with an existing disk.</p><h3 id=vagrant>Vagrant</h3><p>Download the vagrant box artifact ( e.g. <code>cOS-Packer-green-$VERSION-{vbox, QEMU}-$ARCH.box.tar.xz</code> ), extract it and run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>vagrant box add cos &lt;cos-box-image&gt;
vagrant init cos
vagrant up
</code></pre></div><h3 id=raw-disk-images>RAW disk images</h3><p>RAW disk images ( e.g. <code>cOS-Vanilla-RAW-green-$VERSION-$ARCH.raw.tar.xz</code> ) contains only the <code>cOS</code> recovery system. Those are typically used when creating derivatives images based on top of <code>cOS</code>.</p><p>They can be run with QEMU with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>qemu-system-x86_64 -m <span style=color:#0000cf;font-weight:700>2048</span> -hda &lt;cos-disk-image&gt;.raw -bios /usr/share/qemu/ovmf-x86_64.bin
</code></pre></div><h2 id=cloud-images>Cloud Images</h2><p>Cloud images are <code>vanilla</code> images that boots into <a href=../recovery>recovery mode</a> and can be used to deploy
whatever image you want to the VM. Then you can snapshot that VM into a VM image ready to deploy with the default cOS
system or your derivative.</p><p>At the moment we support Azure and AWS images among our artifacts. We publish AWS images that can also be re-used in packer templates for creating customized AMI images.</p><p>The RAW image can then be used into packer templates to generate custom Images, or used as-is with a userdata to deploy a container image of choice with an input user-data.</p><h3 id=import-an-aws-image-manually>Import an AWS image manually</h3><div class="pageinfo pageinfo-primary"><p>You can also use RAW images ( e.g. <code>cOS-Vanilla-RAW-green-$VERSION-$ARCH.raw.tar.xz</code> ) manually when importing AMIs images and use them to generate images with Packer. See <a href=../../creating-derivatives/packer/build_ami>build AMI with Packer</a></p></div><ol><li>Upload the raw image to an S3 bucket</li></ol><pre><code>aws s3 cp &lt;cos-raw-image&gt; s3://&lt;your_s3_bucket&gt;
</code></pre><ol start=2><li>Created the disk container JSON (<code>container.json</code> file) as:</li></ol><pre><code>{
  &quot;Description&quot;: &quot;cOS Testing image in RAW format&quot;,
  &quot;Format&quot;: &quot;raw&quot;,
  &quot;UserBucket&quot;: {
    &quot;S3Bucket&quot;: &quot;&lt;your_s3_bucket&gt;&quot;,
    &quot;S3Key&quot;: &quot;&lt;cos-raw-image&gt;&quot;
  }
}
</code></pre><ol start=3><li>Import the disk as snapshot</li></ol><pre><code>aws ec2 import-snapshot --description &quot;cOS PoC&quot; --disk-container file://container.json
</code></pre><ol start=4><li><p>Followed the procedure described in <a href=https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-an-ami-ebs.html#creating-launching-ami-from-snapshot>AWS docs</a> to register an AMI from snapshot. Used all default settings unless for the firmware, set to force to UEFI boot.</p></li><li><p>Launch instance with this simple userdata with at least a 16Gb boot disk:</p></li></ol><pre><code>name: &quot;Default deployment&quot;
stages:
   rootfs.after:
     - name: &quot;Repart image&quot;
       layout:
         # It will partition a device including the given filesystem label or part label (filesystem label matches first)
         device:
           label: COS_RECOVERY
         add_partitions:
           - fsLabel: COS_STATE
             # 10Gb for COS_STATE, so the disk should have at least 16Gb
             size: 10240
             pLabel: state
           - fsLabel: COS_PERSISTENT
             # unset size or 0 size means all available space
             pLabel: persistent
   initramfs:
     - if: '[ -f &quot;/run/cos/recovery_mode&quot; ]'
       name: &quot;Set sshd to wait for deployment&quot;
       files:
       - path: &quot;/etc/systemd/system/sshd.service.d/override.conf&quot;
         content: |
             [Unit]
             After=cos-setup-network.service
   network:
     - if: '[ -f &quot;/run/cos/recovery_mode&quot; ]'
       name: &quot;Deploy cos-system&quot;
       commands:
         - |
             # Use `elemental reset --docker-image &lt;img-ref&gt;` to deploy a custom image
             # By default the recovery cOS gets deployed
             elemental reset --reboot

</code></pre><h3 id=importing-a-google-cloud-image-manually>Importing a Google Cloud image manually</h3><div class="pageinfo pageinfo-primary"><p>You need to use the GCE images ( e.g. <code>cOS-Vanilla-GCE-green-$VERSION-$ARCH.raw.tar.xz</code> ) manually when importing GCE images and use them to generate images with Packer. See <a href=../../creating-derivatives/packer/build_gcp>build GCE with Packer</a></p></div><ol><li>Upload the Google Cloud compressed disk to your bucket</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gsutil cp &lt;cos-gce-image&gt; gs://&lt;your_bucket&gt;/
</code></pre></div><ol start=2><li>Import the disk as an image</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images create &lt;new_image_name&gt; --source-uri<span style=color:#ce5c00;font-weight:700>=</span>&lt;your_bucket&gt;/&lt;cos-gce-image&gt; --guest-os-features<span style=color:#ce5c00;font-weight:700>=</span>UEFI_COMPATIBLE
</code></pre></div><ol start=3><li>Launch instance with this simple userdata with at least a 16Gb boot disk:</li></ol><p style=font-style:italic><i class="fa fa-info-circle" aria-hidden=true>&nbsp;</i>See <a href=https://cloud.google.com/container-optimized-os/docs/how-to/create-configure-instance#using_cloud-init_with_the_cloud_config_format>here</a> on how to add user-data to an instance</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 10Gb for COS_STATE, so the disk should have at least 16Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10240</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set sshd to wait for deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/systemd/system/sshd.service.d/override.conf&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             [Unit]
</span><span style=color:#8f5902;font-style:italic>             After=cos-setup-network.service</span><span style=color:#f8f8f8;text-decoration:underline>             
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             # Use `elemental reset --docker-image &lt;img-ref&gt;` to deploy a custom image
</span><span style=color:#8f5902;font-style:italic>             # By default recovery cOS gets deployed
</span><span style=color:#8f5902;font-style:italic>             elemental reset --reboot</span><span style=color:#f8f8f8;text-decoration:underline>             
</span></code></pre></div><h3 id=importing-an-azure-image-manually>Importing an Azure image manually</h3><p style=font-style:italic><i class="fa fa-info-circle" aria-hidden=true>&nbsp;</i><p>You need to use the AZURE images ( e.g. <code>cOS-Vanilla-AZURE-green-$VERSION-$ARCH.raw.tar.xz</code> ) manually when importing Azure images.</p></p><ol><li>Upload the Azure Cloud VHD disk in <code>.vhda</code> format ( extract e.g. <code>cOS-Vanilla-AZURE-green-0.6.0-g7d04f1db-x86_64.vhd.tar.xz</code> ) to your bucket</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az storage copy --source &lt;cos-azure-image&gt; --destination https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;destination-cos-azure-image&gt;

</code></pre></div><ol start=2><li>Import the disk as an image</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image create --resource-group &lt;resource-group&gt; --source https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;cos-azure-image&gt; --os-type linux --hyper-v-generation v2 --name &lt;image-name&gt;
</code></pre></div><ol start=3><li>Launch instance with this simple userdata with at least a 16Gb boot disk:</li></ol><p>Hint: There is currently no way of altering the boot disk of an Azure VM via GUI, use the azure-cli to launch the VM with an expanded OS disk</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 10Gb for COS_STATE, so the disk should have at least 16Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10240</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set sshd to wait for deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/systemd/system/sshd.service.d/override.conf&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             [Unit]
</span><span style=color:#8f5902;font-style:italic>             After=cos-setup-network.service</span><span style=color:#f8f8f8;text-decoration:underline>             
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             # Use `elemental reset --docker-image &lt;img-ref&gt;` to deploy a custom image
</span><span style=color:#8f5902;font-style:italic>             # By default recovery cOS gets deployed
</span><span style=color:#8f5902;font-style:italic>             elemental reset --reboot</span><span style=color:#f8f8f8;text-decoration:underline>             
</span></code></pre></div><h2 id=login>Login</h2><p>By default you can login with the user <code>root</code> and password <code>cos</code>.</p><p>See the <a href=../../customizing/login>customization section</a> for examples on how to persist username and password changes after installation.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b8ae70d603defa5e6fa86ed3ac457356>1.4 - Upgrading</h1><div class=lead>How to run upgrades in cOS</div><img style=float:right src="https://docs.google.com/drawings/d/e/2PACX-1vTM9N71bvNnf8PqeHyzVdfVACHix8vTS5aMGsdQGz2eVqyWyKlVreep4UJVVnNpSAKPLVOwEhwAmhTP/pub?w=379&h=308"><p>cOS and every derivative can upgrade, rollback or just switch to different versions in runtime by using the toolkit installed inside the image.</p><p>To upgrade an installed system, just run <code>elemental upgrade</code> and reboot.</p><p>This will perform an upgrade based on the default derivative configuration for the image. See <a href=../../customizing/general_configuration>general configuration</a> on how to configure defaults when building a derivative.</p><p>&ldquo;Upgrades&rdquo; are not carried over the usual way of treating each single package individually: cOS considers the container image as a new system where to boot into. It will pull a new container image during this phase, which will be booted on the next reboot.</p><h2 id=upgrade-to-a-specific-container-image>Upgrade to a specific container image</h2><p>To specify a specific container image to upgrade to instead of the regular upgrade channels, run <code>elemental upgrade --docker-image image</code>.</p><p><em>Note</em> by default <code>elemental upgrade --docker-image</code> checks images against the notary registry server for valid signatures for the images tag. To disable image verification, run <code>elemental upgrade --no-verify --docker-image</code>.</p><h2 id=integration-with-system-upgrade-controller>Integration with System Upgrade Controller</h2><p>If running a kubernetes cluster on the <code>cOS</code> system, you can leverage the <a href=https://github.com/rancher/system-upgrade-controller>system-upgrade-controller</a> to trigger upgrades to specific image versions, for example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>upgrade.cattle.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Plan</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elemental-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>system-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>k3s-upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>server</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>fleet-sample</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Image tag</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nodeSelector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchExpressions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- {<span style=color:#204a87;font-weight:700>key: k3s.io/hostname, operator</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Exists}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>system-upgrade</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cordon</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#  drain:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#    force: true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>quay.io/costoolkit/test-images</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># Image upgrade reference</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>command</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#4e9a06>&#34;/usr/sbin/suc-upgrade&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>See also <a href=../tutorials/trigger_upgrades_with_fleet>trigger upgrades with fleet</a></p><h2 id=from-iso>From ISO</h2><p>The ISO can be also used as a recovery medium: type <code>elemental upgrade</code> from a LiveCD. It will then try to upgrade the image of the active partition installed in the system.</p><h2 id=how-it-works>How it works</h2><p>cOS during installation sets two <code>.img</code> images files in the <code>COS_STATE</code> partition:</p><ul><li><code>/cOS/active.img</code> labeled <code>COS_ACTIVE</code>: Where <code>cOS</code> typically boots from</li><li><code>/cOS/passive.img</code> labeled <code>COS_PASSIVE</code>: Where <code>cOS</code> boots for fallback</li></ul><p>Those are used by the upgrade mechanism to prepare and install a pristine <code>cOS</code> each time an upgrade is attempted.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-116792d44b4b0a19cbac9a2d12b83ee4>1.5 - Recovery</h1><div class=lead>How to use the recovery partition to reset the system or perform upgrades.</div><p>cOS derivatives have a recovery mechanism built-in which can be leveraged to restore the system to a known point. At installation time, the recovery partition is created from the installation medium.</p><p>The recovery system can be accessed during boot by selecting the last entry in the menu (labeled by &ldquo;recovery&rdquo;).</p><p>A derivative can be recovered anytime by booting into the <code>recovery</code> partition and by running <code>elemental reset</code> from it.</p><p>This command will regenerate the bootloader and the images in the <code>COS_STATE</code> partition by using the recovery image.</p><h3 id=upgrading-the-recovery-partition>Upgrading the recovery partition</h3><p>From either the active or passive system, the recovery partition can also be upgraded by running</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental upgrade --recovery
</code></pre></div><p>It also supports to specify docker images directly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental upgrade --recovery --docker-image &lt;image&gt;
</code></pre></div><h3 id=upgrading-the-active-system-from-the-recovery>Upgrading the active system from the recovery</h3><p>The recovery system can upgrade also the active system by running <code>elemental upgrade</code>, and it also supports to specify docker images directly:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>elemental upgrade --recovery --docker-image &lt;image&gt;
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4f3d9f9b1fc979ace402c3f90122722d>1.6 - Deploying</h1><div class=lead>How to deploy derivatives images from cOS vanilla images</div><p>cOS vanilla images, like ISOs, cloud images or raw disks can be used to deploy another derivative image.</p><h2 id=elemental-reset><code>elemental reset</code></h2><p><code>elemental reset</code> can be used to reset the system from the recovery image or from a custom image. Vanilla images only include a minimal recovery partition and system.</p><p>It can be either invoked manually with <code>elemental reset --docker-image &lt;img-ref></code> or used in conjuction with a cloud-init configuration, for example consider the following <a href=../../reference/cloud_init>cloud-init configuration file</a>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 10Gb for COS_STATE, so the disk should have at least 16Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10240</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cOS system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>             # Use `elemental reset --docker-image &lt;img-ref&gt;` to deploy a custom image
</span><span style=color:#8f5902;font-style:italic>             # By default the recovery cOS gets deployed
</span><span style=color:#8f5902;font-style:italic>             elemental reset --reboot --docker-image $IMAGE</span><span style=color:#f8f8f8;text-decoration:underline>             
</span></code></pre></div><p>The following will first repartition the image after the <code>rootfs</code> <a href=../../customizing/stages>stage</a> and will run <code>elemental reset</code> when booting into <a href=../recovery>recovery mode</a>. RAW vanilla disk images automatically boot by default into recovery, so the first thing upon booting is deploying the system</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4f8fa1d779276bb728601b46845a8df5>2 - Customizing</h1><div class=lead>This section contains various articles relative on how to customize cOS, branding and behavior.</div></div><div class=td-content><h1 id=pg-8637cd7f2ce65f4c97959f4d2a723eb9>2.1 - Stages</h1><div class=lead>Configure the system in the various stages: boot, initramfs, fs, network, reconcile</div><p>We have a custom augmented cloud-init syntax that allows to hook into various stages of the system, for example:</p><ul><li>Initramfs load</li><li>Boot</li><li>Network availability</li><li>During upgrades, installation, deployments , and resets</li></ul><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vRuITNgkCeDfS4LqxDvz2j4WxuRDzU8dJOTa5CY88ya8_hJ1QeaGKipTanggtiXiCxhwkUpYld-Cbxa/pub?w=885&h=761" alt=Stages></p><p>Cloud-init files in <code>/system/oem</code>, <code>/oem</code> and <code>/usr/local/oem</code> are applied in 5 different phases: <code>boot</code>, <code>network</code>, <code>fs</code>, <code>initramfs</code> and <code>reconcile</code>. All the available cloud-init keywords can be used in each stage. Additionally, it&rsquo;s possible also to hook before or after a stage has run, each one has a specific stage which is possible to run steps: <code>boot.after</code>, <code>network.before</code>, <code>fs.after</code> etc.</p><p>Multiple stages can be specified in a single cloud-init file.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>When a cOS derivative boots it creates sentinel files in order to allow to execute cloud-init steps programmaticaly.</p><ul><li><code>/run/cos/recovery_mode</code> is being created when booting from the recovery partition</li><li><code>/run/cos/live_mode</code> is created when booting from the LiveCD</li></ul><p>To execute a block using the sentinel files you can specify: <code>if: '[ -f "/run/cos/..." ]'</code>, see the examples below.</p></div><h2 id=stages>Stages</h2><p>Below there is a detailed list of the stages available that can be used in the cloud-init configuration files</p><h3 id=rootfs><code>rootfs</code></h3><p>This is the earliest stage, running before switching root, just right after the
root is mounted in <code>/sysroot</code> and before applying the immutable rootfs configuration.
This stage is executed over initrd root, no chroot is applied.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Set persistent devices&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Layout configuration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=initramfs><code>initramfs</code></h3><p>This is still an early stage, running before switching root. Here you can apply radical changes to the booting setup of <code>cOS</code>.
Despite this is executed before switching root this exection runs chrooted into the target root after the immutable rootfs is set up and ready.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on initramfs&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          # Run something when we are booting in active or passive
</span><span style=color:#8f5902;font-style:italic>          touch /etc/something_important</span><span style=color:#f8f8f8;text-decoration:underline>          
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=boot><code>boot</code></h3><p>This stage is executed after initramfs has switched root, during the <code>systemd</code> bootup process.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>boot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=fs><code>fs</code></h3><p>This stage is executed when fs is mounted and is guaranteed to have access to <code>COS_STATE</code> and <code>COS_PERSISTENT</code>.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>fs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>touch /usr/local/something</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=network><code>network</code></h3><p>This stage is executed when network is available</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Network is available, do something..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=reconcile><code>reconcile</code></h3><p>This stage is executed <code>5m</code> after boot and periodically each <code>60m</code>.</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something on boot&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>reconcile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/sentinel&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>touch /run/sentinel</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-install><code>after-install</code></h3><p>This stage is executed after installation of the OS has ended (last step of <code>elemental install</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after installation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-install</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-install-chroot><code>after-install-chroot</code></h3><p>This stage is executed after installation of the OS has ended (last step of <code>elemental install</code>).<div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Steps executed at this stage are running <em>inside</em> the new OS as chroot, allowing to write persisting changes to the image,
for example by downloading and installing additional software.</div></p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after installation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-install-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>         </span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-upgrade><code>after-upgrade</code></h3><p>This stage is executed after upgrade of the OS has ended (last step of <code>elemental upgrade</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after upgrade&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-upgrade-chroot><code>after-upgrade-chroot</code></h3><p>This stage is executed after upgrade of the OS has ended (after calling <code>elemental upgrade</code>).<div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Steps executed at this stage are running <em>inside</em> the new OS as chroot, allowing to write persisting changes to the image,
for example by downloading and installing additional software.</div></p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after installation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-upgrade-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>         </span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-reset><code>after-reset</code></h3><p>This stage is executed after reset of the OS has ended (last step of <code>elemental reset</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after reset&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-reset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=after-reset-chroot><code>after-reset-chroot</code></h3><p>This stage is executed after reset of the OS has ended (last step of <code>elemental reset</code>).<div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Steps executed at this stage are running <em>inside</em> the new OS as chroot, allowing to write persisting changes to the image,
for example by downloading and installing additional software.</div></p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something after installation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-reset-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>         </span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=before-install><code>before-install</code></h3><p>This stage is executed before installation (executed during <code>elemental install</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something before installation&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>before-install</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=before-upgrade><code>before-upgrade</code></h3><p>This stage is executed before upgrade of the OS (executed during <code>elemental upgrade</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something before upgrade&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>before-upgrade</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=before-reset><code>before-reset</code></h3><p>This stage is executed before reset of the OS (executed during <code>elemental reset</code>).</p><p>Example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Run something before reset&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>before-reset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in active or passive</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setting&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          </span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Run something when we are booting in recovery mode</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-80272a2426a531df16f16d019ccd6724>2.2 - Configuration persistency</h1><div class=lead>Persisting configurations in cOS and derivatives</div><p>By default cOS and derivatives are reading and executing cloud-init files in (lexicopgrahic) sequence inside:</p><ul><li><code>/system/oem</code></li><li><code>/usr/local/cloud-config</code></li><li><code>/oem</code></li></ul><p>It is also possible to run cloud-init file in a different location (URLs included, too) from boot cmdline by using the <code>cos.setup=..</code> option.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>It is possible to install a custom <a href=../../reference/cloud_init/>cloud-init style file</a> during install with <code>--cloud-init</code> flag on <code>elemental install</code> command or, it&rsquo;s possible to add one or more files manually inside the <code>/oem</code> directory after installation.</div><p>While <code>/system/oem</code> is reserved for system configurations to be included directly in the derivative container image, the <code>/oem</code> folder instead is reserved for persistent cloud-init files that can be extended in runtime.</p><p>For example, if you want to change <code>/etc/issue</code> of the system persistently, you can create <code>/usr/local/cloud-config/90_after_install.yaml</code> or alternatively in <code>/oem/90_after_install.yaml</code> with the following content:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># The following is executed before fs is setted up:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>fs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;After install&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/issue</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>Welcome, have fun!</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0644</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#000>wicked</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;After install (second step)&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/motd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>Welcome, have more fun!</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0644</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>For more examples you can find <code>/system/oem</code> inside cOS vanilla images containing files used to configure on boot a pristine <code>cOS</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0f49c1b2fa940427a27c2c93a1d67077>2.3 - Runtime persistent changes</h1><div class=lead>Applying changes to cOS images in runtime or “how to install a package in an immutable OS at runtime?”</div><p>cOS and derivatives are <a href=../../reference/immutable_rootfs>immutable</a> systems. That means that any change in the running OS will not persist after a reboot.</p><p>While <a href=../configuration_persistency>configurations can be persisted</a>, there are occasions where installing a custom package or provide additional persistent files in the end system is needed.</p><p>We will see here a way to install packages, drivers, or apply any modification we might want to do in the OS image during runtime, without any need to rebuild the derivative container image. This will let any user (and not derivative developer) to apply any needed customization and to be able to persist across upgrades.</p><h2 id=transient-changes>Transient changes</h2><p>To apply transient changes, it&rsquo;s possible to boot a cOS derivative in read/write mode by specifying <code>rd.cos.debugrw</code> <a href=../../reference/immutable_rootfs>see here for more details</a>. This allows to do any change and will persist into the active/passive booting system (does NOT apply for recovery). Altough this methodology should be only considered for debugging purposes.</p><h2 id=persist-changes-with-cloud-init-files>Persist changes with Cloud init files</h2><p>Note: The following applies only to derivatives with
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/utils/installer class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> utils/installer</a>
at version <code>0.17</code> or newer</p><p>cOS allows to apply a set of commands, or cloud-init steps, during upgrade, deploy, install and reset in the context of the target image, in RW capabilities. This allows to carry on changes during upgrades on the target image without the need to re-build or have a custom derivative image.</p><p>All the configuration that we want to apply to the system will run each time we do an upgrade, a reset or an installation on top of the new downloaded image (in case of upgrade) or the image which is the target system.</p><p>Between the available <a href=../stages>stages</a> in the <a href=../../reference/cloud_init/>cloud-init</a> there are <code>after-upgrade-chroot</code>, <code>after-install-chroot</code>, <code>after-reset-chroot</code> and <code>after-deploy-chroot</code>, for example, consider the following cloud-init file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Install something&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-upgrade-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>zypper in -y ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-reset-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>zypper in -y ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-deploy-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>zypper in -y ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-install-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>zypper in -y ...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>It will run the <code>zypper in -y ...</code> calls during each stage, in the context of the target system, allowing to customize the target image with additional packages.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><code>zypper</code> calls here are just an example. We could have used <code>dnf</code> for fedora based, or <code>apt-get</code> for ubuntu based images.</div><p>When running the cloud-init steps the <code>/oem</code> partition and <code>/usr/local</code> will be mounted to <code>COS_OEM</code> and <code>COS_PERSISTENT</code> respectively, allowing to load extra data (e.g. rpm files, or configuration).</p><h2 id=example>Example</h2><p>If an user wants to install an additional package in the running system, and keep having that persistent across upgrades, he can copy the following file (<code>install.yaml</code>) inside the <code>/oem</code> folder, or <code>/usr/local/cloud-config</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Install something&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>after-upgrade-chroot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>zypper in -y vim</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>and run <code>elemental upgrade</code>.</p><p>It will automatically upgrade the system with the changes above included.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-aab355bcbb96f01ee8dabb0f90e6df5a>2.4 - General Configuration</h1><div class=lead>Configuring a cOS derivative</div><p>cOS during installation, reset and upgrade (<code>elemental install</code>, <code>elemental reset</code> and <code>elemental upgrade</code> respectively) will read a configuration file in order to apply derivative customizations. The configuration files are sourced in precedence order and can be located in the following places:</p><ul><li><code>/etc/environment</code></li><li><code>/etc/os-release</code></li><li><code>/etc/cos/config</code></li></ul><p>Below you can find a full example of the config file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># cOS configuration file</span>
<span style=color:#8f5902;font-style:italic># This file allows to tweak cOS configuration such as: default upgrade/recovery image and GRUB menu entry</span>

<span style=color:#8f5902;font-style:italic># Disable/enable image verification during upgrades ( default: false )</span>
<span style=color:#8f5902;font-style:italic>#NO_VERIFY=false</span>

<span style=color:#8f5902;font-style:italic># Disable/enable upgrades via release channels instead of container images. ( default: true )</span>
<span style=color:#8f5902;font-style:italic>#CHANNEL_UPGRADES=false</span>

<span style=color:#8f5902;font-style:italic># Default container image used for upgrades. ( defaults to system/cos with channel CHANNEL_UPGRADES enabled )</span>
<span style=color:#8f5902;font-style:italic>#UPGRADE_IMAGE=&#34;quay.io/mudler/cos-test:cos-standard&#34;</span>

<span style=color:#8f5902;font-style:italic># Default recovery image to use when upgrading the recovery partition</span>
<span style=color:#8f5902;font-style:italic># ( defaults to recovery/cos in vanilla cOS images with channel CHANNEL_UPGRADES enabled. Otherwise it defaults to UPGRADE_IMAGE ).</span>
<span style=color:#8f5902;font-style:italic>#RECOVERY_IMAGE=&#34;quay.io/mudler/cos-test:cos-standard&#34;</span>

<span style=color:#8f5902;font-style:italic># GRUB entry to display on boot. ( defaults: cOS )</span>
<span style=color:#8f5902;font-style:italic>#GRUB_ENTRY_NAME=&#34;example&#34;</span>

<span style=color:#8f5902;font-style:italic># Space separated list of additional paths that are used to</span>
<span style=color:#8f5902;font-style:italic># source cloud-config from. ( defaults paths are: /system/oem /oem/ /usr/local/cloud-config/ )</span>
<span style=color:#8f5902;font-style:italic>#CLOUD_INIT_PATHS=&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># This is the directory that can be used to store cloud-init files that can be enabled/disabled in runtime</span>
<span style=color:#8f5902;font-style:italic># by cos-features. ( defaults to /system/features )</span>
<span style=color:#8f5902;font-style:italic>#COS_FEATURESDIR=&#34;/system/features&#34;</span>

<span style=color:#8f5902;font-style:italic># This is the repository that hosts the signature files used by cosign and luet-cosign plugin during upgrade/deploy to</span>
<span style=color:#8f5902;font-style:italic># check the artifact signatures</span>
<span style=color:#8f5902;font-style:italic>#COSIGN_REPOSITORY=&#34;raccos/releases-green&#34;</span>

<span style=color:#8f5902;font-style:italic># This sets keyless verify on building packages with luet and the luet-cosign plugin.</span>
<span style=color:#8f5902;font-style:italic># 1  = enabled keyless, 0 = disabled, uses normal public key verification</span>
<span style=color:#8f5902;font-style:italic>#COSIGN_EXPERIMENTAL=1</span>

<span style=color:#8f5902;font-style:italic># This sets the location of the public key to use to verify the packages installed by luet during upgrade/deploy</span>
<span style=color:#8f5902;font-style:italic># This can be set to file, URL, KMS URI or Kubernetes Secret</span>
<span style=color:#8f5902;font-style:italic># This is only used if COSIGN_EXPERIMENTAL is set to 0</span>
<span style=color:#8f5902;font-style:italic>#COSIGN_PUBLIC_KEY_LOCATION=&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># Default size (in MB) of disk image files (.img) created during upgrades</span>
<span style=color:#8f5902;font-style:italic>#DEFAULT_IMAGE_SIZE=3240</span>

<span style=color:#8f5902;font-style:italic># Path to default configuration grub file</span>
<span style=color:#8f5902;font-style:italic>#GRUBCONF=&#34;/etc/cos/grub.cfg&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the OEM volume</span>
<span style=color:#000>OEM_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_OEM&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the PERSISTENT volume</span>
<span style=color:#000>PERSISTENT_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_PERSISTENT&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the RECOVERY volume</span>
<span style=color:#000>RECOVERY_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_RECOVERY&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the STATE volume</span>
<span style=color:#000>STATE_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_STATE&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the ACTIVE volume</span>
<span style=color:#000>ACTIVE_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_ACTIVE&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the PASSIVE volume</span>
<span style=color:#000>PASSIVE_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_PASSIVE&#34;</span>

<span style=color:#8f5902;font-style:italic># Label of the SYSTEM volume</span>
<span style=color:#000>SYSTEM_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;COS_SYSTEM&#34;</span>
</code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/packages/cos-config/cos-config>https://github.com/rancher-sandbox/cos-toolkit/blob/master/packages/cos-config/cos-config</a></i></small><hr></div><div class=td-content style=page-break-before:always><h1 id=pg-4c6f31346340371adbb7fd2ceccc2e88>2.5 - Login</h1><div class=lead>Default login, and how to override it</div><p>By default you can login with the user <code>root</code> and <code>cos</code> in a vanilla cOS image, this is also set automatically by the
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
package if used by a derivative.</p><p>You can change this by overriding <code>/system/oem/04_accounting.yaml</code> in the container image if present, or via <a href=../../reference/cloud_init/#stagesstage_idstep_nameusers>cloud-init</a>.</p><h3 id=examples>Examples</h3><ul><li><a href=https://github.com/mudler/c3os/blob/master/files/system/oem/10_accounting.yaml>Example accounting file</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-72eef8ed52ca1d1dab6e21a58816bac9>2.6 - OEM configuration</h1><div class=lead>OEM configuration reserved to cOS and derivatives</div><p>There are several way to customize cOS and a cos-toolkit derivative:</p><ul><li>declaratively in runtime with cloud-config file (by overriding, or extending)</li><li>stateful, embedding any configuration in the container image to be booted.</li></ul><p>For runtime persistence configuration, the only supported way is with cloud-config files, <a href=../configuration_persistency>see the relevant docs</a>.</p><p>A derivative automatically loads and executes cloud-config files during the various system <a href=../stages>stages</a> also inside <code>/system/oem</code> which is read-only and reserved to the system.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>The cloud-config mechanism works also as an emitter event pattern - running services or programs can emit new custom <code>stages</code> in runtime by running <code>cos-setup stage_name</code>.</div><p>Derivatives that wish to override default configurations can do that by placing extra cloud-init file, or overriding completely <code>/system/oem</code> in the target image.</p><p>This is to setup for example, the default root password or the prefered upgrade channel.</p><p>The following are the <code>cOS</code> default oem files, which are shipped within the
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
, which is an optional package:</p><pre><code>/system/oem/00_rootfs.yaml - defines the rootfs mountpoint layout setting
/system/oem/01_defaults.yaml - systemd defaults (keyboard layout, timezone)
/system/oem/02_upgrades.yaml - Settings for cOS vanilla channel upgrades
/system/oem/03_branding.yaml - Branding setting, Derivative name, /etc/issue content
/system/oem/04_accounting.yaml - Default user/pass
/system/oem/05_network.yaml - Default network setup
/system/oem/06_recovery.yaml - Executes additional commands when booting in recovery mode
</code></pre><p>You can either override the above files, or alternatively not consume the
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
package while building a derivative.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-891dfa0a6f57b2aababf7ee877e38876>2.7 - Upgrades</h1><div class=lead>Customizing the default upgrade channel</div><p><code>cOS</code> vanilla images by default are picking upgrades by the standard upgrade channel. It means it will always get the latest published <code>cOS</code> version by our CI.</p><p>However, it&rsquo;s possible to tweak the default behavior of <code>elemental upgrade</code> to point to a specific docker image/tag, or a different release channel.</p><p>By default, <code>cos</code> derivatives if not specified will point to latest <code>cos-toolkit</code>. To override, you need to or overwrite the content of <code>/system/oem/02_upgrades.yaml</code> or supply an additional one, e.g. <code>/system/oem/03_upgrades.yaml</code> in the final image, see <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/packages/cloud-config/oem/02_upgrades.yaml>the default here</a>.</p><h2 id=configuration>Configuration</h2><p><code>elemental upgrade</code> during start reads the <a href=../general_configuration>cOS configuration file</a> and allows to tweak the following:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># Tweak the package to upgrade to, or the docker image (full reference)</span>
<span style=color:#000>ELEMENTAL_UPGRADE_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span>system/cos
<span style=color:#8f5902;font-style:italic># Turn on/off channel upgrades. If disabled, UPGRADE_IMAGE should be a full reference to a container image</span>
<span style=color:#000>ELEMENTAL_CHANNEL_UPGRADES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
<span style=color:#8f5902;font-style:italic># Disable mtree verification. Enabled by default</span>
<span style=color:#000>ELEMENTAL_NO_VERIFY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
<span style=color:#8f5902;font-style:italic># Specify a separate recovery image (defaults to UPGRADE_IMAGE)</span>
<span style=color:#000>ELEMENTAL_RECOVERY_IMAGE</span><span style=color:#ce5c00;font-weight:700>=</span>recovery/cos
</code></pre></div><p><code>elemental upgrade</code> also reads its configuration from <code>/etc/cos-upgrade-image</code> if the file is present in the system.</p><p>Specifically, it allows to configure:</p><ul><li><strong>ELEMENTAL_UPGRADE_IMAGE</strong>: A container image reference ( e.g. <code>registry.io/org/image:tag</code> ) or a <code>luet</code> package ( e.g. <code>system/cos</code> )</li><li><strong>ELEMENTAL_CHANNEL_UPGRADES</strong>: Boolean indicating wether to use channel upgrades or not. If it is disabled <strong>UPGRADE_IMAGE</strong> should refer to a container image, e.g. <code>registry.io/org/image:tag</code></li><li><strong>ELEMENTAL_NO_VERIFY</strong>: Turns off or on mtree verification.</li><li><strong>ELEMENTAL_RECOVERY_IMAGE</strong>: Allows to specify a different image for the recovery partition. Similarly to <strong>UPGRADE_IMAGE</strong> needs to be either an image reference or a package.</li></ul><h2 id=changing-the-default-release-channel>Changing the default release channel</h2><p>Release channels are standard luet repositories. To change the default release channel, create a <code>/etc/luet/luet.yaml</code> configuration file pointing to a valid luet repository:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># For a full reference, see:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># https://luet-lab.github.io/docs/docs/getting-started/#configuration</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOS&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-da6b91d86be15305a06525d5ddec51fc>2.8 - GRUB</h1><div class=lead>GRUB 2 Configuration</div><p>COS is set to deploy a persistent <code>grub.cfg</code> into the <code>COS_RECOVERY</code> partition during
the system installation or image creation. COS grub configuration
includes three menu entries: first for the main OS system, second for the
fallback OS system and a third for the recovery OS.</p><p>For example the main OS system menu entry could be something like:</p><pre><code>menuentry &quot;cOS&quot; --id cos {
  search.fs_label COS_STATE root
  set img=/cOS/active.img
  set label=COS_ACTIVE
  loopback loop0 /$img
  set root=($root)
  source (loop0)/etc/cos/bootargs.cfg
  linux (loop0)$kernel $kernelcmd
  initrd (loop0)$initramfs
}
</code></pre><div class="alert alert-primary" role=alert><h4 class=alert-heading>Kernel parameters</h4>The kernel parameters are not part of the persistent <code>grub.cfg</code> file stored in <code>COS_RECOVERY</code> partition.
Kernel parameters are sourced from the loop device of the OS image to boot. This is mainly to
keep kernel parameters consistent across different potential OS images or
system upgrades.</div><h2 id=specifying-default-custom-boot-options>Specifying default custom boot options</h2><p>cOS images and its derivatives, are expected to include a
<code>/etc/cos/bootargs.cfg</code> file which provides the definition of the following
variables:</p><ul><li><code>$kernel</code>: Path of the kernel binary</li><li><code>$kernelcmd</code>: Kernel parameters</li><li><code>$initramfs</code>: Path of the initrd binary</li></ul><p>This is the mechanism any cOS image or cOS derivative has to communicate
its boot parameters (kernel, kernel params and initrd file) to GRUB2.</p><p>For example, the default cOS bootarg.cfg file is:</p><pre><code>set kernel=/boot/vmlinuz
if [ -n &quot;$recoverylabel&quot; ]; then
    # Boot arguments when the image is used as recovery
    set kernelcmd=&quot;console=tty1 root=live:CDLABEL=$recoverylabel rd.live.dir=/ rd.live.squashimg=$img panic=5&quot;
else
    # Boot arguments when the image is used as active/passive
    set kernelcmd=&quot;console=tty1 root=LABEL=$label iso-scan/filename=$img panic=5 security=selinux rd.cos.oemlabel=COS_OEM selinux=1&quot;
fi

set initramfs=/boot/initrd
</code></pre><p>You can tweak that file to suit your needs if you need to specify persistent boot arguments.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><code>rd.cos.oemlabel=COS_OEM</code> is required inside the bootargs in order to access to the <code>/oem</code> mount within the rootfs stage. <code>COS_OEM</code> is the default label for the oem partition.</div><h2 id=grub-environment-variables>Grub environment variables</h2><p>cOS (since v0.5.8) makes use of the GRUB2 environment block which can used to define
persistent GRUB2 variables across reboots.</p><p>Use <code>grub2-editenv</code> command line utility to define the desired values.</p><table><thead><tr><th>Variable</th><th>Description</th></tr></thead><tbody><tr><td>next_entry</td><td>Set the next reboot entry</td></tr><tr><td>saved_entry</td><td>Set the default boot entry</td></tr><tr><td>default_menu_entry</td><td>Set the name entries on the GRUB menu</td></tr><tr><td>extra_active_cmdline</td><td>Set additional boot commands when booting into active</td></tr><tr><td>extra_passive_cmdline</td><td>Set additional boot commands when booting into passive</td></tr><tr><td>extra_recovery_cmdline</td><td>Set additional boot commands when booting into recovery</td></tr><tr><td>extra_cmdline</td><td>Set additional boot commands for all entries</td></tr><tr><td>default_fallback</td><td>Sets default fallback logic</td></tr></tbody></table><p>For instance use the following command to reboot to recovery system only once:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>next_entry</span><span style=color:#ce5c00;font-weight:700>=</span>recovery
</code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>The examples below make of the <code>COS_OEM</code> device, however it could use any device
detected by GRUB2 that includes the file <code>/grubenv</code>. First match wins.</div><h3 id=default-boot-entry>Default boot entry</h3><p>The default grub configuration loads the <code>/grubenv</code> of any available device
and evaluates on <code>next_entry</code> variable and <code>saved_entry</code> variable. By default
none is set.</p><p>The default boot entry is set to the value of <code>saved_entry</code>, in case the variable
is not set grub just defaults to the first menu entry.</p><p><code>next_entry</code> variable can be used to overwrite the default boot entry for a single
boot. If <code>next_entry</code> variable is set this is only being used once, GRUB2 will
unset it after reading it for the first time. This is helpful to define the menu entry
to reboot to without having to make any permanent config change.</p><p>Use <code>grub2-editenv</code> command line utility to define desired values.</p><p>For instance use the following command to reboot to recovery system only once:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>next_entry</span><span style=color:#ce5c00;font-weight:700>=</span>recovery
</code></pre></div><p>Or to set the default entry to <code>fallback</code> system:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>saved_entry</span><span style=color:#ce5c00;font-weight:700>=</span>fallback
</code></pre></div><h2 id=boot-menu>Boot menu</h2><p>By default <code>cOS</code> and derivatives shows the default boot menu entry while booting (<code>cOS</code>).</p><p>The grub menu entry is generated during installation and can be configured by setting <code>GRUB_ENTRY_NAME</code> in the <a href=../general_configuration>cOS configuration file</a> inside the derivative, or either via cloud-init before installation.</p><p>For example, specifying in <code>/etc/cos/config</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>GRUB_ENTRY_NAME</span><span style=color:#ce5c00;font-weight:700>=</span>myOS
</code></pre></div><p>will automatically set the GRUB menu entries for active, passive and recovery to the specified value.</p><p>The grub menu boot entry can also be set with <code>grub2-editenv</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>default_menu_entry</span><span style=color:#ce5c00;font-weight:700>=</span>fooOS
</code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Additional menu entries</h4><p>Since</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/grub2-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/grub2-config</a></p><blockquote><p>= 0.0.14 it is possible to add multiple custom menu entries to GRUB by creating a <code>/grubmenu</code> config file in one of the available partitions detected by GRUB2 during boot. The file will be loaded from the first partition found by GRUB that have the <code>grubmenu</code> file. First match wins.
The <code>grubmenu</code> file will be sourced at the end of the boot process, and can contain several <code>menuentry</code> blocks.</p></blockquote></div><h2 id=persistent-boot-option-flags>Persistent boot option flags</h2><p>It is possible to define persistent boot flag for each menu entry also via <code>grub2-editenv</code>:</p><ul><li><code>extra_active_cmdline</code>: extra bootflags to be applied only on active boot</li><li><code>extra_passive_cmdline</code>: extra bootflags to be applied only on passive boot</li><li><code>extra_recovery_cmdline</code>: extra bootflags to be applied only on recovery</li><li><code>extra_cmdline</code>: will be applied to each boot entry</li></ul><h2 id=customizing-fallback-logic>Customizing fallback logic</h2><p>By default cOS boots into active, and if there are failures will boot into the passive, and finally if keeps failing, will boot into recovery.</p><p>It is possible to override the default fallback logic by setting <code>default_fallback</code> as grub environment, consider for example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; grub2-editenv /oem/grubenv <span style=color:#204a87>set</span> <span style=color:#000>default_fallback</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2 0 1&#34;</span>
</code></pre></div><p>Will set the default fallback to &ldquo;2 0 1&rdquo; instead of the default &ldquo;0 1 2&rdquo;.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3255a8332bd6efb004f0d49c42343f6d>2.9 - Runtime features</h1><div class=lead>Add features that can be enabled and disabled on runtime</div><p>cOS allows to (optionally) add features that can be disabled/enabled in runtime, provided by
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-features class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cos-features</a>
.</p><p><a href=../../reference/cloud_init>Cloud-init files</a> stored in <code>/system/features</code> are read by <code>cos-feature</code> and allow to interactively enable or disable them in a running system, for example:</p><pre><code>$&gt; cos-feature list

====================
cOS features list

To enable, run: cos-feature enable &lt;feature&gt;
To disable, run: cos-feature disable &lt;feature&gt;
====================

- vagrant (enabled)
- ...
...
</code></pre><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><code>/system/features</code> is the default path which can be customized in the <a href=../general_configuration>cOS configuration file</a> by specifying it with <code>COS_FEATURESDIR</code>.</div><p>By default cOS ships the <code>vagrant</code> featureset - when enabled will automatically create the default <code>vagrant</code> user which is generally used to create new Vagrant boxes.</p><p>If you don&rsquo;t need <code>cos-features</code> you can avoid installing
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-features class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cos-features</a>
, it&rsquo;s optional.</p><h2 id=adding-or-removing-features>Adding or removing features</h2><p>To either add or remove the available features, delete the relevant files in the <code>/system/features</code> folder of the derivative prior to build the <a href=../../creating-derivatives/creating_bootable_images>container image</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-5a2f2ae34ebe6581185222d4c362a1d2>3 - Creating derivatives</h1><div class=lead>Documents various methods for creating cOS derivatives</div><p>A derivative is a standard container image which can be booted by cOS.</p><p>We can identify a build phase where we build the derivative, and a &ldquo;runtime phase&rdquo; where we consume it.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vTTOJ0G4aMpdfSHv13sgPIIFCTK3SDIlcqmDxfPbGz0AlpNPTz1FTUigr-9co33c6MwXhDcead5nWFw/pub?w=1270&h=717" alt></p><p>The image is described by a Dockerfile, composed of a base OS of choice (e.g. openSUSE, Ubuntu, etc. ) and the cOS toolkit itself in order to be consumed by cOS and allow to be upgraded from by other derivatives.</p><p>cOS-toolkit then converts the OCI artifact into a bootable medium (ISO, packer, ova, etc) and the image itself then can be used to bootstrap other derivatives, which can in turn upgrade to any derivative built with cOS.</p><p>A derivative can also be later re-used again as input as base-image for downstream derivatives.</p><p>All the documentation below imply that the container image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image which are general across all the implementation:</p><ul><li>Custom persistent runtime configuration has to be provided in <code>/system/oem</code> for derivatives, <a href=../customizing/configuration_persistency>see also the documentation section</a>. Everything under <code>/system/oem</code> will be loaded during the various stages (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB, <a href=../customizing/configure_grub>see grub customization</a></li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image, <a href=../customizing/upgrades>see customizing upgrades</a></li></ul><p>Derivatives inherits <code>cOS</code> defaults, which you can override during the build process, however there are some defaults which are relevant and listed below:</p></div><div class=td-content style=page-break-before:always><h1 id=pg-392e7921a89bd32cc9ec22ec800e2673>3.1 - Package stack</h1><div class=lead>Package stack for derivatives</div><p>When building a <code>cos-toolkit</code> derivative, a common set of packages are provided already with a common default configuration. Some of the most notably are:</p><ul><li>systemd as init system</li><li>grub for boot loader</li><li>dracut for initramfs</li></ul><p>Each <code>cos-toolkit</code> flavor (opensuse, ubuntu, fedora) ships their own set of base packages depending on the distribution they are based against. You can find the list of packages in the <code>packages</code> keyword in the corresponding <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>values file for each flavor</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3e73df96cf589806ce76f765a5f51cf>3.2 - Cosign</h1><div class=lead>How we use cosign in cos-toolkit</div><p><a href=https://github.com/sigstore/cosign>Cosign</a> is a project that signs and verifies containers and stores the signatures on OCI registries.</p><p>You can check the cosign <a href=https://github.com/sigstore/cosign>github repo</a> for more information.</p><p>In cos-toolkit we sign every container that we generate as part of our publish process so the signature can be verified during package installation with luet or during deploy/upgrades from a deployed system to verify that the containers have not been altered in any way since their build.</p><p>Currently cosign provides 2 methods for signing and verifying.</p><ul><li>private/public key</li><li>keyless</li></ul><p>We use keyless signatures based on OIDC Identity tokens provided by github, so nobody has access to any private keys and can use them. (For more info about keyless signing/verification check <a href=https://github.com/sigstore/cosign/blob/main/KEYLESS.md>here</a>)</p><p>This signature generation is provided by <a href=https://github.com/rancher-sandbox/luet-cosign>luet-cosign</a> which is a luet plugin that generates the signatures on image push when building, and verifies them on package unpack when installing/upgrading/deploying.</p><p>The process is completely transparent to the end user when upgrading/deploying a running system and using our published artifacts.</p><p>When using luet-cosign as part of <code>luet install</code> you need to set <code>COSIGN_REPOSITORY=raccos/releases-green</code> and <code>COSIGN_EXPERIMENTAL=1</code> so it can find the proper signatures and use keyless verification</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Currently setting <code>COSIGN_REPOSITORY</code> value is due to quay.io not supporting OCI artifacts. It may be removed in the future and signatures stored along the artifacts.</div><h2 id=derivatives>Derivatives</h2><p>If building a derivative, you can also sign and verify you final artifacts with the use of <a href=https://github.com/rancher-sandbox/luet-cosign>luet-cosign</a>.</p><p>As keyless is only possible to do in an CI environment (as it needs an OIDC token) you would need to set up private/public signature and verification.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>If you are building and publishing your derivatives with luet on github, you can see an example on how we generate and push the keyless signatures ourselves on <a href=https://github.com/rancher-sandbox/cOS-toolkit/blob/master/.github/workflows/build-master-green-x86_64.yaml#L445>this workflow</a></div><h3 id=verify-cos-toolkit-artifacts-as-part-of-derivative-building>Verify cos-toolkit artifacts as part of derivative building</h3><p>If you consume cos-toolkit artifacts in your Dockerfile as part of building a derivative you can verify the signatures of the artifacts by setting:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_REPOSITORY</span><span style=color:#ce5c00;font-weight:700>=</span>raccos/releases-green<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_EXPERIMENTAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#204a87;font-weight:700>RUN</span> luet install -y meta/cos-verify <span style=color:#8f5902;font-style:italic># install dependencies for signature checking</span><span style=color:#a40000>
</span></code></pre></div><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>The</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-verify</a>
is a meta package that will pull</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
.</p></div><p>And then making sure you call luet with <code>--plugin luet-cosign</code>. You can see an example of this in our <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples/standard>standard Dockerfile example</a></p><p>That would verify the artifacts coming from our repository.</p><p>For signing resulting containers with a private/public key, please refer to the <a href=https://github.com/sigstore/cosign>cosign</a> documents.</p><p>For verifying with a private/public key, the only thing you need is to set the env var <code>COSIGN_PUBLIC_KEY_LOCATION</code> to point to the public key that signed and enable the luet-cosign plugin.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>Currently there is an issue in which if there is more than one repo and one of those repos is not signed the whole install will fail due to cosign failing to verify the unsigned repo.</p><p>If you are using luet with one or more unsigned repos, it&rsquo;s not possible to use cosign to verify the chain.</p><p>Please follow up in <a href=https://github.com/rancher-sandbox/luet-cosign/issues/6>https://github.com/rancher-sandbox/luet-cosign/issues/6</a> for more info.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c76daa64bd1164d9a6d538211f0fa16b>3.3 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSmIZ5FTInGjtkGonUOgwhti6DZnSoeexGmWL9CAmbdiIGtBGnzDuGNj80Lj_206hP0MOxQGpEdYFvK/pub?w=1223&h=691" alt></p><p>A derivative is a simple container image which can be processed by the cOS toolkit in order to be bootable and installable. This section describes the requirements to create a container image that can be run by <code>cOS</code>.</p><h2 id=requirements>Requirements</h2><img style=float:right src="https://docs.google.com/drawings/d/e/2PACX-1vQBfT10W88mD1bbReDmAJIOPF3tWdVHP7QE9w7W7ByOIzoKGOdh2z5YWsKf7wn8csFF_QGrDXgGsPWg/pub?w=478&h=178"><p>Bootable images are standard container images, that means the usual <code>build</code> and <code>push</code> workflow applies, and building images is also a way to persist <a href=../../customizing>oem customizations</a>.</p><p>The base image can be any Linux distribution that is compatible with our flavors.</p><p>The image needs to ship:</p><ul><li>parts of the cos-toolkit (required, see below)</li><li>kernel (required)</li><li>initrd (required)</li><li>grub (required)</li><li>dracut (optional, kernel and initrd can be consumed from the cOS repositories)</li><li>microcode (optional, not required in order to boot, but recomended)</li><li><a href=../cosign>cosign and luet-cosign</a> packages (optional, required if you want to verify the images installed by luet)</li></ul><h2 id=example>Example</h2><p>An illustrative example can be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.16.7<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3 # or Fedora, Ubuntu</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>amd64
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>ARCH</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_EXPERIMENTAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#8f5902;font-style:italic># keyless verify</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_REPOSITORY</span><span style=color:#ce5c00;font-weight:700>=</span>raccos/releases-green  <span style=color:#8f5902;font-style:italic># repo with the signatures</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y ... <span style=color:#8f5902;font-style:italic># apt-get, dnf...</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Here we install cosign and luet-cosign so we can verify that the images installed have been signed</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install -y meta/cos-verify<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># That&#39;s where we install the minimal cos-toolkit meta-package (which pulls the minimal packages needed in order to boot)</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># note that we are setting `--plugin luet-cosign` so luet verifies the correct signatures of the packages on install</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install --plugin luet-cosign -y meta/cos-minimal<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Other custom logic. E.g, customize statically the upgrade channel, default users, packages.</span><span style=color:#a40000>
</span><span style=color:#a40000></span>...<span style=color:#a40000>
</span></code></pre></div><p>In the example above, the cos-toolkit parts that are <strong>required</strong> are pulled in by <code>RUN luet install -y meta/cos-minimal</code>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-minimal class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-minimal</a>
is a meta-package that will pull
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/yip class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/yip</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/utils/installer class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> utils/installer</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-setup class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cos-setup</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/immutable-rootfs class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/immutable-rootfs</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/base-dracut-modules class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/base-dracut-modules</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/grub2-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/grub2-config</a>
,
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cloud-config class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cloud-config</a>
is optional, but provides <code>cOS</code> defaults setting, like default user/password and so on. If you are not installing it directly, an equivalent cloud-config has to be provided in order to properly boot and run a system, see <a href=../../customizing/oem_configuration>oem configuration</a>.</div><h4 id=using-cosign-in-your-derivative>Using cosign in your derivative</h4><p>The
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-verify</a>
is a meta package that will pull
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/cosign</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/toolchain/luet-cosign class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> toolchain/luet-cosign</a>
are optional packages that would install cosign and luet-cosign in order to verify the packages installed by luet.</p><p>You can use cosign to both verify that packages coming from cos-toolkit are verified and sign your own derivative artifacts</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p>If you want to manually verify cosign and luet-cosign packages before installing them with luet, you can do so by:</p><ul><li>Install <a href=https://github.com/sigstore/cosign>Cosign</a></li><li>Export the proper vars<ul><li><code>export COSIGN_EXPERIMENTAL=1</code> for keyless verify</li><li><code>export COSIGN_REPOSITORY=raccos/releases-green</code> to point cosign to the repo the signatures are stored on</li></ul></li><li>Manually verify the signatures on both packages<ul><li>Check the latest $VERSION for both packages at the repo (i.e. <code>https://quay.io/repository/costoolkit/releases-green?tab=tags</code>)</li><li><code>cosign verify quay.io/costoolkit/releases-green:luet-cosign-toolchain-$VERSION</code></li><li><code>cosign verify quay.io/costoolkit/releases-green:cosign-toolchain-$VERSION</code></li></ul></li></ul></div><p>For more info, check the <a href=../cosign>cosign</a> page.</p><h2 id=initrd>Initrd</h2><p>The image should provide at least <code>grub</code>, <code>systemd</code>, <code>dracut</code>, a kernel and an initrd. Those are the common set of packages between derivatives. See also <a href=../package_stack>package stack</a>.
By default the initrd is expected to be symlinked to <code>/boot/initrd</code> and the kernel to <code>/boot/vmlinuz</code>, otherwise you can specify a custom path while <a href=../build_iso>building an iso</a> and <a href=../../customizing/configure_grub>by customizing grub</a>.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/base-dracut-modules class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/base-dracut-modules</a>
is required to be installed with <code>luet</code> in case you are building manually the initrd from the Dockerfile and also to run <code>dracut</code> to build the initrd, the command might vary depending on the base distro which was chosen.</p><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/kernel class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/kernel</a>
and
<a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/dracut-initrd class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/dracut-initrd</a>
can also be installed if you plan to use kernels and initrd from the <code>cOS</code> repositories and don&rsquo;t build them / or install them from the official distro repositories (e.g. with <code>zypper</code>, or <code>dnf</code> or either <code>apt-get</code>&mldr;). In this case you don&rsquo;t need to generate initrd on your own, neither install the kernel coming from the base image.</p><h2 id=building>Building</h2><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vS6eRyjnjdQI7OBO0laYD6vJ2rftosmh5eAog6vk_BVj8QYGGvnZoB0K8C6Qdu7SDz7p2VTxejcZsF6/pub?w=956&h=339" alt></p><p>The workflow would be then:</p><ol><li><code>docker build</code> the image</li><li><code>docker push</code> the image to some registry</li><li><code>elemental upgrade --no-verify --docker-image $IMAGE</code> from a cOS machine or (<code>elemental reset</code> if bootstrapping a cloud image)</li></ol><p>The following can be incorporated in any standard gitops workflow.</p><p>You can explore more examples in the <a href=../../examples/creating_bootable_images>example section</a> on how to create bootable images.</p><h2 id=whats-next>What&rsquo;s next?</h2><p>Now that we have created our derivative container, we can either:</p><ul><li><a href=../build_iso>Build an iso</a></li><li><a href=../packer/build_ami>Build an Amazon Image</a></li><li><a href=../packer/build_gcp>Build a Google Cloud Image</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-77bbb84e7a296f8ceb76bccd0b101c63>3.4 - Build disk images with Elemental</h1><div class=lead>This section documents the procedure to build disk images using elemental</div><p>Requirements:</p><ul><li><code>qemu-img</code> utility</li><li><code>elemental</code> binary</li><li>elemental runtime dependencies</li></ul><p>The suggested approach is based on using the Elemental installer (<code>elemental install</code> command) to run the installation
from a Linux to a loop device. The loop device can be a raw image created with <code>qemu-img create</code> that can easily be
converted to other formats after the installation by using <code>qemu-img convert</code>.</p><h2 id=get-elemental>Get Elemental</h2><p>Elemental binary can be downloaded from the <a href=https://github.com/rancher-sandbox/elemental/releases/latest>github releases</a> page.</p><p>The golang binary can be used as is, however take into account that some linux utilities are expected to be present in the host. More
specific elemental expects to find common linux utilities to operate over block devices: rsync, parted, blkid, lsblk, udevadm, resize2fs, tune2fs, mkfs.ext2, etc.</p><h2 id=prepare-the-loop-device>Prepare the loop device</h2><p>Preparing the a loop device for the installation is simple and straight forward.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># Create a raw image of 32G</span>
&gt; qemu-img create -f raw diks.img 32G

<span style=color:#8f5902;font-style:italic># Set the disk image as a loop device</span>
&gt; sudo losetup -f --show disk.img
&lt;device&gt;
</code></pre></div><h2 id=run-elemental-installation>Run elemental installation</h2><p>Execute the elemental installation as described in TODO:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; sudo elemental install --force-efi --docker-image &lt;image&gt; &lt;device&gt;
</code></pre></div><p>Where <code>&lt;image></code> is the cOS derivative container image we want to use for the disk creation and <code>&lt;device></code> is the
loop device previously created with <code>losetup</code> (e.g. <code>/dev/loop0</code>).</p><h2 id=convert-the-raw-image-to-desired-format>Convert the RAW image to desired format</h2><p>Once the installation is done just unsetting the loop device and converting the image to the desired format is missing:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># Unset the loop device</span>
&gt; sudo losetup -d &lt;device&gt;

<span style=color:#8f5902;font-style:italic># Convert the RAW image to qcow2</span>
&gt; qemu-img convert -f raw -O qcow2 disk.img disk.qcow2
</code></pre></div><p>QEMU supports a wide range of formats including common ones such as <code>vdi</code>, <code>vmdk</code> or <code>vhdx</code>.</p><p>The result can be easily tested on QEMU with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt; qemu -m <span style=color:#0000cf;font-weight:700>4096</span> -hda disk.qcow2 -bios /usr/share/qemu/ovmf-x86_64.bin
</code></pre></div><p>Note the firmware image path varies depending on the host distro, the path provided in this example is based on openSUSE Leap.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1c4b24f482e46235525d199eb0414f03>3.5 - Build ISOs</h1><div class=lead>Build ISOs from bootable images</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vReZtyNs0imrji-AwnqK0-4ekCKLcKzfnQ_CwiMj93Q7IsycAJHwlNohwCv_hyHnaify7qO-v2Cecg5/pub?w=1223&h=691" alt></p><p>In order to build an iso at the moment of writing, we first rely on <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a>. It accepts a YAML file denoting the packages to bundle in an ISO and a list of luet repositories where to download the packages from.</p><p>To build an iso, just run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -v <span style=color:#000>$PWD</span>:/cOS -v /var/run:/var/run --entrypoint /usr/bin/luet-makeiso -ti --rm quay.io/costoolkit/toolchain ./iso.yaml --image <span style=color:#000>$IMAGE</span>
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--image $IMAGE</code> is the container image you want to build the ISO for, you might want to check on <a href=../creating_bootable_images>how to build bootable images</a>.</p><p>An example of a yaml file using the cos-toolkit opensuse repositories and syslinux:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>system/cos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/systemd-boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/syslinux</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>An example using GRUB instead:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=whats-next>What&rsquo;s next?</h2><ul><li>Check out on how to <a href=../packer/build_images>build a QCOW, Virtualbox or Vagrant image</a> from the ISO we have just created</li></ul><h2 id=syntax>Syntax</h2><p>Below you can find a full reference about the yaml file format.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># (optional) Packages to be installed in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the uefi image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/systemd-boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/boot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># Packages to be installed in the isoimage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/syslinux</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify initramfs/kernel and avoid generation on-the-fly</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># files must be present on /boot folder in the rootfs</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/uefi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/path/to/additional/efi/files&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Specify a container remote image to pull and use for the rootfs in place of packages (optional)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rootfs_image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ubuntu:latest&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Image prefix. If Image date is disabled is used as the full title.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;MYOS-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># Luet repositories (https://luet-lab.github.io/docs/docs/getting-started/#configuration-in-etcluetreposconfd) to use.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Flags:</p><ul><li><strong>local</strong>: Path to local luet repository to use to install packages from</li><li><strong>image</strong>: Optional image to use as rootfs</li></ul><h2 id=configuration-reference>Configuration reference</h2><h3 id=rootfs_image><code>rootfs_image</code></h3><p>A container image reference (e.g. <code>quay.io/.../...:latest</code>) that will be used as a rootfs for the ISO.</p><h3 id=packagesrootfs><code>packages.rootfs</code></h3><p>A list of luet packages to install in the rootfs. The rootfs will be squashed to a <code>rootfs.squashfs</code> file</p><h3 id=packagesuefi><code>packages.uefi</code></h3><p>A list of luet packages to be present in the efi ISO sector.</p><h3 id=packagesisoimage><code>packages.isoimage</code></h3><p>A list of luet packages to be present in the ISO image.</p><h3 id=repositorypackages><code>repository.packages</code></h3><p>A list of package repository (e.g. <code>repository/mocaccino-extra</code>) to be installed before <code>luet install</code> commands Requirements</p><h3 id=initramfskernel_file><code>initramfs.kernel_file</code></h3><p>The kernel file under <code>/boot/</code> that is your running kernel. e.g. <code>vmlinuz</code> or <code>bzImage</code></p><h3 id=initramfsrootfs_file><code>initramfs.rootfs_file</code></h3><p>The initrd file under <code>/boot/</code> that has all the utils for the initramfs</p><h3 id=image_prefix><code>image_prefix</code></h3><p>ISO image prefix to use</p><h3 id=image_date><code>image_date</code></h3><p>Boolean indicating if the output image name has to contain the date</p><h3 id=image_name><code>image_name</code></h3><p>A string representing the ISO final image name</p><h3 id=arch><code>arch</code></h3><p>A string representing the arch. Defaults to <code>x86_64</code>.</p><h3 id=luetconfig><code>luet.config</code></h3><p>Path to the luet config to use to install the packages from</p><h3 id=overlayisoimage><code>overlay.isoimage</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the ISO (before generating the ISO file).</p><h3 id=overlayuefi><code>overlay.uefi</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the UEFI partition (before generating the image).</p><h3 id=overlayrootfs><code>overlay.rootfs</code></h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;dir&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Path to a folder which content will be copied over the rootfs (before generating squashfs).</p><h2 id=customize-bootloader-with-grub>Customize bootloader with GRUB</h2><p>Beside syslinux, the ISO boot menu can also be built with GRUB.</p><p>Boot menu and other bootloader parameters can then be easily customized by using the overlay parameters within the ISO config yaml manifest.</p><p>Assuming the ISO being built includes:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># The following are required in order to build an ISO with GRUB</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic># as bootloader</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>We can customize either the <code>isoimage</code> packages (in the referrence image <code>live/grub2</code> package
includes bootloader configuration) or make use of the overlay concept to include or
overwrite addition files for <code>isoimage</code> section.</p><p>Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>system/cos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>overlay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>overlay/iso</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>With the above the ISO will also include the files under <code>overlay/iso</code> path. To customize the boot
menu parameters consider copy and modify relevant files from <code>live/grub2</code> package. In this example the
<code>overlay</code> folder files list could be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># isoimage files for grub2 boot</span>
boot/grub2/grub.cfg
</code></pre></div><p>Being <code>boot/grub2/grub.cfg</code> a custom grub2 configuration including custom boot menu entries. Consider the following <code>grub.cfg</code> example:</p><pre><code>search --file --set=root /boot/kernel.xz
set default=0
set timeout=10
set timeout_style=menu
set linux=linux
set initrd=initrd
if [ &quot;${grub_cpu}&quot; = &quot;x86_64&quot; -o &quot;${grub_cpu}&quot; = &quot;i386&quot; ];then
    if [ &quot;${grub_platform}&quot; = &quot;efi&quot; ]; then
        set linux=linuxefi
        set initrd=initrdefi
    fi
fi

set font=($root)/boot/x86_64/loader/grub2/fonts/unicode.pf2
if [ -f ${font} ];then
    loadfont ${font}
fi

menuentry &quot;Custom grub2 menu entry&quot; --class os --unrestricted {
    echo Loading kernel...
    $linux ($root)/boot/kernel.xz cdroot root=live:CDLABEL=COS_LIVE rd.live.dir=/ rd.live.squashimg=rootfs.squashfs console=tty1 console=ttyS0 rd.cos.disable
    echo Loading initrd...
    $initrd ($root)/boot/rootfs.xz
}
</code></pre><h2 id=separate-recovery>Separate recovery</h2><p>To make an ISO with a separate recovery image as squashfs, you can either use the default from <code>cOS</code>, by adding it in the iso yaml file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>recovery/cos-img</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The installer will detect the squashfs file in the iso, and will use it when installing the system. You can customize the recovery image as well by providing your own: see the <code>recovery/cos-img</code> package definition as a reference.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a79e4c2576797b293b9be51f953489dd>3.6 - Building images with Packer</h1><div class=lead>Building VBox, OVA, QEMU, etc. images of your derivative with Packer</div><img style=display:block;margin-left:auto;margin-right:auto;width:50% src="https://docs.google.com/drawings/d/e/2PACX-1vTOn0fYAI589csRoONln7aCttWWNyUc2DvEUt9Dw6tys4nzyearrIUaCXYpg6lknli16z_Kz1N-ugxK/pub?w=507&h=217"><p>For Vagrant Boxes, OVA and QEMU images at the moment we are relying on <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>packer templates</a>.</p><p>The cOS vanilla images can be used as input to Packer to deploy pristine images of the user container image with <a href=../../getting-started/deploy>elemental reset</a>.</p></div><div class=td-content><h1 id=pg-3919e113335b9645a5bc90d158baa902>3.6.1 - Build AMI machines for AWS</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in AWS public cloud provider by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>AWS access keys with the appropriate roles and permissions</li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to AWS of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an AMI image in AWS based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the AWS credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an AMI. In such case the lastest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_ACCESS_KEY_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_SECRET_ACCESS_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_secret_access_key&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AWS_DEFAULT_REGION</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_aws_default_region&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only amazon-ebs.cos .
</code></pre></div><p>AWS keys can be passed as environment variables as it is above or packer
picks them from aws-cli configuration files (<code>~/.aws</code>) if any. Alternatively,
one can define them in the variables file.</p><p>The <code>-only amazon-ebs.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;aws_cos_deploy_args&#34;: &#34;elemental reset&#34;,
</span><span style=color:#4e9a06>    &#34;aws_launch_volume_size&#34;: 16,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only amazon-ebs.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the AMI Vanilla image on a 16GiB disk and calls the
command <code>elemental reset</code> to deploy the main OS, once deployed an snapshot is
created and an AMI out this snapshot is registered in EC2. The created
AMI artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>aws_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>elemental reset</code> which will deploy the cOS image from the recovery partition.
To deploy custom derivatives something like
<code>elemental reset --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>aws_launch_volume_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>aws_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>aws_source_ami_filter_name</code>: This a filter to choose the AMI image for the
build process. It defaults to <code>*cOS*Vanilla*</code> pattern to pick the latest cOS
Vanilla image available.</p></li><li><p><code>aws_temporary_security_group_source_cidr</code>: A IPv4 CIDR to be authorized access to the instance,
when packer is creating a temporary security group. Defaults to &ldquo;0.0.0.0/0&rdquo;.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a82f6f67abbcb7970be348f1f92320a3>3.6.2 - Build Azure images</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in Azure public cloud provider by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Azure access keys with the appropriate roles and permissions</li><li><a href=../../../getting-started/booting/#importing-an-azure-image-manually>A Vanilla image</a></li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to Azure of cOS derivatives or cOS itself. For all the details
and possibilities of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an image in Azure based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the Azure credentials
and run a <code>packer build</code> process to trigger the deployment and register the
resulting snapshot as an image. In such case the latest cOS image will be
deployed and configured with pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_CLIENT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_client_id&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_TENANT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_tenant_id&gt; 
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_CLIENT_SECRET</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_client_secret&gt;
&gt; <span style=color:#204a87>export</span> <span style=color:#000>AZURE_SUBSCRIPTION_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_azure_subscription_id&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only azure-arm.cos .
</code></pre></div><p>The <code>-only azure-arm.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code> and <code>virtualbox</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired variables. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;azure_location&#34;: &#34;westeurope&#34;,
</span><span style=color:#4e9a06>    &#34;azure_os_disk_size_gb&#34;: 16,
</span><span style=color:#4e9a06>    &#34;azure_vm_size&#34;: &#34;Standard_B2s&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only azure-arm.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the Vanilla image on a 16GiB disk and calls the
command <code>elemental reset</code> to deploy the main OS and once deployed an image
is created from the running instance.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>azure_</code> prefix are the ones related to the Azure Packer
template. These are some of the relevant ones:</p><ul><li><p><code>azure_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>elemental reset</code> which will deploy the cOS image from the recovery partition.
To deploy custom derivatives something like
<code>elemental reset --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>azure_custom_managed_image_name</code>: Name of a custom managed image to use for your
base image.</p></li><li><p><code>azure_custom_managed_image_resource_group_name</code>: Name of a custom managed image&rsquo;s
resource group to use for your base image.</p></li><li><p><code>azure_os_disk_size_gb</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>azure_vm_size</code>: Sets the size of the instance being launched. Defaults to Standard_B2s</p></li><li><p><code>azure_user_data_file</code>: This sets the user-data file that will be used for the
azure instance during the build process. It defaults to <code>user-data/azure.yaml</code> and
the default file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li></ul><div class="pageinfo pageinfo-primary"><p>The current version of packer (1.7.4) doesn&rsquo;t have any support for user-data so currently is
not possible to automate the deployment with packer correctly.
Have a look at <a href=https://github.com/hashicorp/packer/blob/master/CHANGELOG.md>packer changelog</a> to be informed when
user-data is supported.</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-053d994238218800fd0349937370b515>3.6.3 - Build Images for Google Compute Platform</h1><div class=lead>This section documents the procedure to deploy cOS (or derivatives) images in Google Compute Platform by using the cOS Vanilla image.</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSqJWcFThP7K2HS551LCqs73l4ZncXElLjlbCvxY96Ga2Jbjnq79j-DEjaccUZvYEQyphWiDQc9flxk/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Google Compute Packer <a href=https://www.packer.io/docs/builders/googlecompute>plugin</a></li><li><a href=https://cloud.google.com/sdk/docs/install>Google Cloud SDK</a></li><li>A Vanilla AMI</li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using Packer templates to customize the
deployment and automate the upload and publish to GCP of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><p>There are no cOS Vanilla images publicly available in GCP, however they can be easily
build or downloaded and published to your working GCP project. See <a href=../../../development/build_raw_images/>Build Raw Images</a> and
<a href=../../../getting-started/booting/#importing-a-google-cloud-image-manually>Importing a Google Cloud image manually</a> to see how to upload a Vanilla image in your project.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>Publishing an image in GCP based on top of the latest cOS Vanilla image is
fairly simple. In fact, it is only needed to set the <a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
for GCP and the GCP project ID and then run a <code>packer build</code> process to
trigger the deployment and register the resulting snapshot as an image.
In such case the lastest cOS image will be deployed and configured with
pure defaults. Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>export</span> <span style=color:#000>GCP_PROJECT_ID</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;your_gcp_project_id&gt;

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -only gcp.cos .
</code></pre></div><p>Packer authenticates automatically if the
<a href=https://www.packer.io/docs/builders/googlecompute#running-locally-on-your-workstation>User Application Default Credentials</a>
are properly set in the host.</p><p>The <code>-only gcp.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>qemu</code>, <code>virtualbox</code> and <code>amazon-ebs</code>.</p><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;gcp_project_id&#34;: &#34;&lt;your_gcp_project&gt;&#34;
</span><span style=color:#4e9a06>    &#34;gcp_cos_deploy_args&#34;: &#34;elemental reset --docker-image &lt;my-custom-image&gt;&#34;,
</span><span style=color:#4e9a06>    &#34;gcp_disk_size&#34;: 20,
</span><span style=color:#4e9a06>    &#34;name&#34;: &#34;MyTest&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only gcp.cos -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the cOS Vanilla image on a 20GB disk and calls the
command <code>elemental reset</code> to deploy the main OS, once deployed an snapshot is
created and published as an image in Google Compute Engine. The created
artifact will be called <code>MyTest</code>, the name has no impact in the underlaying
OS.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
variables with the <code>aws_</code> prefix are the ones related to the AWS Packer
template. These are some of the relevant ones:</p><ul><li><p><code>gcp_project_id</code>: The project ID that will be used to launch instances and
store images.</p></li><li><p><code>gcp_cos_deploy_args</code>: This the command that will be executed once the
Vanilla image booted. In this stage it is expected that user sets a command
to install the desired cOS or derivative image. By default it is set to
<code>elemental reset</code> which will deploy the cOS image from the recovery partition.
To deploy custom derivatives something like
<code>elemental reset --docker-image &lt;my-derivative-img-ref></code> should be sufficient.</p></li><li><p><code>gcp_disk_size</code>: This sets the disk size of the VM that Packer
launches for the build. During Vanilla image first boot the system will
expand to the disk geometry. The layout is configurable with the user-data.</p></li><li><p><code>gcp_user_data_file</code>: This sets the user-data file that will be used for the
aws instance during the build process. It defaults to <code>aws/setup-disk.yaml</code> and
the defauklt file basically includes the disk expansion configuration. It
adds a <code>COS_STATE</code> partition that should be big enough to store about three times
the size of the image to deploy. Then it also creates a <code>COS_PERSISTENT</code>
partition with all the rest of the available space in disk.</p></li><li><p><code>gcp_source_image_family</code>: This the family to choose the image for the
build process. It defaults to <code>cos-vanilla</code> to pick the latest cOS
Vanilla image available. Note Packer tries to find the image family first
in the given working project (<code>gcp_project_id</code>).</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d123bd2dce21a42b3c3ca4afc4f353ad>3.6.4 - Build QCOW, VirtualBox and Vagrant images</h1><div class=lead>This section documents the procedure to build a custom QCOW, VirtualBox and a Vagrant images with the cOS packer templates</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vT-ZugVPCUCffRbfko-tOoTyRIpqjtgvQgQn74lckTZCjMLIakEJKRPwyjFL7tGEmKE8DDMVSZBEZ9u/pub?w=1223&h=691" alt></p><p>Requirements:</p><ul><li>Packer</li><li>Either qemu or VirtualBox functioning in the build host</li><li>a cOS or a <a href=../../build_iso>custom ISO</a></li><li><a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a></li></ul><p>The suggested approach is based on using <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packer>Packer templates</a> to customize the
deployment and automate creation of QCOW, Virtualbox and Vagrant images of cOS derivatives or cOS itself. For all the details
and possibilties of Packer check the <a href=https://www.packer.io/guides/hcl>official documentation</a>.</p><h2 id=run-the-build-with-packer>Run the build with Packer</h2><p>To build QCOW and VirtualBox images an ISO file is required. You can either <a href=../../../getting-started/download>Download</a> a cOS ISO or <a href=../../build_iso>build your own from a container image</a>.</p><h3 id=qcow2>QCOW2</h3><p>Consider:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only qemu.cos .
</code></pre></div><p>The process should end up by building a <code>.box</code> file (vagrant image) and a <code>.tar.gz</code> file (containing the raw disk) in the same folder:</p><pre><code>...
==&gt; qemu.cos (compress): Using pgzip compression with 8 cores for cOS_green_dev_amd64.tar.gz
==&gt; qemu.cos (compress): Tarring cOS_green_dev_amd64.tar.gz with pgzip
==&gt; qemu.cos (compress): Archive cOS_green_dev_amd64.tar.gz completed
Build 'qemu.cos' finished after 4 minutes 34 seconds.

==&gt; Wait completed after 4 minutes 34 seconds

==&gt; Builds finished. The artifacts of successful builds are:
--&gt; qemu.cos: 'libvirt' provider box: cOS_green_dev_amd64.box
--&gt; qemu.cos: compressed artifacts in: cOS_green_dev_amd64.tar.gz

&gt; ubuntu@jumpbox:~/cOS-toolkit/packer$ ls -liah
total 2.3G
 516552 drwxrwxr-x  4 ubuntu ubuntu 4.0K Jul 30 07:54 .
 516207 drwxrwxr-x 14 ubuntu ubuntu 4.0K Jul 30 07:41 ..
 516362 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.box
 516385 -rw-r--r--  1 root   root   1.2G Jul 30 07:54 cOS_green_dev_amd64.tar.gz
 516553 -rw-rw-r--  1 ubuntu ubuntu  389 Jun 28 08:07 config.yaml
 516339 -rw-rw-r--  1 ubuntu ubuntu 6.5K Jul 30 07:41 images.json.pkr.hcl
1818463 drwxrwxr-x  3 ubuntu ubuntu 4.0K Jul 30 07:49 packer_cache
1818400 drwxrwxr-x  2 ubuntu ubuntu 4.0K Jul 30 07:41 user-data
 516555 -rw-rw-r--  1 ubuntu ubuntu  606 Jun 28 08:07 vagrant.yaml
 516340 -rw-rw-r--  1 ubuntu ubuntu 6.1K Jul 30 07:41 variables.pkr.hcl
ubuntu@jumpbox:~/cOS-toolkit/packer$ 
</code></pre><p>The <code>-only qemu.cos</code> flag is just to tell packer which of the sources
to make use for the build. Note the <code>packer/images.json.pkr.hcl</code> file defines
few other sources such as <code>amazon-ebs</code> and <code>virtualbox-iso</code>.</p><h3 id=virtualbox>Virtualbox</h3><p>Similarly, to build OVA images we run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h3 id=vagrant>Vagrant</h3><p>To build vagrant images, we enable the <code>vagrant</code> feature, which allows the <code>vagrant</code> user to login afterwards:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the root of a cOS-toolkit repository checkout</span>

&gt; <span style=color:#204a87>cd</span> packer
&gt; packer build -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var <span style=color:#4e9a06>&#34;feature=vagrant&#34;</span> -only virtualbox-iso.cos .
</code></pre></div><h2 id=customize-the-build-with-a-variables-file>Customize the build with a variables file</h2><p>The packer template can be customized with the variables defined in
<code>packer/variables.pkr.hcl</code>. These are the variables that can be set on run
time using the <code>-var key=value</code> or <code>-var-file=path</code> flags. The variable file
can be a json file including desired varibles. Consider the following example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># From the packer folder of the cOS-toolkit repository checkout</span>

&gt; cat <span style=color:#4e9a06>&lt;&lt; EOF &gt; test.json
</span><span style=color:#4e9a06>{
</span><span style=color:#4e9a06>    &#34;root_username&#34;: &#34;root&#34;,
</span><span style=color:#4e9a06>    &#34;root_password&#34;: &#34;cos&#34;
</span><span style=color:#4e9a06>}
</span><span style=color:#4e9a06>EOF</span>

&gt; packer build -only qemu.cos -var <span style=color:#4e9a06>&#34;iso=/path/to/image.iso&#34;</span> -var-file<span style=color:#ce5c00;font-weight:700>=</span>test.json .
</code></pre></div><p>The above example runs the build by logging with a different username/password to run the installation.</p><h3 id=default-cloud-init>Default cloud-init</h3><p>In the packer folder there is present a <code>config.yaml</code> file which can be used to customize the image. The file is in <a href=../../../references/cloud-init>cloud-init</a> style and will be automatically installed by default when running <code>elemental install</code>.</p><h3 id=available-variables-for-customization>Available variables for customization</h3><p>All the customizable variables are listed in <code>packer/variables.pkr.hcl</code>,
these are some of the relevant ones:</p><ul><li><p><code>build</code>,<code>flavor</code>,<code>arch</code>: This to personalize the artifact output name. The artifact output format is
<code>"cOS_${var.flavor}_${var.build}_${var.arch}.tar.gz"</code></p></li><li><p><code>disk_size</code>: This sets the disk size to be used for the image. It is 50000 by default, and expressed in MB.</p></li><li><p><code>memory</code>: RAM to allocate to the VM in MB.</p></li><li><p><code>cpu</code>: Number of processors of the VM</p></li><li><p><code>accelerator</code>: Accelerator type, see the <a href=https://www.packer.io/docs/builders/qemu#accelerator>official docs</a></p></li><li><p><code>root_username</code>: Username used to login via ssh, it needs root permissions to be able to run the installation process and call <code>elemental install</code></p></li><li><p><code>root_password</code>: Password for the user specified in <code>root_username</code></p></li><li><p><code>feature</code>: Enable/Disables specific <code>cOS</code> features.</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fb0f854c53f1ba28ad4c2ccf8d24df34>4 - Examples</h1><div class=lead>Examples and recipes for building cOS derivatives</div></div><div class=td-content><h1 id=pg-69286228d8129cf393e95a7cae077086>4.1 - Creating bootable images</h1><div class=lead>This document describes the requirements to create standard container images that can be used for <code>cOS</code> deployments</div><p>You can find the examples below in the <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/examples>examples</a> folder.</p><h2 id=from-standard-images>From standard images</h2><p>Besides using the <code>cos-toolkit</code> toolchain, it&rsquo;s possible to create standard container images which are consumable by the vanilla <code>cOS</code> images (ISO, Cloud Images, etc.) during the upgrade and deploy phase.</p><p>An example of a Dockerfile image can be:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.20.6<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_EXPERIMENTAL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>COSIGN_REPOSITORY</span><span style=color:#ce5c00;font-weight:700>=</span>raccos/releases-green<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>amd64
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>ARCH</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    bash-completion <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    conntrack-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    coreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    curl <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    device-mapper <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dosfstools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dracut <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    e2fsprogs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    findutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gawk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gptfdisk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-i386-pc <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-x86_64-efi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    haveged <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iproute2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iptables <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iputils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    issue-generator <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    jq <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-default <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-bnx2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-i915 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-intel <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-iwlwifi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-mellanox <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-network <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-platform <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-realtek <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    less <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lsscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lvm2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    mdadm <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    multipath-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nano <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nfs-utils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-iscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-vm-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    parted <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    pigz <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    policycoreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    procps <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    python-azure-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    qemu-guest-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rng-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rsync <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    squashfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    strace <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd-sysvinit <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    tar <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    timezone <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    vim <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    which<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy the luet config file pointing to the upgrade repository</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> conf/luet.yaml /etc/luet/luet.yaml<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy luet from the official images</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>luet /usr/bin/luet /usr/bin/luet<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install -y meta/cos-verify<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install --plugin luet-cosign -y meta/cos-minimal <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    utils/k9s <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    utils/nerdctl<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> files/ /<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkinitrd<span style=color:#a40000>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/Dockerfile</a></i></small><hr><p>While the config file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i></small><hr><p>We can just run docker to build the image with</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t <span style=color:#000>$IMAGE</span> .
</code></pre></div><p>The important piece is that an image needs to ship at least:</p><pre><code>toolchain/yip
utils/installer
system/cos-setup
system/immutable-rootfs
system/grub2-config
</code></pre><p>from the toolchain. If you want to customize further the container further add more step afterwards <code>luet install</code> see <a href=../../customizing>the customizing section</a>.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>Depending on the base image (<code>FROM opensuse/leap:15.3</code> in the sample), you must set the corresponding repository for each flavor <a href=../../getting-started/download#releases>see releases</a> in the luet config file ( which in the sample above points to the <em>green</em> releases )</div><h2 id=generating-from-ci-image>Generating from CI image</h2><p>Derivatives can be stacked on top of another, so it is possible to reuse directly also the vanilla cOS images:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#8f5902;font-style:italic># Pick one version from https://quay.io/repository/costoolkit/releases-green?tab=tags</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/costoolkit/releases-green:cos-system-0.5.8-4</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> files/ /<span style=color:#a40000>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/cos-official/Dockerfile</a></i></small><hr><p>The images contains already the toolkit, so they can be used as-is and apply further customization on top.</p><h2 id=from-scratch>From scratch</h2><p>The luet image <code>quay.io/luet/base</code> contains just luet, and can be used to boostrap the base system from scratch:</p><p>conf/luet.yaml:<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/conf/luet.yaml</a></i></small><hr></p><p>Dockerfile:<div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.20.6<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3 AS ca</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> scratch</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy luet from the official images</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>luet /usr/bin/luet /usr/bin/luet<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>ca /etc/ssl/certs/. /etc/ssl/certs/<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy the luet config file pointing to the cOS repository</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ADD</span> conf/luet.yaml /etc/luet/luet.yaml<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>USER</span><span style=color:#ce5c00;font-weight:700>=</span>root
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>LUET_NOLOCK</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
<span style=color:#204a87;font-weight:700>SHELL</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/usr/bin/luet&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;install&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-y&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-d&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> system/cos-container<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>SHELL</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/bin/sh&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;-c&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> rm -rf /var/cache/luet/packages/ /var/cache/luet/repos/<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>TMPDIR</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENTRYPOINT</span> <span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;/bin/sh&#34;</span><span style=color:#000;font-weight:700>]</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/scratch/Dockerfile</a></i></small><hr></p><h2 id=customizations>Customizations</h2><p>All the method above imply that the image generated will be the booting one, there are however several configuration entrypoint that you should keep in mind while building the image:</p><ul><li>Everything under <code>/system/oem</code> will be loaded during the various stage (boot, network, initramfs). You can check <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/e411d8b3f0044edffc6fafa39f3097b471ef46bc/packages/cloud-config/oem>here</a> for the <code>cOS</code> defaults. See <code>00_rootfs.yaml</code> to customize the booting layout.</li><li><code>/etc/cos/bootargs.cfg</code> contains the booting options required to boot the image with GRUB</li><li><code>/etc/cos-upgrade-image</code> contains the default upgrade configuration for recovery and the booting system image</li></ul><h2 id=configuration-file>Configuration file</h2><p>The example configuration file shows how to enable the cos-toolkit repository:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i></small><hr><p>Repositories have the following fields, notably:</p><ul><li><code>name</code>: Repository name</li><li><code>enable</code>: Enable/disables the repository</li><li><code>arch</code>: (optional) Denotes the arch repository. If present, it will enable the repository automatically if the corresponding arch is matching with the host running <code>luet</code>. <code>enable: true</code> would override this behavior</li><li><code>reference</code>: (optional) A reference to a repository index file to use to retrieve the repository metadata instead of latest. This can be used to point to a different or an older repository index to act as a &ldquo;wayback machine&rdquo;. The client will consume the repository state from that snapshot instead of latest.</li></ul><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>The <code>reference</code> field has to be a valid tag. For example, for the <code>green</code> flavor, browse the relevant <a href="https://quay.io/repository/costoolkit/releases-green?tab=tags">container image list page</a>. The repository index snapshots are prefixed with a timestamp, and ending in <code>repository.yaml</code>. For example <code>20211027153653-repository.yaml</code></div></div><div class=td-content style=page-break-before:always><h1 id=pg-87fa66e8f5fb02335e3eb5b85600fc0f>4.2 - Creating embedded images</h1><div class=lead>This document is a step-by-step guide to build a customized embedded system that can be used in cOS</div><p>This guide will guide in a step-by-step process to build a derivative which is fully compatible with cOS, and will illustrate how to make customization on such image, by adding for example a default set of services and a custom user.</p><p>The derivative will be based on openSUSE and embed k3s, and a custom user <code>joe</code> which will be already set to allow us to login.</p><h2 id=prerequisites>Prerequisites</h2><ul><li>Docker installed</li></ul><h2 id=1-create-a-dockerfile>1) Create a Dockerfile</h2><p>Let&rsquo;s create a workspace directory and move into it:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; mkdir derivative
$&gt; <span style=color:#204a87>cd</span> derivative
</code></pre></div><p>Let&rsquo;s create now a <code>Dockerfile</code> for our image inside that directory, which will be represent running system:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#8f5902;font-style:italic># Let&#39;s copy over luet from official images. </span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># This version will be used to bootstrap luet itself and cOS internal components</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>LUET_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>.16.7<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> quay.io/luet/base:$LUET_VERSION AS luet</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> opensuse/leap:15.3</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>K3S_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.20.4+k3s1<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ARG</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span>amd64
<span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>ARCH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>ARCH</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install packages from the base image</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    bash-completion <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    conntrack-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    coreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    curl <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    device-mapper <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dosfstools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    dracut <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    e2fsprogs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    findutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gawk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    gptfdisk <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-i386-pc <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    grub2-x86_64-efi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    haveged <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iproute2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iptables <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    iputils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    issue-generator <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    jq <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-default <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-bnx2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-i915 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-intel <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-iwlwifi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-mellanox <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-network <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-platform <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    kernel-firmware-realtek <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    less <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lsscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    lvm2 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    mdadm <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    multipath-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nano <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    nfs-utils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-iscsi <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    open-vm-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    parted <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    pigz <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    policycoreutils <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    procps <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    python-azure-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    qemu-guest-agent <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rng-tools <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rsync <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    squashfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    strace <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    systemd-sysvinit <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    tar <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    timezone <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    vim <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    which<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy the luet config file pointing to the upgrade repository</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> repositories.yaml /etc/luet/luet.yaml<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy luet from the official images</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> --from<span style=color:#ce5c00;font-weight:700>=</span>luet /usr/bin/luet /usr/bin/luet<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> luet install -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       toolchain/yip <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       toolchain/luet <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       utils/installer <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/cos-setup <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/immutable-rootfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/grub2-config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/base-dracut-modules<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Install k3s server/agent</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>ENV</span> <span style=color:#000>INSTALL_K3S_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>K3S_VERSION</span><span style=color:#4e9a06>}</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> curl -sfL https://get.k3s.io &gt; installer.sh <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#000>INSTALL_K3S_SKIP_START</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#000>INSTALL_K3S_SKIP_ENABLE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> sh installer.sh <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    <span style=color:#000>INSTALL_K3S_SKIP_START</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#000>INSTALL_K3S_SKIP_ENABLE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> sh installer.sh agent <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    rm -rf installer.sh<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic>## System layout</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Required by k3s etc.</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkdir /usr/libexec <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> touch /usr/libexec/.keep<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy custom files</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># COPY files/ /</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy cloud-init default configuration</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> cloud-init.yaml /system/oem/<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Generate initrd</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> mkinitrd<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># OS level configuration</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;VERSION=999&#34;</span> &gt; /etc/os-release<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;GRUB_ENTRY_NAME=derivative&#34;</span> &gt;&gt; /etc/os-release<span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;welcome to our derivative&#34;</span> &gt;&gt; /etc/issue.d/01-derivative<span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#8f5902;font-style:italic># Copy cloud-init default configuration</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> cloud-init.yaml /system/oem/<span style=color:#a40000>
</span></code></pre></div><p>Create then <code>repositories.yaml</code> in <code>derivative/repositories.yaml</code> with the following content:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>logging</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>color</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable_emoji</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>general</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>debug</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>spinner_charset</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cOS official&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;docker&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cached</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>priority</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>verify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#4e9a06>&#34;quay.io/costoolkit/releases-green&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><small><i class="fab fa-github"></i> <i>Complete source code: <a target=_blank href=https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml>https://github.com/rancher-sandbox/cos-toolkit/blob/master/examples/standard/conf/luet.yaml</a></i></small><hr><h2 id=2-configuration>2) Configuration</h2><p>At the end of the Dockerfile, you can see that we copy over a custom <a href=../../reference/cloud_init>cloud-init</a> file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#8f5902;font-style:italic># Copy cloud-init default configuration</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>COPY</span> cloud-init.yaml /system/oem/<span style=color:#a40000>
</span></code></pre></div><p>Create a <code>cloud-init.yaml</code> file as the <code>derivative/cloud-init.yaml</code> with the following content:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># See https://rancher-sandbox.github.io/cos-toolkit-docs/docs/reference/cloud_init/ for a full syntax reference</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default settings&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Setup default hostname</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Branding&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;derivative&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Setup an admin group with sudo access</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup groups&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>ensure_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            kind: &#34;group&#34;
</span><span style=color:#8f5902;font-style:italic>            group_name: &#34;admin&#34;
</span><span style=color:#8f5902;font-style:italic>            password: &#34;x&#34;
</span><span style=color:#8f5902;font-style:italic>            gid: 900</span><span style=color:#f8f8f8;text-decoration:underline>            
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Setup network - openSUSE specific</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Network setup&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/sysconfig/network/ifcfg-eth0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  BOOTPROTO=&#39;dhcp&#39;
</span><span style=color:#8f5902;font-style:italic>                  STARTMODE=&#39;onboot&#39;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0600</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Setup a custom user</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># Replace the default user name here and settings</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>joe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#8f5902;font-style:italic># Comment passwd for no password</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;joe&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>shell</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/bin/bash</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>homedir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/home/joe&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#4e9a06>&#34;admin&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic>#authorized_keys:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># Replace here with your ssh keys</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># joe: </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># - ssh-rsa ....</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Setup sudo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup sudo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/sudoers&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permsisions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0600</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            Defaults always_set_home
</span><span style=color:#8f5902;font-style:italic>            Defaults secure_path=&#34;/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/bin:/usr/local/sbin&#34;
</span><span style=color:#8f5902;font-style:italic>            Defaults env_reset
</span><span style=color:#8f5902;font-style:italic>            Defaults env_keep = &#34;LANG LC_ADDRESS LC_CTYPE LC_COLLATE LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES LC_MONETARY LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE LC_ATIME LC_ALL LANGUAGE LINGUAS XDG_SESSION_COOKIE&#34;
</span><span style=color:#8f5902;font-style:italic>            Defaults !insults
</span><span style=color:#8f5902;font-style:italic>            root ALL=(ALL) ALL
</span><span style=color:#8f5902;font-style:italic>            %admin ALL=(ALL) NOPASSWD: ALL
</span><span style=color:#8f5902;font-style:italic>            @includedir /etc/sudoers.d</span><span style=color:#f8f8f8;text-decoration:underline>            
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>passwd -l root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># Setup persistency so k3s works properly</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># See also: https://rancher-sandbox.github.io/cos-toolkit-docs/docs/reference/immutable_rootfs/#configuration-with-an-environment-file</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Immutable Layout configuration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>RW_PATHS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/var /etc /srv&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>PERSISTENT_STATE_PATHS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>&gt;-</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>          /etc/systemd
</span><span style=color:#8f5902;font-style:italic>          /etc/rancher
</span><span style=color:#8f5902;font-style:italic>          /etc/ssh
</span><span style=color:#8f5902;font-style:italic>          /etc/iscsi 
</span><span style=color:#8f5902;font-style:italic>          /etc/cni
</span><span style=color:#8f5902;font-style:italic>          /home
</span><span style=color:#8f5902;font-style:italic>          /opt
</span><span style=color:#8f5902;font-style:italic>          /root
</span><span style=color:#8f5902;font-style:italic>          /usr/libexec
</span><span style=color:#8f5902;font-style:italic>          /var/log
</span><span style=color:#8f5902;font-style:italic>          /var/lib/rancher
</span><span style=color:#8f5902;font-style:italic>          /var/lib/kubelet
</span><span style=color:#8f5902;font-style:italic>          /var/lib/wicked
</span><span style=color:#8f5902;font-style:italic>          /var/lib/longhorn
</span><span style=color:#8f5902;font-style:italic>          /var/lib/cni</span><span style=color:#f8f8f8;text-decoration:underline>          
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>PERSISTENT_STATE_BIND</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># Finally, let&#39;s start k3s when network is available, and download the SSH key from github for the joe user</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Start k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>k3s</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Replace here with your ssh keys or github handle</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>joe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>github:mudler</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Done! We are now ready to build the Docker container.</p><p>The file structure should be like the following:</p><pre><code>$&gt; tree ./derivative
derivative
├── cloud-init.yaml
├── Dockerfile
├── iso.yaml
└── repositories.yaml
</code></pre><h2 id=3-build-it>3) Build it!</h2><p>Now we are ready to build our docker image:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$~/derivative&gt; docker build -t derivative:latest .
...
 ---&gt; Running in a9c33b42f567                              
Removing intermediate container a9c33b42f567                                                                           
 ---&gt; 8e83191d29df                                                                                                     
Step 19/19 : COPY cloud-init.yaml /system/oem/                                                                         
 ---&gt; 38cc4c8b173a                                                                                                     
Successfully built 38cc4c8b173a                                                                                        
Successfully tagged derivative:latest
</code></pre></div><p>After the process completed, we are ready to consume our docker image. If you push the image over a container registry, you can then or use a running <code>cOS</code> system to upgrade to it, or deploy it directly <a href=../../getting-started>see getting started</a>.</p><h3 id=build-an-iso-image>Build an ISO image</h3><p>We can at this point also create a ISO from it.</p><p>Create a <code>iso.yaml</code> file with the following content inside the <code>derivative</code> folder:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uefi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>isoimage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>live/grub2-efi-image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/eltorito.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>boot_catalog</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/boot.catalog&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>isohybrid_mbr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;boot/x86_64/loader/boot_hybrid.img&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>initramfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kernel_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;vmlinuz&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;initrd&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_prefix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;derivative-0.&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>image_date</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_LIVE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>luet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>repositories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cOS</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>urls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>quay.io/costoolkit/releases-green</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>docker</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Now, we can build the ISO with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$~/derivative&gt; docker run -v <span style=color:#000>$PWD</span>:/cOS -v /var/run:/var/run --entrypoint /usr/bin/luet-makeiso -ti --rm quay.io/costoolkit/toolchain ./iso.yaml --image derivative:latest
....
INFO<span style=color:#ce5c00;font-weight:700>[</span>0114<span style=color:#ce5c00;font-weight:700>]</span> Copying BIOS kernels                       
INFO<span style=color:#ce5c00;font-weight:700>[</span>0114<span style=color:#ce5c00;font-weight:700>]</span> Create squashfs                            
Parallel mksquashfs: Using <span style=color:#0000cf;font-weight:700>8</span> processors
Creating 4.0 filesystem on /tmp/luet-geniso4082786464/tempISO/rootfs.squashfs, block size 1048576.
....
INFO<span style=color:#ce5c00;font-weight:700>[</span>0247<span style=color:#ce5c00;font-weight:700>]</span> 🍹 Generate ISO derivative-0.20210909.iso     
xorriso 1.4.6 : RockRidge filesystem manipulator, libburnia project.

Drive current: -outdev <span style=color:#4e9a06>&#39;stdio:derivative-0.20210909.iso&#39;</span>
Media current: stdio file, overwriteable
Media status : is blank
Media summary: <span style=color:#0000cf;font-weight:700>0</span> sessions, <span style=color:#0000cf;font-weight:700>0</span> data blocks, <span style=color:#0000cf;font-weight:700>0</span> data,  448g free
Added to ISO image: directory <span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;/tmp/luet-geniso4082786464/tempISO&#39;</span>
xorriso : UPDATE : <span style=color:#0000cf;font-weight:700>599</span> files added in <span style=color:#0000cf;font-weight:700>1</span> seconds
xorriso : UPDATE : <span style=color:#0000cf;font-weight:700>599</span> files added in <span style=color:#0000cf;font-weight:700>1</span> seconds
xorriso : NOTE : Copying to System Area: <span style=color:#0000cf;font-weight:700>512</span> bytes from file <span style=color:#4e9a06>&#39;/tmp/luet-geniso4082786464/tempISO/boot/x86_64/loader/boot_hybrid.img&#39;</span>
xorriso : WARNING : Boot image load size exceeds <span style=color:#0000cf;font-weight:700>65535</span> blocks of <span style=color:#0000cf;font-weight:700>512</span> bytes. Will record <span style=color:#0000cf;font-weight:700>0</span> in El Torito to extend ESP to end-of-medium.
libisofs: NOTE : Aligned image size to cylinder size by <span style=color:#0000cf;font-weight:700>137</span> blocks
xorriso : UPDATE :  12.35% <span style=color:#204a87;font-weight:700>done</span>
xorriso : UPDATE :  42.73% <span style=color:#204a87;font-weight:700>done</span>
ISO image produced: <span style=color:#0000cf;font-weight:700>282624</span> sectors
Written to medium : <span style=color:#0000cf;font-weight:700>282624</span> sectors at LBA <span style=color:#0000cf;font-weight:700>0</span>
Writing to <span style=color:#4e9a06>&#39;stdio:derivative-0.20210909.iso&#39;</span> completed successfully.
</code></pre></div><p>After the process completes, we should have a ISO in our folder ready to be used. See the <a href=../../creating-derivatives/build_iso>build ISOs section</a> for all the available options.</p><h2 id=customization>Customization</h2><p>Here follows a break down of the steps above</p><h3 id=adding-packages>Adding packages</h3><p>Feel free to edit the Dockerfile with the packages you want to embed in our image. You can install any packages available in the openSUSE repositories by
tweaking</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#8f5902;font-style:italic># Install packages from the base image</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> zypper in -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>    .... <span style=color:#8f5902;font-style:italic># Add more packages here!</span><span style=color:#a40000>
</span></code></pre></div><h3 id=repositories-configuration>Repositories configuration</h3><p>We copy the configuration file of <code>luet</code> which just points to cOS repositories with:</p><pre><code># Copy the luet config file pointing to the upgrade repository
COPY repositories.yaml /etc/luet/luet.yaml
</code></pre><p>The config file should point to the <code>green</code> <a href=../../getting-started/download#releases>flavor</a> as our derivative will be based on opensuse. It should point to <code>blue</code>, or <code>orange</code> instead if building against Fedora or Ubuntu.</p><h3 id=cos-toolkit>cOS toolkit</h3><p>We install packages from the cOS toolkit with <code>luet</code>. In this case we pick the basic ones that allows us to install/upgrade immutable cOS derivatives:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=color:#204a87;font-weight:700>RUN</span> luet install -y <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       toolchain/yip <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       toolchain/luet <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       utils/installer <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/cos-setup <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/immutable-rootfs <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/grub2-config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>       system/base-dracut-modules<span style=color:#a40000>
</span></code></pre></div><p>You can check all the available packages <a href=https://cos-toolkit.herokuapp.com/cos-toolkit-green>here</a>, and you can learn more about this in our <a href=../../creating-derivatives>Creating Derivatives section</a>.</p><h3 id=system-layout-and-k3s>System layout and k3s</h3><p>We set some default layouts and install k3s:</p><pre><code># Install k3s server/agent
ENV INSTALL_K3S_VERSION=${K3S_VERSION}
RUN curl -sfL https://get.k3s.io &gt; installer.sh &amp;&amp; \
    INSTALL_K3S_SKIP_START=&quot;true&quot; INSTALL_K3S_SKIP_ENABLE=&quot;true&quot; sh installer.sh &amp;&amp; \
    INSTALL_K3S_SKIP_START=&quot;true&quot; INSTALL_K3S_SKIP_ENABLE=&quot;true&quot; sh installer.sh agent &amp;&amp; \
    rm -rf installer.sh

## System layout

# Required by k3s etc.
RUN mkdir /usr/libexec &amp;&amp; touch /usr/libexec/.keep

# Copy custom files
# COPY files/ /

# Generate initrd
RUN mkinitrd

# OS level configuration
RUN echo &quot;VERSION=999&quot; &gt; /etc/os-release
RUN echo &quot;GRUB_ENTRY_NAME=derivative&quot; &gt;&gt; /etc/os-release
RUN echo &quot;welcome to our derivative&quot; &gt;&gt; /etc/issue.d/01-derivative
</code></pre><p>As our target here is to install <code>k3s</code> we do install both k3s <code>agent</code> and <code>server</code>, so the image can work in both modes. Here we could have installed any service or binary that we want to embed in our container image. We setup the system layout by creating needed paths for <code>k3s</code> and set up a os-release which identifies the OS version. Afterward we regenerate the initrd which is required in order to boot, <a href=../../creating-derivatives/creating_bootable_images/#initrd>see also the Initrd section</a>.</p><h3 id=cloud-init-custom-ssh-access>Cloud-init, custom SSH access</h3><p>The <code>cloud-init.yaml</code> file above configures a user, <code>joe</code> and attaches a ssh key to it in order to login. It also sets up a default password, which is optional.</p><p>To specify any additional ssh key installed within the user, we do:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>joe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>github:mudler</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>which you can replace with your github handle, or by specifying directly an ssh key. In case you specify the SSH key directly, you don&rsquo;t need to run the step in the <code>network</code> stage.</p><p>The user will be part of the <code>admin</code> group which is allowed to use <code>sudo</code>.</p><p>As our target is to run <code>k3s</code>, but could have been any other service, we tweak the immutable setup by specifying sensible path required for <code>k3s</code> in order to function properly, see <a href=../../reference/immutable_rootfs>immutable rootfs</a> for all the available options.</p><p>Finally, we start k3s. Note, we could have tweaked that part slightly to provide <code>k3s</code> configurations via systemd env files, or boot up for example the agent instead of the server:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#8f5902;font-style:italic># Setup environment file for custom k3s arguments</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/systemd/system/k3s.service.env&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>k3s</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>        </span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#000>chmod 600 /etc/systemd/system/k3s.service.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=references>References</h2><p>You can find the complete example <a href=https://github.com/mudler/c3os>here</a> where this article was made from.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8dbd4e302cd86a4d0f71f71ce3b300de>5 - Tutorials</h1><div class=lead>cOS tutorials and real life use-case samples</div></div><div class=td-content><h1 id=pg-d57b80651f0651da95da0184bb71b5ba>5.1 - K3s + Fleet</h1><div class=lead>Running k3s and Fleet on a cOS vanilla raw image</div><p>This is a work in progress example of how to deploy K3S + Fleet + System Uprade Controller over a cOS vanilla image only
by using cloud-init yaml configuration files. The config file reproduced here is meant to be included
as a user-data in a cloud provider (aws, gcp, azure, etc) or as part of a cdrom (cOS-Recovery will try to fetch <code>/userdata</code> file
from a cdrom device).</p><p>A vanilla image is an image that only provides the cOS-Recovery system on a <code>COS_RECOVERY</code> partition. It does not include any other
system and it is meant to be dumped to a bigger disk and deploy a cOS system or a derivative system over the free space in disk.
COS vanilla images are build as part of the CI workflow, see CI artifacts to download one of those.</p><p>The configuration file of this example has two purposes: first it deploys cOS, second in reboots on the deployed OS and deploys
K3S + Fleet + System Upgrades Controller.</p><p>On first boot it will fail to boot cOS grub menu entry and fallback
to cOS-Recovery system. From there it will partition the vanilla image to create the main system partition (<code>COS_STATE</code>)
and add an extra partition for persistent data (<code>COS_PERSISTENT</code>). It will use the full disk, a disk of at least 20GiB
is recommended. After partitioning it will deploy the main system on <code>COS_STATE</code> and reboot to it.</p><p>On consequent boots it will simply boot from <code>COS_STATE</code>, there it prepares the persistent areas of the system (arranges few bind
mounts inside <code>COS_PERSISTENT</code>) and then it runs an standard installation of K3s, Fleet and System Upgrade Controller. After few
minutes after the system is up the K3s cluster is up and running.</p><p>Note this setup similar to the <a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample>derivative example</a> using Fleet.
The main difference is that this example does not require to build any image, it is pure cloud-init configuration based.</p><h3 id=user-data-configuration-file>User data configuration file</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Default deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>rootfs.after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart image&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label or part label (filesystem label matches first)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_RECOVERY</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_STATE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># 15Gb for COS_STATE, so the disk should have, at least, 20Gb</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>15360</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>state</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>COS_PERSISTENT</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># unset size or 0 size means all available space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>persistent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Persistent state&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>RW_PATHS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/var /etc /srv&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>PERSISTENT_STATE_PATHS</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/root /opt /home /var/lib/rancher /var/lib/kubelet /etc/systemd /etc/rancher /etc/ssh&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network.before</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup SSH keys&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>root</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># It can download ssh key from remote places, such as github user keys (e.g. `github:my_user`)</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>my_custom_ssh_key</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Fleet deployment&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/k3s/manifests/fleet-config.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>              apiVersion: helm.cattle.io/v1
</span><span style=color:#8f5902;font-style:italic>              kind: HelmChart
</span><span style=color:#8f5902;font-style:italic>              metadata:
</span><span style=color:#8f5902;font-style:italic>                name: fleet-crd
</span><span style=color:#8f5902;font-style:italic>                namespace: kube-system
</span><span style=color:#8f5902;font-style:italic>              spec:
</span><span style=color:#8f5902;font-style:italic>                chart: https://github.com/rancher/fleet/releases/download/v0.3.3/fleet-crd-0.3.3.tgz
</span><span style=color:#8f5902;font-style:italic>              ---
</span><span style=color:#8f5902;font-style:italic>              apiVersion: helm.cattle.io/v1
</span><span style=color:#8f5902;font-style:italic>              kind: HelmChart
</span><span style=color:#8f5902;font-style:italic>              metadata:
</span><span style=color:#8f5902;font-style:italic>                name: fleet
</span><span style=color:#8f5902;font-style:italic>                namespace: kube-system
</span><span style=color:#8f5902;font-style:italic>              spec:
</span><span style=color:#8f5902;font-style:italic>                chart: https://github.com/rancher/fleet/releases/download/v0.3.3/fleet-0.3.3.tgz</span><span style=color:#f8f8f8;text-decoration:underline>              
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Deploy cos-system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Deploys the recovery image.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># use --docker-image to deploy a custom image</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># e.g. `elemental reset --docker-image quay.io/my_custom_repo:my_image`</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>elemental reset --reboot</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>if</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;[ ! -f &#34;/run/cos/recovery_mode&#34; ]&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup k3s&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>directories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/usr/local/bin&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0755</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>            curl -sfL https://get.k3s.io | \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_VERSION=&#34;v1.20.4+k3s1&#34; \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_EXEC=&#34;--tls-san {{.Values.node.hostname}}&#34; \
</span><span style=color:#8f5902;font-style:italic>            INSTALL_K3S_SELINUX_WARN=&#34;true&#34; \
</span><span style=color:#8f5902;font-style:italic>            sh -
</span><span style=color:#8f5902;font-style:italic>            # Install fleet 
</span><span style=color:#8f5902;font-style:italic>            kubectl apply -f /etc/k3s/manifests/fleet-config.yaml
</span><span style=color:#8f5902;font-style:italic>            # Install system-upgrade-controller
</span><span style=color:#8f5902;font-style:italic>            kubectl apply -f https://raw.githubusercontent.com/rancher/system-upgrade-controller/v0.6.2/manifests/system-upgrade-controller.yaml</span><span style=color:#f8f8f8;text-decoration:underline>            
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7f6aed5f776c4254888a6bcd3e601087>5.2 - Trigger upgrades with K3s and Fleet</h1><div class=lead>Using fleet to trigger upgradeson cOS based derivatives</div><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQPv9TI3D95vocG7oCHmVmNuuvBYuc2_0kaxAc6xnCBM9mFTnUTFIIDkzZKUFFP-xyw2Hg4q9XhxLD8/pub?w=1185&h=712" alt></p><p>In this tutorial we will:</p><ol><li>Build a custom OS image to deploy in our cluster</li><li>Setup a cluster with cOS, k3s and fleet</li><li>Upgrade the cluster to our custom OS image with fleet</li></ol><p><a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample/>This repository</a> contains the full example code.</p><h2 id=1-build-the-os-image>1) Build the OS image</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># IMAGE=quay.io/costoolkit/test-images:fleet-sample</span>
<span style=color:#8f5902;font-style:italic># cd os</span>
<span style=color:#8f5902;font-style:italic># docker build -t $IMAGE .</span>
</code></pre></div><h2 id=2-push-the-docker-image>2) Push the docker image</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># docker push $IMAGE</span>
</code></pre></div><h2 id=3-prepare-a-cos-vm>3) Prepare a cOS VM</h2><p>Download an ISO, or a qcow image from the Github artifacts of cOS. Or generate an iso of the image (check <a href=https://github.com/mudler/os2>here</a> for another example).</p><p>If deploying on AWS/openstack/Cloud, use the <code>fleet-cloud-init.yaml</code> file as userdata. If deploying on baremetal/VMs, place <code>fleet-cloud-init.yaml</code> in <code>/oem</code> after install (or run the installer with <code>elemental install --cloud-init https://raw.githubusercontent.com/rancher-sandbox/cos-fleet-upgrades-sample/main/fleet-cloud-init.yaml $DEVICE</code>).</p><p>Reboot, after some bootstraping time (check until all pods are running with <code>watch kubectl get pods -A</code>), you should have a k3s cluster with fleet and <a href=https://github.com/rancher/system-upgrade-controller>system-upgrade-controller</a> deployed.</p><h2 id=4-upgrade-with-fleet>4) Upgrade with fleet</h2><p>Add your fleet repository to the fleet cluster:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat &gt; example.yaml &lt;&lt; <span style=color:#4e9a06>&#34;EOF&#34;</span>
apiVersion: fleet.cattle.io/v1alpha1
kind: GitRepo
metadata:
  name: upgrade
  <span style=color:#8f5902;font-style:italic># This namespace is special and auto-wired to deploy to the local cluster</span>
  namespace: fleet-local
spec:
  <span style=color:#8f5902;font-style:italic># Everything from this repo will be ran in this cluster. You trust me right?</span>
  repo: <span style=color:#4e9a06>&#34;https://github.com/rancher-sandbox/cos-fleet-upgrades-sample&#34;</span>
  branch: <span style=color:#4e9a06>&#34;main&#34;</span>
  paths:
  - manifests
EOF

kubectl apply -f example.yaml
</code></pre></div><p>An example of how to trigger an upgrade with fleet is in <code>manifests/upgrade.yaml</code>. Edit the image with the one generated in the previous steps, and commit it to your <strong>fleet repository</strong>, At this point you should see the upgrade job to kick-in, the system will reboot afterwards.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8df6ea6904416b571ff9bc73afb50933>6 - Reference</h1><div class=lead>References for cOS derivatives, like common featuresets, high level architecture</div><ul><li><a href=https://github.com/mudler/cOS/projects/1>Github project</a> for a short-term Roadmap</li></ul><h3 id=samples-repositories>Samples repositories</h3><ul><li><a href=https://github.com/rancher-sandbox/cos-fleet-upgrades-sample>Build a derivative and upgrade it with fleet</a></li></ul></div><div class=td-content><h1 id=pg-533eb9e0a241df35bd13c7d531fc6bd3>6.1 - Cloud-init support</h1><div class=lead>Features inherited by cOS derivatives that are also available in the cOS vanilla images</div><p>Below is a reference of all keys available in the cloud-init style files.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># &#34;network&#34; is the stage where network is expected to be up</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># It is called internally when network is available from </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic># the cos-setup-network unit.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>network</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># Here there are a list of </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#8f5902;font-style:italic># steps to be run in the network stage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Some setup happening&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/tmp/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    </span><span style=color:#f8f8f8;text-decoration:underline>                    </span><span style=color:#000>test</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0777</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#000>echo &#34;test&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>nvidia</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>debug.exception-trace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>baz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mask</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foobar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#4e9a06>&#34;github:mudler&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#4e9a06>&#34;ssh-rsa ....&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>dns</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/resolv.conf</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>nameservers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>8.8.8.8</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>ensure_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;pass&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>delete_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;pass&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;aws&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;digitalocean&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/cloud-data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>The default cloud-config format is split into <em>stages</em> (<em>initramfs</em>, <em>boot</em>, <em>network</em>, <em>initramfs</em>, <em>reconcile</em>, called generically <strong>STAGE_ID</strong> below) <a href=../customizing/stages>see also stages</a> that are emitted internally during the various phases by calling <code>cos-setup STAGE_ID</code>.
<em>steps</em> (<strong>STEP_NAME</strong> below) defined for each stage are executed in order.</p><p>Each cloud-config file is loaded and executed only at the apprioriate stage, this allows further components to emit their own stages at the desired time.</p><div class="pageinfo pageinfo-primary"><p>The <a href=https://github.com/mudler/yip#readme>cloud-init tool</a> can be also run standalone, this helps debugging locally and also during development, you can find separate <a href=https://github.com/mudler/yip/releases/tag/0.9.6>releases here</a>, or just run it with docker:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#4e9a06>&lt;&lt;EOF | docker run -i --rm quay.io/costoolkit/releases-green:cos-recovery-0.6.0 yip -s test -
</span><span style=color:#4e9a06>stages:
</span><span style=color:#4e9a06> test:
</span><span style=color:#4e9a06> - commands:
</span><span style=color:#4e9a06>   - echo &#34;test&#34;
</span><span style=color:#4e9a06>EOF</span>
</code></pre></div></div><p><em>Note</em>: Each cloud-init option can be either run in <em>dot notation</em> ( e.g. <code>stages.network[0].authorized_keys.user=github:user</code> ) in the boot args or either can supply a cloud-init URL at boot with the <code>cos.setup=$URL</code> parameter.</p><h3 id=using-templates>Using templates</h3><p>With Cloud Init support, templates can be used to allow dynamic configuration. More information about templates can be found <a href=https://github.com/mudler/yip#node-data-interpolation>here</a> and also <a href=http://masterminds.github.io/sprig/>here for sprig</a> functions.</p><h3 id=compatibility-with-cloud-init-format>Compatibility with Cloud Init format</h3><p>A subset of the official <a href=http://cloudinit.readthedocs.org/en/latest/topics/format.html#cloud-config-data>cloud-config spec</a> is implemented.</p><p>If a yaml file starts with <code>#cloud-config</code> it is parsed as a standard cloud-init and automatically associated it to the <code>boot</code> stage. For example:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic>#cloud-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>growpart</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>auto</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>devices</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;/&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>lock_passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;1002&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ssh_authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>faaapploo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>ssh_authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#000>asdd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>runcmd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>write_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>b64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>CiMgVGhpcyBmaWxlIGNvbnRyb2xzIHRoZSBzdGF0ZSBvZiBTRUxpbnV4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/foo/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0644&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Is executed at boot, by using the standard <code>cloud-config</code> format.</p><h3 id=stagesstage_idstep_namename><code>stages.STAGE_ID.STEP_NAME.name</code></h3><p>A description of the stage step. Used only when printing output to console.</p><h3 id=stagesstage_idstep_namefiles><code>stages.STAGE_ID.STEP_NAME.files</code></h3><p>A list of files to write to disk.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/tmp/bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>content</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                    #!/bin/sh
</span><span style=color:#8f5902;font-style:italic>                    echo &#34;test&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                    
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0777</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedirectories><code>stages.STAGE_ID.STEP_NAME.directories</code></h3><p>A list of directories to be created on disk. Runs before <code>files</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup folders&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>directories</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/foo&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>permissions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0600</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedns><code>stages.STAGE_ID.STEP_NAME.dns</code></h3><p>A way to configure the <code>/etc/resolv.conf</code> file.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup dns&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>dns</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>nameservers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>8.8.8.8</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#0000cf;font-weight:700>1.1.1.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>search</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>foo.bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/resolv.conf.bak&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namehostname><code>stages.STAGE_ID.STEP_NAME.hostname</code></h3><p>A string representing the machine hostname. It sets it in the running system, updates <code>/etc/hostname</code> and adds the new hostname to <code>/etc/hosts</code>.
Templates can be used to allow dynamic configuration. For example in mass-install scenario it could be needed (and easier) to specify hostnames for multiple machines from a single cloud-init config file.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup hostname&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>hostname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;node-{{ trunc 4 .MachineID }}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namesysctl><code>stages.STAGE_ID.STEP_NAME.sysctl</code></h3><p>Kernel configuration. It sets <code>/proc/sys/&lt;key></code> accordingly, similarly to <code>sysctl</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup exception trace&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>debug.exception-trace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameauthorized_keys><code>stages.STAGE_ID.STEP_NAME.authorized_keys</code></h3><p>A list of SSH authorized keys that should be added for each user.
SSH keys can be obtained from GitHub user accounts by using the format github:${USERNAME}, similarly for Gitlab with gitlab:${USERNAME}.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup exception trace&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>authorized_keys</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mudler</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>github:mudler</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#204a87;font-weight:700>ssh-rsa</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namenode><code>stages.STAGE_ID.STEP_NAME.node</code></h3><p>If defined, the node hostname where this stage has to run, otherwise it skips the execution. The node can be also a regexp in the Golang format.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup logging&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bastion&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameusers><code>stages.STAGE_ID.STEP_NAME.users</code></h3><p>A map of users and user info to set. Passwords can be also encrypted.</p><p>The <code>users</code> parameter adds or modifies the specified list of users. Each user is an object which consists of the following fields. Each field is optional and of type string unless otherwise noted.
In case the user is already existing, the entry is ignored.</p><ul><li><strong>name</strong>: Required. Login name of user</li><li><strong>gecos</strong>: GECOS comment of user</li><li><strong>passwd</strong>: Hash of the password to use for this user. Unencrypted strings are supported too.</li><li><strong>homedir</strong>: User&rsquo;s home directory. Defaults to /home/<em>name</em></li><li><strong>no-create-home</strong>: Boolean. Skip home directory creation.</li><li><strong>primary-group</strong>: Default group for the user. Defaults to a new group created named after the user.</li><li><strong>groups</strong>: Add user to these additional groups</li><li><strong>no-user-group</strong>: Boolean. Skip default group creation.</li><li><strong>ssh-authorized-keys</strong>: List of public SSH keys to authorize for this user</li><li><strong>system</strong>: Create the user as a system user. No home directory will be created.</li><li><strong>no-log-init</strong>: Boolean. Skip initialization of lastlog and faillog databases.</li><li><strong>shell</strong>: User&rsquo;s login shell.</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>bastion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>passwd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;strongpassword&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>homedir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&#34;/home/foo</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameensure_entities><code>stages.STAGE_ID.STEP_NAME.ensure_entities</code></h3><p>A <code>user</code> or a <code>group</code> in the <a href=https://github.com/mudler/entities>entity</a> format to be configured in the system</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>ensure_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;x&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span></code></pre></div><h3 id=stagesstage_idstep_namedelete_entities><code>stages.STAGE_ID.STEP_NAME.delete_entities</code></h3><p>A <code>user</code> or a <code>group</code> in the <a href=https://github.com/mudler/entities>entity</a> format to be pruned from the system</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>delete_entities</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/etc/passwd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>entity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>                  kind: &#34;user&#34;
</span><span style=color:#8f5902;font-style:italic>                  username: &#34;foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  password: &#34;x&#34;
</span><span style=color:#8f5902;font-style:italic>                  uid: 0
</span><span style=color:#8f5902;font-style:italic>                  gid: 0
</span><span style=color:#8f5902;font-style:italic>                  info: &#34;Foo!&#34;
</span><span style=color:#8f5902;font-style:italic>                  homedir: &#34;/home/foo&#34;
</span><span style=color:#8f5902;font-style:italic>                  shell: &#34;/bin/bash&#34;</span><span style=color:#f8f8f8;text-decoration:underline>                  
</span></code></pre></div><h3 id=stagesstage_idstep_namemodules><code>stages.STAGE_ID.STEP_NAME.modules</code></h3><p>A list of kernel modules to load.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span>- <span style=color:#000>nvidia</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namesystemctl><code>stages.STAGE_ID.STEP_NAME.systemctl</code></h3><p>A list of systemd services to <code>enable</code>, <code>disable</code>, <code>mask</code> or <code>start</code>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>systemd-timesyncd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>cronie</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>mask</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>purge-kernels</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>disable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>crond</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>start</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span>- <span style=color:#000>cronie</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameenvironment><code>stages.STAGE_ID.STEP_NAME.environment</code></h3><p>A map of variables to write in <code>/etc/environment</code>, or otherwise specified in <code>environment_file</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nameenvironment_file><code>stages.STAGE_ID.STEP_NAME.environment_file</code></h3><p>A string to specify where to set the environment file</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup users&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/home/user/.envrc&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>FOO</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;bar&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_nametimesyncd><code>stages.STAGE_ID.STEP_NAME.timesyncd</code></h3><p>Sets the <code>systemd-timesyncd</code> daemon file (<code>/etc/system/timesyncd.conf</code>) file accordingly. The documentation for <code>timesyncd</code> and all the options can be found <a href=https://www.freedesktop.org/software/systemd/man/timesyncd.conf.html>here</a>.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup NTP&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>systemctl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>enable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>systemd-timesyncd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>timesyncd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>NTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0.pool.org foo.pool.org&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>FallbackNTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namecommands><code>stages.STAGE_ID.STEP_NAME.commands</code></h3><p>A list of arbitrary commands to run after file writes and directory creation.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Setup something&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>commands</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#000>echo 1 &gt; /bar</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namedatasource><code>stages.STAGE_ID.STEP_NAME.datasource</code></h3><p>Sets to fetch user data from the specified cloud providers. It populates
provider specific data into <code>/run/config</code> folder and the custom user data
is stored into the provided path.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Fetch cloud provider&#39;s user data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>providers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;aws&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span>- <span style=color:#4e9a06>&#34;digitalocean&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/etc/cloud-data&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=stagesstage_idstep_namelayout><code>stages.STAGE_ID.STEP_NAME.layout</code></h3><p>Sets additional partitions on disk free space, if any, and/or expands the last
partition. All sizes are expressed in MiB only and default value of <code>size: 0</code>
means all available free space in disk. This plugin is useful to be used in
oem images where the default partitions might not suit the actual disk geometry.</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>stages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Repart disk&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>       </span><span style=color:#204a87;font-weight:700>layout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>device</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># It will partition a device including the given filesystem label</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># or partition label (filesystem label matches first) or the device</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># provided in &#39;path&#39;. The label check has precedence over path when</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#8f5902;font-style:italic># both are provided.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_RECOVERY&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;/dev/sda&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># Only last partition can be expanded and it happens before any other</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#8f5902;font-style:italic># partition is added. size: 0 means all available free space</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>expand_partition</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4096</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>         </span><span style=color:#204a87;font-weight:700>add_partitions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_STATE&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># No partition label is applied if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>pLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;state&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>           </span>- <span style=color:#204a87;font-weight:700>fsLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;COS_PERSISTENT&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#8f5902;font-style:italic># default filesystem is ext2 if omitted</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>             </span><span style=color:#204a87;font-weight:700>filesystem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;ext4&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-64a39672b943eab91a6153baf2fc487f>6.2 - SELinux</h1><div class=lead>Build SELinux policies with cOS</div><p>You can create a sample policy by using <code>audit2allow</code> after running some
basic operations in permissive mode using system default policies. <code>allow2audit</code>
translates audit messages into allow/dontaudit SELinux policies which can be later
compiled as a SELinux module. This is the approach used in this illustration
example and mostly follows <code>audit2allow</code> <a href=https://linux.die.net/man/1/audit2allow>man pages</a>.</p><p>Once you have generated your policy (<code>mypolicy.te</code>) you can create a selinux package (create a new folder with <code>build.yaml</code>, <code>definition.yaml</code> and <code>mypolicy.te</code>) like so:</p><p>build.yaml:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;selinux-policies&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>MODULE_NAME=mypolicy</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>sed -i &#34;s|^SELINUX=.*|SELINUX=permissive|g&#34; /etc/selinux/config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>rm -rf /.autorelabel</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>checkmodule -M -m -o ${MODULE_NAME}.mod ${MODULE_NAME}.te &amp;&amp; semodule_package -o ${MODULE_NAME}.pp -m ${MODULE_NAME}.mod</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>semodule -i ${MODULE_NAME}.pp</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>definition.yaml:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;policy&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;selinux&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>0.0.1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>Example mypolicy.te (generated with <code>audit2alllow</code>)</p><pre><code>#==== cOS SELinux targeted policy module ========
#
# Disclaimer: This module is definition is for illustration use only. It
# has no guarantees of completeness, accuracy and usefulness. It should
# not be used &quot;as is&quot;.
# 


module epinioOS 1.0;

require {
	type init_t;
	type audisp_t;
	type getty_t;
	type unconfined_t;
	type initrc_t;
	type bin_t;
	type tmpfs_t;
	type wicked_t;
	type systemd_logind_t;
	type sshd_t;
	type lib_t;
	type unlabeled_t;
	type chkpwd_t;
	type unconfined_service_t;
	type usr_t;
	type local_login_t;
	type cert_t;
	type system_dbusd_t;
	class lnk_file read;
	class file { execmod getattr open read };
	class dir { getattr read search watch };
}

#============= audisp_t ==============
allow audisp_t tmpfs_t:lnk_file read;

#============= chkpwd_t ==============
allow chkpwd_t tmpfs_t:file { getattr open read };

#============= getty_t ==============
allow getty_t tmpfs_t:file { getattr open read };

#============= init_t ==============
allow init_t cert_t:dir watch;
allow init_t usr_t:dir watch;

#============= initrc_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow initrc_t bin_t:file execmod;

#============= local_login_t ==============
allow local_login_t tmpfs_t:file { getattr open read };
allow local_login_t tmpfs_t:lnk_file read;

#============= sshd_t ==============
allow sshd_t tmpfs_t:lnk_file read;

#============= system_dbusd_t ==============
allow system_dbusd_t lib_t:dir watch;
allow system_dbusd_t tmpfs_t:lnk_file read;

#============= systemd_logind_t ==============
allow systemd_logind_t unlabeled_t:dir { getattr search };

#============= unconfined_service_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow unconfined_service_t bin_t:file execmod;

#============= unconfined_t ==============

#!!!! This avc can be allowed using the boolean 'selinuxuser_execmod'
allow unconfined_t bin_t:file execmod;

#============= wicked_t ==============
allow wicked_t tmpfs_t:dir read;
allow wicked_t tmpfs_t:file { getattr open read };
allow wicked_t tmpfs_t:lnk_file read;
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-bd2c7a111cdf07391221b169f69faaa1>6.3 - Known issues</h1><div class=lead>This document encompasses known issues while building cOS and cOS derivatives.</div><p>When building cOS or a cOS derivative, you could face different issues, this section provides a description of the most known ones, and way to workaround them.</p><h3 id=building-selinux-fails>Building SELinux fails</h3><p><code>cOS</code> by default has SELinux enabled in permissive mode. If you are building parts of cOS or cOS itself from scratch, you might encounter issues while building the SELinux module, like so:</p><pre><code>Step 12/13 : RUN checkmodule -M -m -o cOS.mod cOS.te &amp;&amp; semodule_package -o cOS.pp -m cOS.mod
  ---&gt; Using cache
 ---&gt; 1be520969ead
Step 13/13 : RUN semodule -i cOS.pp
  ---&gt; Running in c5bfa5ae92e2
 libsemanage.semanage_commit_sandbox: Error while renaming /var/lib/selinux/targeted/active to /var/lib/selinux/targeted/previous. (Invalid cross-device link).
semodule:  Failed!
 The command '/bin/sh -c semodule -i cOS.pp' returned a non-zero code: 1
 Error: while resolving join images: failed building join image: Failed compiling system/selinux-policies-0.0.6+3: failed building package image: Could not push image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Could not build image: raccos/sampleos:ffc8618ecbfbffc11cc3bca301cc49867eb7dccb623f951dd92caa10ced29b68 selinux-policies-system-0.0.6+3.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>The issue is possibly caused by <a href=https://github.com/docker/for-linux/issues/480>https://github.com/docker/for-linux/issues/480</a> . A workaround is to switch the storage driver of Docker. Check if your storage driver is overlay2, and switch it to <code>devicemapper</code></p><h3 id=multi-stage-copy-build-fails>Multi-stage copy build fails</h3><p>While processing images with several stage copy, you could face the following:</p><pre><code> 🐋  Building image raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d done
 📦  8/8 system/cos-0.5.3+1 ⤑ 🔨  build system/selinux-policies-0.0.6+3 ✅  Done
 🚀  All dependencies are satisfied, building package requested by the user system/cos-0.5.3+1
 📦  system/cos-0.5.3+1  Using image:  raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
 📦  system/cos-0.5.3+1 🐋  Generating 'builder' image from raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d as raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed with prelude steps
🚧  warning Failed to download 'raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed'. Will keep going and build the image unless you use --fatal
🚧  warning Failed pulling image: Error response from daemon: manifest for raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed not found: manifest unknown: manifest unknown
: exit status 1
 🐋  Building image raccos/sampleos:builder-8533d659df2505a518860bd010b7a8ed
 Sending build context to Docker daemon  9.728kB
 Step 1/10 : FROM raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d
  ---&gt; f1122e79b17e
Step 2/10 : COPY . /luetbuild
  ---&gt; 4ff3e202951b
 Step 3/10 : WORKDIR /luetbuild
  ---&gt; Running in 7ec571b96c6f
 Removing intermediate container 7ec571b96c6f
  ---&gt; 9e05366f830a
Step 4/10 : ENV PACKAGE_NAME=cos
  ---&gt; Running in 30297dbd21a3
 Removing intermediate container 30297dbd21a3
  ---&gt; 4c4838b629f4
 Step 5/10 : ENV PACKAGE_VERSION=0.5.3+1
  ---&gt; Running in 36361b617252
 Removing intermediate container 36361b617252
  ---&gt; 6ac0d3a2ff9a
Step 6/10 : ENV PACKAGE_CATEGORY=system
  ---&gt; Running in f20c2cf3cf34
 Removing intermediate container f20c2cf3cf34
  ---&gt; a902ff95d273
 Step 7/10 : COPY --from=quay.io/costoolkit/build-cache:f3a333095d9915dc17d7f0f5629a638a7571a01dcf84886b48c7b2e5289a668a /usr/bin/yip /usr/bin/yip
  ---&gt; 42fa00d9c990
 Step 8/10 : COPY --from=quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1 /usr/bin/luet /usr/bin/luet
 e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1: Pulling from costoolkit/build-cache
 3599716b36e7:  Already exists
 24a39c0e5d06: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 378615c429f5: Already exists
 c28da22d3dfd:  Already exists
 ddb4dd5c81b0: Already exists
 92db41c0c9ab: Already exists
 4f4fb700ef54: Already exists
 6e0ca71a6514: Already exists
 47debb886c7d: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 4f4fb700ef54: Already exists
 d0c9d0f8ddb6: Already exists
 e5a48f1f72ad:  Pulling fs layer
 4f4fb700ef54:  Pulling fs layer
 7d603b2e4a37:  Pulling fs layer
 64c4d787e344:  Pulling fs layer
 f8835d2e60d1:  Pulling fs layer
 64c4d787e344:  Waiting
 f8835d2e60d1:  Waiting
 e5a48f1f72ad:  Download complete
 e5a48f1f72ad:  Pull complete
 4f4fb700ef54:  Verifying Checksum
 4f4fb700ef54:  Download complete
 4f4fb700ef54:  Pull complete
 7d603b2e4a37: Verifying Checksum
7d603b2e4a37: Download complete
 64c4d787e344: Verifying Checksum
64c4d787e344: Download complete
 7d603b2e4a37: Pull complete
 64c4d787e344: Pull complete
 f8835d2e60d1:  Verifying Checksum
 f8835d2e60d1:  Download complete
 f8835d2e60d1: Pull complete
 Digest: sha256:9b58bed47ff53f2d6cc517a21449cae686db387d171099a4a3145c8a47e6a1e0
 Status: Downloaded newer image for quay.io/costoolkit/build-cache:e3bbe48c6d57b93599e592c5540ee4ca7916158461773916ce71ef72f30abdd1
 failed to export image: failed to create image: failed to get layer sha256:118537d8997a08750ab1ac3d8e8575e40fe60e8337e02633b0d8a1287117fe78: layer does not exist
 Error: while resolving join images: failed building join image: failed building package image: Could not push image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Could not build image: raccos/sampleos:cc0aee4ff6c194f920a945c45ebcb487c3e22c5ab40e2634ea70c064dfab206d cos-system-0.5.3+1-builder.dockerfile: Failed running command: : exit status 1
 Bailing out
make: *** [Makefile:45: build] Error 1
</code></pre><p>There is a issue open <a href=https://github.com/moby/moby/issues/37965>upstream</a> about it. A workaround is to enable Docker buildkit with <code>DOCKER_BUILDKIT=1</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-64cdd9f4dae5e1e36b28a390789e7b34>6.4 - Runtime layout</h1><div class=lead>Runtime layout of a booted cOS derivative</div><p>This section describes the runtime layout of a derivative (or a cOS Vanilla image) once booted in a system.</p><p>The cOS toolkit performs during installation a common setup which is equivalent across all derivatives.</p><p>This mechanism ensures that a layout:</p><ul><li>it&rsquo;s simple and human friendly</li><li>allows to switch easily derivatives</li><li>allows to perform recovery tasks</li><li>is resilient to upgrade failures</li></ul><h2 id=layout>Layout</h2><p>The basic setup consists of:</p><ul><li>an <code>A/B</code> partitioning style. We have an &lsquo;active&rsquo; and a &lsquo;passive&rsquo; system too boot from in case of failures</li><li>a Recovery system which allows to perform emergency tasks in case of failure of the &lsquo;A/B&rsquo; partitions</li><li>a Fallback mechanism that boots the partitions in this sequence: &ldquo;A -> B -> Recovery&rdquo; in case of booting failures</li></ul><p>The upgrade happens in a transition image and take places only after all the necessary steps are completed. An upgrade of the &lsquo;A/B&rsquo; partitions can be done by booting into them and running <code>elemental upgrade</code>. This will create a new pristine image that will be selected as active for the next reboot, the old one will be flagged as passive. If we are performing the same from the passive system, only the active is subject to changes.</p><p>Similarly, a recovery system can be upgraded as well by running <code>elemental upgrade --recovery</code>. This will upgrade the recovery system instead of the active/passive. Note both commands needs to be run inside the active or passive system.</p><h2 id=partitions>Partitions</h2><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vSP-Pz9l9hwYDeIlej7qXzzcMzGYBiKjyFpiYYKlbNR3H37n_R_c0eBNeYa3msouOupmDim3ZYYBSxS/pub?w=812&h=646" alt></p><p>The default partitioning is created during installation and is expected to be present in a booted cOS system:</p><ul><li>a <code>COS_STATE</code> partition that will contain our active, passive and recovery images. The images are located under the <code>/cOS</code> directory</li><li>a <code>COS_PERSISTENT</code> partition which contains the persistent user data. This directory is mounted over <code>/usr/local</code> during runtime</li><li>a <code>COS_OEM</code> partition which contains the cloud-init oem files, which is mounted over <code>/oem</code> during runtime</li><li>a <code>COS_RECOVERY</code> partition which contains the recovery system image</li></ul><p>The <code>COS_STATE</code> partitions contains the <code>active</code>, <code>passive</code> . While the <code>active</code> and <code>passive</code> are <code>.img</code> files which are loopback mounted, the <code>recovery</code> system is in <code>COS_RECOVERY</code> and can also be a <code>squashfs</code> file (provided in <code>/cOS/recovery.squashfs</code>). This ensures the immutability aspect and ease out building derivative in constrained environments (e.g. when we have restricted permissions and we can&rsquo;t mount).</p><p>For more information about the immutability aspect of cOS, see <a href=../immutable_rootfs>Immutable rootfs</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cf896bdd96bc95a1c5079a49e2dd0b00>6.5 - Immutable Root Filesystem</h1><div class=lead>Immutable root filesystem configuration parameters</div><p>The immutable rootfs concept in cOS is provided by a dracut module which is
basically the contents of the <a href=../../reference/packages/system-immutable-rootfs>immutable-rootfs</a> package provided as part
of the cOS repository tree.</p><p>By default, <code>cos</code> and derivatives will inherit an immutable setup.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vR-I5ZwwB5EjpsymUfcNADRTTKXrNMnlZHgD8RjDpzYhyYiz_JrWJwvpcfMcwfYet1oWCZVWH22aj1k/pub?w=533&h=443" alt="Partitioning layout"></p><p>A running system will look like as follows:</p><pre><code>/usr/local - persistent (COS_PERSISTENT)
/oem - persistent (COS_OEM)
/etc - ephemeral
/usr - read only
/ immutable
</code></pre><p>This means that any changes that are not specified as cloud-init configuration are not persisting across reboots.</p><p>You can place persisting cloud-init files either in <code>/oem</code> or <code>/usr/local/oem</code>, <code>cOS</code> already supports cloud-init <a href=https://cloudinit.readthedocs.io/en/latest/topics/datasources.html>datasources</a>, so you can use also load cloud-init configuration as standard userdata, depending on the platform. For more details on the cloud-init syntax, see the <a href=../reference/cloud_init>cloud-init configuration reference</a>.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>You can check the package <a href=../../reference/packages/system-immutable-rootfs>documentation reference</a> for a detailed explaination of the configuration and how to override default settings. Immutability, as of other aspects, can be disabled.</div></div><div class=td-content style=page-break-before:always><h1 id=pg-071ba6d3efabf269c535d8df6613a33c>6.6 - Package reference documentation</h1><div class=lead>This section contains documentation for core packages present in the cOS toolkit repositories</div><p>There are a set of core packages available in the cOS repositories which are installable with <code>luet</code> while creating a derivative in the Dockerfile. Those bring in new features, enhancements and core features of the cOS toolkit. Some are optional (like runtime features) while some of them are strictly necessary in order for a cOS system to boot and operate correctly.</p><p>This section contains reference documentation specific to core packages in the cOS repositories and the functionalities they bring.</p><p>All the packages available can also be browsed <a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/>here</a>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f88126e2014aaca7f42ad5e31b8a017a>6.6.1 - GRUB</h1><div class=lead>Packages collection that contains GRUB configuration and artifacts</div><p>This collection contains GRUB2 configurations and related installation artifacts.</p><ul><li><code>system/grub2-efi-image</code> ships a generic efi image for the repository platform</li><li><code>system/grub2-artifacts</code> ships grub files which typically are installed into the GRUB partition</li><li><code>ststem/grub2-config</code> ships default cOS GRUB configuration file</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-38a488e2fb8d5af933f04fa04ae06c0f>6.6.2 - Meta packages</h1><div class=lead>Meta packages are collection of packages, like bundles, which installs a collection of sub-packages</div><p>In the <code>cOS</code> repository are present meta packages that are collection of packages which are suitable for different needs.</p><p>We can compare them to <code>bundles</code> which pulls in during installation sub-packages which should be installed in the system target.</p><p>For example, we have <code>cos-minimal</code> and <code>cos-core</code>: <code>cos-core</code> is the minimum required of packages in order for having a working <code>cOS</code> derivative, while <code>cos-minimal</code> have additional <code>cloud-init</code> configurations that allows a system in order to boot properly.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2ee14c4414706eb4e3550293ae147e56>6.6.2.1 - meta/cos-core</h1><div class=lead>Documentation for the meta/cos-core package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-core class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-core</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y meta/cos-core
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div><code>cos-core</code> is a meta collection which pulls the <code>toolchain</code> (<code>elemental-cli</code> and <code>luet</code>) and the <code>cos</code> modules (<code>installer</code>,<code>cos-setup</code>, <code>immutable-rootfs</code>, <code>base-dracut-modules</code> and <code>grub2-config</code>).</p><p>A <code>meta/cos-core-fips</code> variant is available to pull the toolchain compiled with fips enabled.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-20f0dfa30c6acbc13f3bda70a14963b6>6.6.2.2 - meta/cos-minimal</h1><div class=lead>Documentation for the meta/cos-minimal package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-minimal class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-minimal</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y meta/cos-minimal
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This meta collection includes the <code>cos-core</code> collection and additionally a set of default <code>cloud-config</code> files installed in <code>/system/oem</code>. The cloud-config files are setting defaults for upgrades, system user and password, default network setup and the immutability layer.</p><p>A <code>meta/cos-minimal-fips</code> variant is available to pull the toolchain compiled with fips enabled.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-936dc212b34efd945dfb5c1c8055923d>6.6.2.3 - meta/cos-modules</h1><div class=lead>Documentation for the meta/cos-modules package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-modules class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-modules</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y meta/cos-modules
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>The <code>cos</code> modules pulls the following packages:</p><ul><li><code>installer</code> (which ships <code>cos-installer</code>, <code>cos-upgrade</code>, <code>cos-reset</code> etc. )</li><li><code>cos-setup</code> (which ships the system config services for systemctl)</li><li><code>immutable-rootfs</code> (dracut modules)</li><li><code>base-dracut-modules</code> and <code>grub2-config</code> (dracut and grub2 configuration)</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-cd398c4a96ce6315b3ed8413b9677a10>6.6.2.4 - meta/cos-verify</h1><div class=lead>Documentation for the meta/cos-verify package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/cos-verify class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/cos-verify</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y meta/cos-verify
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>The <code>cos-verify</code> meta package pulls <code>cosign</code> and the <code>luet-cosign</code> plugin to enable container image signature verification.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2d0403630e1a722c86e82297c9ab7b8b>6.6.2.5 - meta/toolchain</h1><div class=lead>Documentation for the meta/toolchain package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/meta/toolchain class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> meta/toolchain</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y meta/toolchain
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>A meta package for <code>luet</code> and <code>elemental-cli</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-814d9b5826621eca5843f5b6b91b4244>6.6.3 - system/cos-wrapper</h1><div class=lead>Documentation for the system/cos-wrapper package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/cos-wrapper class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/cos-wrapper</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y system/cos-wrapper
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This package provides the following wrappers around <code>cos-*</code> binaries to facilitate transitioning to the elemental cli:</p><ul><li><code>cos-installer</code> ( wrapper of <code>elemental install</code> )</li><li><code>cos-deploy</code> ( wrapper of <code>elemental reset</code> )</li><li><code>cos-reset</code> ( wrapper of <code>elemental reset</code> )</li><li><code>cos-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li><li><code>suc-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-0e1e2a51c8326695b76478a4bbcb1f0f>6.6.4 - system/dracut-initrd</h1><div class=lead>Documentation for the system/dracut-initrd package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/dracut-initrd class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/dracut-initrd</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y system/dracut-initrd
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This package provides an initrd generated by dracut which should be suitable for generic machines.</p><p>In cases where Derivative wish to re-use the same initrd and kernel from <code>cOS</code> vanilla images, this package can be used in conjuction with <code>system/kernel</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b1dbc1c48316ba68af1f8b953282ae48>6.6.5 - system/immutable-rootfs</h1><div class=lead>Documentation for the system/immutable-rootfs package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/immutable-rootfs class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/immutable-rootfs</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y system/immutable-rootfs
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This package ships the <code>immutable-rootfs</code> dracut module responsible of mounting the root tree during
boot time with the immutable specific setup. The immutability concept refers
to read only root (<code>/</code>) system. To ensure the linux OS is still functional
certain paths or areas are required to be writable, in those cases an
ephemeral overaly tmpfs is set in place. Additionaly, the immutable rootfs
module can also mount a custom list of device blocks with read write
permissions, those are mostly devoted to store persistent data.</p><p>The dracut module is mostly configured via kernel command line parameters or
via the <code>/run/cos/cos-layout.env</code> environment file.</p><p>These are the read write paths the module mounts as part of the overlay
ephemeral tmpfs: <code>/etc</code>, <code>/root</code>, <code>/home</code>, <code>/opt</code>, <code>/srv</code>, <code>/usr/local</code>
and <code>/var</code>.</p><p>These paths will be all ephemeral unless there is a block device configured
to be mounted in the same path.</p><p>It is important to remark all the immutable root configuration is applied
in initrd before switching root and after <code>rootfs</code> cloud-init stage but
before <code>initramfs</code> stage. So immutable rootfs configuration via cloud-init
using the <code>/run/cos/cos-layout.env</code> file is only effective if called in any
of the <code>rootfs.before</code>, <code>rootfs</code> or <code>rootfs.after</code> cloud-init stages.</p><h2 id=kernel-configuraton-paramters>Kernel configuraton paramters</h2><p>The immutable rootfs can be configured witht he following kernel parameters:</p><ul><li><p><code>cos-img/filename=&lt;imgfile></code>: This is one of the main parameters, it defines
the location of the image file to boot from.</p></li><li><p><code>rd.cos.overlay=tmpfs:&lt;size></code>: This defines the size of the tmpfs used for
the ephemeral overlayfs. It can be expressed in MiB or as a % of the available
memory. Defaults to <code>rd.cos.overlay=tmpfs:20%</code> if not present.</p></li><li><p><code>rd.cos.overlay=LABEL=&lt;vol_label></code>: Optionally and mostly for debugging
purposes the overlayfs can be mounted on top of a persistent block device.
Block devices can be expressed by LABEL (<code>LABEL=&lt;blk_label></code>) or by UUID
(<code>UUID=&lt;blk_uuid></code>)</p></li><li><p><code>rd.cos.mount=LABEL:&lt;blk_label>:&lt;mountpoint></code>: This option defines a
persistent block device and its mountpoint. Block devices can also be
defined by UUID (<code>UUID=&lt;blk_uuid>:&lt;mountpoint></code>). This option can be passed
multiple times.</p></li><li><p><code>rd.cos.oemtimeout=&lt;seconds></code>: cOS by default assumes the existence of a
persistent block device labelled <code>COS_OEM</code> which is used to keep some
configuration data (mostly cloud-init files). The immutable rootfs tries
to mount this device at very early stages of the boot even before applying
the immutable rootfs configs. It done this way to enable to configure the
immutable rootfs module within the cloud-init files. As the <code>COS_OEM</code> device
might not be always present the boot process just continues without failing
after a certain timeout. This option configures such a timeout. Defaults to
10s.</p></li><li><p><code>rd.cos.debugrw</code>: This is a boolean option, true if present, false if not.
This option sets the root image to be mounted as a writable device. Note this
completely breaks the concept of an immutable root. This is helpful for
debugging or testing purposes, so changes persist across reboots.</p></li><li><p><code>rd.cos.disable</code>: This is a boolean option, true if present, false if not.
It disables the execution of any immutable rootfs module logic at boot.</p></li></ul><h3 id=configuration-with-an-environment-file>Configuration with an environment file</h3><p>The immutable rootfs can be configured with the <code>/run/cos/cos-layout.env</code>
environment file. It is important to note that all the immutable root
configuration is applied in initrd before switching root and after
<code>rootfs</code> cloud-init stage but before <code>initramfs</code> stage. So immutable rootfs
configuration via cloud-init using the <code>/run/cos/cos-layout.env</code> file is
only effective if called in any of the <code>rootfs.before</code>, <code>rootfs</code> or
<code>rootfs.after</code> cloud-init stages.</p><p>In the environment file few options are available:</p><ul><li><p><code>VOLUMES=LABEL=&lt;blk_label>:&lt;mountpoint></code>: This variable expects a block device
and it mountpoint pair space separated list. The default cOS configuration is:</p><p><code>VOLUMES="LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local"</code></p></li><li><p><code>OVERLAY</code>: It defines the underlaying device for the overlayfs as in
<code>rd.cos.overlay=</code> kernel parameter.</p></li><li><p><code>DEBUGRW=true</code>: Sets the root (<code>/</code>) to be mounted with read/write permissions.</p></li><li><p><code>MERGE=true</code>: Sets makes the <code>VOLUMES</code> values to be merged with any other
volume that might have been defined in the kernel command line. The merging
criteria is simple: any overlapping volume is overwritten all others are
appended to whatever was already defined as a kernel parameter. If not
defined defaults to <code>true</code>.</p></li><li><p><code>RW_PATHS</code>: This is a space separated list of paths. These are the paths
that will be used for the ephemeral overlayfs. These are the paths that
will be mounted as overlay on top of the <code>OVERLAY</code> (or <code>rd.cos.overlay</code>)
device. Default value is:</p><p><code>RW_PATHS="/etc /root /home /opt /srv /usr/local /var"</code>
<strong>Note</strong>: as those paths are overlayed with an ephemeral mount (<code>tmpfs</code>),
additional data wrote on those location won&rsquo;t be available on subsequent boots.</p></li><li><p><code>PERSISTENT_STATE_TARGET</code>: This is the folder where the persistent state data
will be stored, if any. Default value is <code>/usr/local/.state</code>.</p></li><li><p><code>PERSISTENT_STATE_PATHS</code>: This is a space separated list of paths. These are
the paths that will become writable and store its data inside
<code>PERSISTENT_STATE_TARGET</code>. By default this variable is empty, which means
no persistent state area is created or used.</p><p><strong>Note</strong>: The specified paths needs either to exist or be located in an area
which is writeable ( for example, inside locations specified with <code>RW_PATHS</code>).
The dracut module will attempt to create non-existant directories,
but might fail if the mountpoint where are located is read-only.</p></li><li><p><code>PERSISTENT_STATE_BIND="true|false"</code>: When this variable is set to true
the persistent state paths are bind mounted (instead of using overlayfs)
after being mirrored with the original content. By default this variable is
set to <code>false</code>.</p></li></ul><p>Note that persistent state are is setup once the ephemeral paths and persistent
volumes are mounted. Persistent state paths can&rsquo;t be an already existing mount
point. If the persistent state requires any of the paths that are part of the
ephemeral area by default, then <code>RW_PATHS</code> needs to be defined to avoid
overlapping paths.</p><p>For exmaple a common cOS configuration can be expressed as part of the
cloud-init configuration as follows:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>example</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rootfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;Layout configuration&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/run/cos/cos-layout.env</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>VOLUMES</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;LABEL=COS_OEM:/oem LABEL=COS_PERSISTENT:/usr/local&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>OVERLAY</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;tmpfs:25%&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-963179f6f5bbd1cd10ee6ac9f8a021f8>6.6.6 - utils/installer</h1><div class=lead>Documentation for the utils/installer package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/utils/installer class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> utils/installer</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y utils/installer
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This package provides the following utilities:</p><ul><li><code>cos-installer</code> ( wrapper of <code>cos --install</code> )</li><li><code>cos-deploy</code> ( wrapper of <code>elemental install</code> )</li><li><code>cos-reset</code> ( wrapper of <code>elemental reset</code> )</li><li><code>cos-rebrand</code> ( wrapper of <code>cos --rebrand</code> )</li><li><code>cos-upgrade</code> ( wrapper of <code>elemental upgrade</code> )</li><li><code>suc-upgrade</code> ( wrapper of <code>cos --upgrade</code> )</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b776ece418034168ac1443ec311f82df>6.6.7 - system/kernel</h1><div class=lead>Documentation for the system/kernel package</div><p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4><p><a href=https://rancher-sandbox.github.io/cos-toolkit-package-browser/find/system/kernel class="btn btn-sm position-relative rounded-pill bg-light text-dark" role=button><i class="fa fa-box"></i> system/kernel</a>
is part of the cOS toolkit repository and can be installed with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet install -y system/kernel
</code></pre></div><p>in the derivative&rsquo;s Dockerfile.</p></div>This package provides the default distribution kernel which should be suitable for generic machines.</p><p>In cases where Derivative wish to re-use the same initrd and kernel from <code>cOS</code> vanilla images, this package can be used in conjuction with <code>system/dracut-initrd</code>.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-96caa056902ceb82a4f9a52e36852e8c>6.7 - Troubleshooting</h1><div class=lead>Stuff can go wrong. This document tries to make them right with some useful tips</div><div class="pageinfo pageinfo-warning"><p>Section under construction.</p></div><p>While building a derivative, or on a running system things can go really wrong, the guide is aimed to give tips while building derivatives and also debugging running systems.</p><p>Don&rsquo;t forget tocheck the known issues for the <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues>release you&rsquo;re using</a>.</p><p>Before booting, <a href=../immutable_rootfs>several kernel parameters</a> can be used to help during debugging (also when booting an ISO). Those are meant to be used only while debugging, and they might defeat the concept of immutability.</p><h2 id=disable-immutability>Disable Immutability</h2><p>By adding <code>rd.cos.debugrw</code> to the boot parameters read only mode will be disabled. See <a href=../immutable_rootfs>Immutable setup</a> for more options.</p><p>The derivative will boot into RW mode, that means any change made during runtime will persist across reboots. Use this feature with caution as defeats the concept of immutability.</p><p><code>rd.cos.debugrw</code> applies only to active and passive partitions. The recovery image can&rsquo;t be mutated.</p><div class="alert alert-primary" role=alert><h4 class=alert-heading>Note</h4>The changes made will persist during reboots but won&rsquo;t persist across upgrades. If you need to persist changes across upgrades in runtime (for example by adding additional packages on top of the derivative image), see <a href=../../customizing/runtime_persistent_changes>how to apply persistent changes</a>.</div><h2 id=debug-initramfs-issues>Debug initramfs issues</h2><p>As derivative can ship and build their own initrd, the <a href=https://fedoraproject.org/wiki/How_to_debug_Dracut_problems>official debug docs</a> contains valid information that can be used for troubleshooting.</p><p>For example:</p><ul><li><code>rd.break=pre-mount rd.shell</code>: Drop a shell before setting up mount points</li><li><code>rd.break=pre-pivot rd.shell</code>: Drop a shell before switch-root</li></ul><h2 id=recovery-partition>Recovery partition</h2><p>If you can boot into the system, the recovery partition can be used to reset the state of the active/passive, but can also be used to upgrade to specific images. Be sure to read the <a href=../../getting-started/recovery>Recovery section in the docs</a>.</p><h2 id=mutating-derivative-images>Mutating derivative images</h2><p>It can be useful to mutate derivative images and commit a container’s file changes or settings into a new image.
This allows you to debug a container by running an interactive shell, and re-use the mutated image in cOS systems. Generally, it is better to use Dockerfiles to manage your images in a documented and maintainable way. <a href=../../creating-derivatives/creating_bootable_images>Read more about creating bootable images</a>.</p><p>Let&rsquo;s suppose we have the derivative original image at <code>$IMAGE</code> and we want to mutate it. We will push it later with another name <code>$NEW_IMAGE</code> and use it to our node downstream.</p><p>Run the derivative image locally, and perform any necessary change (e.g. add additional software):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker run --entrypoint /bin/bash -ti --name updated-image <span style=color:#000>$IMAGE</span>
</code></pre></div><p>Commit any changes to a new image <code>$NEW_IMAGE</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker commit updated-image <span style=color:#000>$NEW_IMAGE</span>
</code></pre></div><p>And push the image to the container registry:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker push <span style=color:#000>$NEW_IMAGE</span>
</code></pre></div><p>In the derivative then it&rsquo;s sufficient to upgrade to that image with <code>elemental upgrade</code>:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; elemental upgrade --no-verify --docker-image <span style=color:#000>$NEW_IMAGE</span>
</code></pre></div><h2 id=adding-login-keys-at-boot>Adding login keys at boot</h2><p>To add users key from the GRUB menu prompt, edit the boot cmdline and add the following kernel parameters:</p><p><code>stages.boot[0].authorized_keys.root[0]=github:mudler</code></p></div><div class=td-content style=page-break-before:always><h1 id=pg-52dc75d922e47809f6e4b3a9ac43e7a8>6.8 - High level architecture</h1><div class=lead>High level architecture of cOS and its components.</div><h1 id=cos-toolkit-high-level-architecture>cOS toolkit High level Architecture</h1><p>This page tries to encompass the <a href=https://github.com/rancher-sandbox/cOS-toolkit><code>cos-toolkit</code></a> structure and the high level architecture, along with all the involved components.</p><h2 id=design-goals>Design goals</h2><ul><li>Blueprints to build immutable Linux derivatives from container images</li><li>A workflow to maintain, support and deliver custom-OS and upgrades to end systems</li><li>Derivatives have the same “foundation” manifest - easy to customize on top, add packages: <code>systemd</code>, <code>dracut</code> and <code>grub</code> as a foundation stack.</li><li>Upgrades delivered with container registry images ( also workflow with <code>docker run</code> && <code>docker commit</code> supported! )<br>The content of the container image is the system which is booted.</li></ul><h2 id=high-level-overview>High level overview</h2><p>cOS-Toolkit encompasses several components required for building and distributing OS images. <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues/108>This issue</a> summarize the current state, and how we plan to integrate them in a single CLI to improve the user experience.</p><p>cOS-Toolkit is also a manifest, which includes package definitions of how the underlying OS is composed. It forms an abstraction layer, which is then translated to Dockerfiles and built by our CI (optionally) for re-usal. A derivative can be built by parts of the manifest, or reusing it entirely, container images included.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQQJOaISPbMxMYU44UT-M3ou9uGYOrzbXCRXMLPU8m7_ie3ke_08xCsyRLkFZJRB4VnzIeobPciEoQv/pub?w=942&h=532" alt="High level overview"></p><p>The fundamental phases can be summarized in the following steps:</p><ul><li>Build packages from container images (and optionally keep build caches)</li><li>Extract artefacts from containers</li><li>Add metadata(s) and create a repository</li><li>(optionally) publish the repository and the artefacts</li></ul><p>The developer of the derivative applies a customization layer during build, which is an augmentation layer in the same form of <code>cos-toolkit</code> itself.</p><h2 id=distribution>Distribution</h2><p>The OS delivery mechanism is done via container registries. The developer that wants to provide upgrades for the custom OS will push the resulting container images to the container registry. It will then be used by the installed system to pull upgrades from.</p><p><img src="https://docs.google.com/drawings/d/e/2PACX-1vQrTArCYgu-iscf29v1sl1sEn2J81AqBpi9D5xpwGKr9uxR2QywoSqCmsSaJLxRRacoRr0Kq40a7jPF/pub?w=969&h=464" alt></p><h2 id=upgrade-mechanism>Upgrade mechanism</h2><p>There are two different upgrade mechanisms available that can be used from a maintainer perspective: (a) release channels or (b) providing a container image reference ( <code>e.g. my.registry.com/image:tag</code> ) <a href=https://github.com/rancher-sandbox/cOS-toolkit#default-oem>that can be tweaked in the customization phases</a> to achieve the desired effect.</p></div><div class=td-content style=page-break-before:always><h1 id=pg-39f3813de34ce5cae320697c88e2a917>7 - Development</h1><div class=lead>How to build cOS?</div><p>Welcome!</p><p>The cOS (containerized OS) distribution is entirely built over GitHub. You can check the pipelines in the <code>.github</code> folder to see how the process looks like.</p><h2 id=repository-layout>Repository layout</h2><ul><li><code>packages</code>: contain packages definition for luet</li><li><code>values</code>: interpolation files, needed only for multi-arch and flavor-specific build</li><li><code>assets</code>: static files needed by the iso generation process</li><li><code>packer</code>: Packer templates</li><li><code>tests</code>: cOS test suites</li><li><code>manifest.yaml</code>: Is the manifest needed used to generate the ISO and additional packages to build</li></ul><h2 id=forking-and-test-on-your-own>Forking and test on your own</h2><p>By forking the <code>cOS-toolkit</code> repository, you already have the Github Action workflow configured to start building and pushing your own <code>cOS</code> fork.</p><p>The only changes required to keep in mind for pushing images:</p><ul><li>set <code>DOCKER_PASSWORD</code> and <code>DOCKER_USERNAME</code> as Github secrets, which are needed to push the resulting container images from the pipeline.</li><li>Tweak or set the <code>Makefile</code>&rsquo;s <code>REPO_CACHE</code> and <code>FINAL_REPO</code> accordingly. Those are used respectively for an image used for cache, and for the final image reference.</li></ul><p>Those are not required for building - you can disable image push (<code>--push</code>) from the <code>Makefile</code> or just by specifying e.g. <code>BUILD_ARGS=--pull</code> when calling the <code>make</code> targets.</p><h2 id=building-locally>Building locally</h2><p>cOS has a container image which can be used to build cOS locally in order to generate the cOS packages and the cOS iso from your checkout.</p><p>From your git folder:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; docker build -t cos-builder .
$&gt; docker run --privileged<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --rm -v /var/run/docker.sock:/var/run/docker.sock -v <span style=color:#000>$PWD</span>:/cOS cos-builder
</code></pre></div><p>or use the <code>.envrc</code> file:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; <span style=color:#204a87>source</span> .envrc
$&gt; cos-build
</code></pre></div><h3 id=build-all-packages-locally>Build all packages locally</h3><p>Building locally has a <a href=dependencies.md>set of dependencies</a> that
should be satisfied.</p><p>Then you can run</p><pre><code># make build
</code></pre><p>as root</p><p>To clean from previous runs, run <code>make clean</code>.</p><p><em>Note</em>: The makefile uses <a href=dev.md#yq-and-jq><code>yq</code> and <code>jq</code></a> to
retrieve the packages to build from the iso specfile.</p><p>If you don&rsquo;t have <code>jq</code> and <code>yq</code> installed, you must pass by the packages manually with <code>PACKAGES</code> (e.g. <code>PACKAGES="system/cos live/systemd-boot live/boot live/syslinux"</code>).</p><p>You might want to build packages running as <code>root</code> or <code>sudo -E</code> if you intend to preserve file permissions in the resulting packages (mainly for <code>xattrs</code>, and so on).</p><h3 id=build-iso>Build ISO</h3><p>If using SLES or openSUSE, first install the required deps:</p><pre><code># zypper in -y squashfs xorriso dosfstools
</code></pre><p>and then, simply run</p><pre><code># make local-iso
</code></pre><h3 id=testing-iso-changes>Testing ISO changes</h3><p>To test changes against a specific set of packages, you can for example:</p><pre><code># make PACKAGES=&quot;toolchain/yq&quot;  build local-iso
</code></pre><p>root is required because we want to keep permissions on the output packages (not really required for experimenting).</p><h3 id=run-with-qemu>Run with qemu</h3><p>After you have the iso locally, run</p><pre><code>
$&gt; QEMU=qemu-system-x86_64 make run-qemu

</code></pre><p>This will create a disk image at <code>.qemu/drive.img</code> and boot from the ISO.</p><blockquote><p>If the image already exists, it will NOT be overwritten.</p><p>You need to run an explicit <code>make clean_run</code> to wipe the image and
start over.</p></blockquote><h4 id=installing>Installing</h4><p>With a fresh <code>drive.img</code>, <code>make run-qemu</code> will boot from ISO. You can then log in as <code>root</code> with password <code>cos</code> and install cOS on
the disk image with:</p><pre><code># elemental install /dev/sda
</code></pre><h4 id=running>Running</h4><p>After a successful installation of cOS on <code>drive.img</code>, you can boot
the resulting sytem with</p><pre><code>
$&gt; QEMU_ARGS=&quot;-boot c&quot; make run-qemu

</code></pre><h3 id=run-tests>Run tests</h3><p>Requires: Virtualbox or libvirt, vagrant, packer</p><p>We have a test suite which runs over SSH.</p><p>To create the vagrant image:</p><pre><code>
$&gt; PACKER_ARGS=&quot;-var='feature=vagrant' -only virtualbox-iso.cos&quot; make packer

</code></pre><p>To run the tests:</p><pre><code>
$&gt; make test

</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-be969bc49196171414c640b6e5d07e36>7.1 - Creating derivatives</h1><div class=lead>This document summarize references to create derivatives with <code>cos-toolkit</code> by using the <code>luet</code> toolchain.</div><p><code>cos-toolkit</code> is a manifest to share a common abstract layer between derivatives inheriting the same featureset.</p><p><code>cos</code> is a <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#specfiles>Luet tree</a> and derivatives can be expressed as Luet trees as well that inherit part of the compilation specs from <code>cos</code>.</p><p>Those trees are then post-processed and converted to Dockerfiles when building packages, that in turn are used to build docker images and final artefacts.</p><h2 id=high-level-workflow>High level workflow</h2><p>The building workflow can be resumed in the following steps:</p><ul><li>Build packages from container images. This step generates build metadata (<code>luet build</code> / <code>docker build</code> / <code>buildah</code> ..)</li><li>Add repository metadata and create a repository from the build phase (<code>luet create-repo</code>)</li><li>(otherwise, optionally) publish the repository and the artefacts along (<code>luet create-repo --push-images</code>)</li></ul><p>While on the client side, the upgrade workflow is:</p><ul><li><code>luet install</code> (when upgrading from release channels) latest cos on a pristine image file</li><li>or <code>luet util unpack</code> (when upgrading from specific docker images)</li></ul><p><em>Note</em>: The manual build steps are not stable and will likely change until <a href=https://github.com/rancher-sandbox/cOS-toolkit/issues/108>we build a single CLI</a> to encompass the <code>cos-toolkit</code> components, rather use <code>source .envrc && cos-build</code> for the moment being while iterating locally.</p><h2 id=single-image-os>Single image OS</h2><p>Derivatives are composed by a combination of specs to form a final package that is consumed as a single image OS.</p><p>The container image during installation and upgrade, is converted to an image file with a backing ext2 fs.</p><p>Packages in luet have <code>runtime</code> and <code>buildtime</code> specifications into <code>definition.yaml</code> and <code>build.yaml</code> respectively, and in the buildtime we set:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>requires</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;system&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;cos&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;sampleOSService&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;&gt;=0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>This instruct <code>luet</code> to compose a new image from the results of the compilation of the specified packages, without any version constraints, and use it to run any <code>steps</code> and <code>prelude</code> on top of it.</p><p>We are interested in the dependencies final images, and not the containers used to build them, so we enable <code>requires_final_images</code>:</p><pre><code>requires_final_images: true
</code></pre><p>We later run arbitrary steps to tweak the image:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>steps</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>And we instruct luet to compose the final artifact as a <code>squash</code> of the resulting container image, composed of all the files:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>unpack</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>A detailed explaination of all the keywords available <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#keywords>is in the luet docs</a> along with the <a href=https://luet-lab.github.io/docs/docs/concepts/packages/specfile/#building-strategies>supported build strategies</a>.</p><p>We exclude then a bunch of file that we don&rsquo;t want to be in the final package (regexp supported):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>excludes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#000>..</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=templating>Templating</h2><p>The package <code>build</code> definition supports <a href=https://luet-lab.github.io/docs/docs/concepts/packages/templates/>templating</a>, and global interpolation of build files with multiple values files.</p><p>Values file can be specified during build time in luet with the <code>--values</code> flag (also multiple files are allowed) and, if you are familiar with <code>helm</code> it using the same engine under the hood, so all the functions are available as well.</p><p><code>cos-toolkit</code> itself uses <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/values>default values files</a> for every supported distributions.</p><p>Templates uses cases are for: resharing common pieces between flavors, building for different platforms and architectures, &mldr;</p><h2 id=build-iso>Build ISO</h2><p>To build an iso from a local repository (the build process, automatically produces a repository in <code>build</code> in the local checkout):</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>luet-makeiso ./iso.yaml --local build
</code></pre></div><p>Where <code>iso.yaml</code> is the iso specification file, and <code>--local build</code> is an optional argument to use also the local repository in the build process. See also <a href=../../creating-derivatives/build_iso>building ISOs</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8a9a15a61c107bad2b137d10597cb9e8>7.2 - Build Raw images</h1><div class=lead>This section documents the procedure to build cOS raw images which are used to boot into Cloud providers.</div><p>Requirements:</p><ul><li>cOS-toolkit source</li></ul><p>The suggested approach high level view is building cOS packages and generating a RAW image from
them. That would allow us to transform that RAW image in a valid Azure/Google/Amazon Cloud blob that can be transformed into a VM image ready
to be launched.</p><p>This generates a <code>vanilla</code> image that boots into <a href=../../getting-started/recovery>recovery mode</a> and can be used to deploy
whatever image you want to the VM. Then you can snapshot that VM into a VM image ready to deploy with the default cOS
system or your derivative.</p><p>The RAW image can then be used into packer templates to generate custom Images, or used as-is with a userdata to deploy a container image of choice with an input user-data.</p><h2 id=building-the-packages>Building the packages</h2><p>We need to have the packages built locally in order to generate a proper RAW image. Just run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make build
</code></pre></div><p>All the artifacts will be generated under the <code>build</code> directory.</p><h2 id=building-the-raw-image>Building the RAW image</h2><p>The RAW image is just a RAW disk image that contains the recovery, so once launched is ready to be used for installing
whatever cOS or derivative that you want into the VM disks. This allows us to have a barebones base image that can be
used for provisioning whatever cOS you want.</p><p>Building the RAW image is as simple as running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make raw_disk
</code></pre></div><p>This will output a <code>disk.raw</code> file in the current directory which can be run with qemu, see <a href=../../getting-started/booting>booting</a>.</p><h3 id=aws>AWS</h3><p>No other steps are required, the raw disk can be already booted as an AMI image, see <a href=../../getting-started/booting>booting</a>.</p><h3 id=azure>Azure</h3><p>Requirements:</p><ul><li>Azure Cloud access keys with the appropriate roles and permissions</li><li><a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>azure-cli</a></li></ul><h4 id=transform-the-raw-image-into-a-compatible-azure-cloud-blob>Transform the RAW image into a compatible Azure Cloud blob</h4><p>Currently importing images from storage blobs on Azure Cloud have a <a href=https://docs.microsoft.com/en-us/azure/virtual-machines/linux/create-upload-generic>few requirements</a>:</p><ul><li>only fixed VHD format is supported</li><li>VHD disk must have a virtual size aligned to 1 MB</li><li>LVM is not supported</li><li>no swap partition</li></ul><p>We provide a make target that will do this for you:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make azure_disk
</code></pre></div><p>This will create a <code>disk.vhd</code> which is our final artifact</p><h4 id=uploading-to-azure-cloud-storage-and-importing-it-as-an-image>Uploading to Azure Cloud storage and importing it as an image</h4><p>The last step is to upload the blob to Azure Cloud storage and import that blob as a valid image.</p><p>With <a href=https://docs.microsoft.com/en-us/cli/azure/install-azure-cli>azure-cli</a> installed
and its credentials configured, you upload the blob with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az storage copy --source &lt;cos-azure-image&gt; --destination https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;destination-cos-azure-image&gt;
</code></pre></div><p>And import it as an image with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image create --resource-group &lt;resource-group&gt; --source https://&lt;account&gt;.blob.core.windows.net/&lt;container&gt;/&lt;cos-azure-image&gt; --os-type linux --hyper-v-generation v2 --name &lt;image-name&gt;
</code></pre></div><p>Where cos-azure-image is the blob we just uploaded, basically you can use the same value as you set in <code>--destionation</code> for the upload</p><p>Note that we used <code>--os-type linux --hyper-v-generation v2</code> as flags. This indicates that the image will be booted with UEFI
and its required. Otherwise, launching the image will try to boot it in legacy mode, and it will fail.</p><p>Once this is over you will have you cOS (or derivative) vanilla image ready for consumption.
You can see your new image by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>az image show --resource-group &lt;resource-group&gt; --name &lt;image-name&gt;
</code></pre></div><h3 id=google-cloud>Google cloud</h3><p>Requirements:</p><ul><li>Google Cloud access keys with the appropriate roles and permissions</li><li><a href=https://cloud.google.com/storage/docs/gsutil>gsutil</a> and <a href=https://cloud.google.com/sdk>gcloud</a> tools</li></ul><h4 id=transform-the-raw-image-into-a-compatible-google-cloud-blob>Transform the RAW image into a compatible Google Cloud blob</h4><p>Currently importing images from storage blobs on Google Cloud have a <a href=https://cloud.google.com/compute/docs/import/import-existing-image#requirements_for_the_image_file>few requirements</a>:</p><ul><li>blobs have to be tar.gzipped with the flag <code>--format=oldgnu</code></li><li>the disk.raw has to be rounded up to the next Gb ( so no 2.1gb images or 2.4, they need to be an exact 3Gb or 2Gb)</li><li>image inside the tar.gzip blob needs to be called disk.raw</li></ul><p>We provide a make target that will do this for you:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo make gce_disk
</code></pre></div><p>This will create a <code>disk.raw.tar.gz</code> which is our final artifact</p><h4 id=uploading-to-google-cloud-storage-and-importing-it-as-an-image>Uploading to Google Cloud storage and importing it as an image</h4><p>The last step is to upload the blob to Google Cloud storage and import that blob as a valid image.</p><p>With <a href=https://cloud.google.com/storage/docs/gsutil>gsutil</a> and <a href=https://cloud.google.com/sdk>gcloud</a> tools installed
and their credentials configured, you upload the blob with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gsutil cp disk.raw.tar.gz gs://YOURBUCKET/
</code></pre></div><p>Where YOURBUCKET is the destination bucket you want your file to end up in.</p><p>And import it as an image with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images create IMAGENAME --source-uri<span style=color:#ce5c00;font-weight:700>=</span>SOURCEURI --guest-os-features<span style=color:#ce5c00;font-weight:700>=</span>UEFI_COMPATIBLE
</code></pre></div><p>Where:</p><ul><li>IMAGENAME: The name for the final image</li><li>SOURCEURI: The full Google Cloud Storage URI where the disk image is stored.
This file must be a gzip-compressed tarball whose name ends in
.tar.gz.
This is the full path to the blob we just uploaded.</li></ul><p>Note that we used <code>--guest-os-features=UEFI_COMPATIBLE</code> as a flag. This indicates that the image will be booted with UEFI
and its required. Otherwise, launching the image will try to boot it in legacy mode and it will fail.</p><p>Once this is over you will have you cOS (or derivative) vanilla image ready for consumption.
You can see your new image by running:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>gcloud compute images describe IMAGENAME
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b891fcefc8f5da3d313248bffe32998d>7.3 - Build requirements</h1><div class=lead>Building prerequisites</div><h3 id=installing-required-dependencies-for-local-build>Installing required dependencies for local build</h3><p>To get requirements installed locally, run:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; make deps
</code></pre></div><p>or you need:</p><ul><li><a href=https://github.com/mudler/luet><code>luet</code></a></li><li><a href=https://github.com/mudler/luet-makeiso><code>luet-makeiso</code></a></li><li><a href=https://github.com/plougher/squashfs-tools><code>squashfs-tools</code></a><ul><li><code>zypper in squashfs</code> on SLES or openSUSE</li></ul></li><li><a href=https://dev.lovelyhq.com/libburnia/web/wiki/Xorriso><code>xorriso</code></a><ul><li><code>zypper in xorriso</code> on SLES or openSUSE</li></ul></li><li><code>yq</code> (<a href=https://github.com/mikefarah/yq/releases>version <code>4.x</code></a>), installed via <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/toolchain/yq>packages/toolchain/yq</a> (optional)</li><li><a href=https://stedolan.github.io/jq><code>jq</code></a>, installed via <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/utils/jq>packages/utils/jq</a> (optional)</li></ul><p><em>Note</em>: Running <code>make</code> deps will install only <code>luet</code>, <code>luet-makeiso</code>, <code>yq</code> and <code>jq</code>. <code>squashfs-tools</code> and <code>xorriso</code> needs to be provided by the OS.</p><h3 id=manually-install-dependencies>Manually install dependencies</h3><p>To install luet locally, you can also run as root:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># curl https://raw.githubusercontent.com/rancher-sandbox/cOS-toolkit/master/scripts/get_luet.sh | sh</span>
</code></pre></div><p>or build <a href=https://github.com/mudler/luet>luet from source</a>).</p><p>You can find more luet components in the official <a href=https://github.com/Luet-lab/luet-repo>Luet repository</a>.</p><h4 id=luet-makeiso>luet-makeiso</h4><p><code>luet-makeiso</code> comes <a href=https://github.com/rancher-sandbox/cOS-toolkit/tree/master/packages/toolchain/luet-makeiso>with cOS-toolkit</a>
and can be installed with <code>luet</code> locally:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; luet install -y toolchain/luet-makeiso
</code></pre></div><p>You can also grab the binary from <a href=https://github.com/mudler/luet-makeiso>luet-makeiso</a> releases.</p><h4 id=yq-and-jq>yq and jq</h4><p><code>yq</code> (version <code>4.x</code>) and <code>jq</code> are used to retrieve the list of
packages to build in order to produce the final ISOs. Those are not
strictly required, see the Note below.</p><p>They are installable with:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$&gt; luet install -y utils/jq toolchain/yq
</code></pre></div><p><em>Note</em>: <code>yq</code> and <code>jq</code> are just used to generate the list of packages to build, and you don&rsquo;t need to have them installed if you manually specify the packages to be compiled.</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank rel=noopener href=https://rancher-users.slack.com/messages/cos-toolkit aria-label=Slack><i class="fab fa-slack"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2022 SUSE LLC All Rights Reserved</small>
<small class=ml-1><a href=https://www.suse.com/company/legal/ target=_blank rel=noopener>Privacy Policy</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script><script src=https://rancher-sandbox.github.io/cos-toolkit-docs/js/prism.js></script></body></html>